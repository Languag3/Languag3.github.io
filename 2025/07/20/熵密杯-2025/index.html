<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"languag3.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="也是拿到了第一，可惜后面打的两眼昏花审最后一题代码的时候审差了，或许就可以 ak 了 &#x2F;(ㄒoㄒ)&#x2F;~~">
<meta property="og:type" content="article">
<meta property="og:title" content="熵密杯 2025">
<meta property="og:url" content="https://languag3.github.io/2025/07/20/%E7%86%B5%E5%AF%86%E6%9D%AF-2025/index.html">
<meta property="og:site_name" content="languag3">
<meta property="og:description" content="也是拿到了第一，可惜后面打的两眼昏花审最后一题代码的时候审差了，或许就可以 ak 了 &#x2F;(ㄒoㄒ)&#x2F;~~">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://languag3.github.io/images/img/image-20250720163054224.png">
<meta property="article:published_time" content="2025-07-20T08:26:24.000Z">
<meta property="article:modified_time" content="2025-07-21T12:58:47.199Z">
<meta property="article:author" content="languag3">
<meta property="article:tag" content="ctf">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://languag3.github.io/images/img/image-20250720163054224.png">


<link rel="canonical" href="https://languag3.github.io/2025/07/20/%E7%86%B5%E5%AF%86%E6%9D%AF-2025/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://languag3.github.io/2025/07/20/%E7%86%B5%E5%AF%86%E6%9D%AF-2025/","path":"2025/07/20/熵密杯-2025/","title":"熵密杯 2025"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>熵密杯 2025 | languag3</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">languag3</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">众里寻他千百度。蓦然回首，那人却在，灯火阑珊处。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-link"><a href="/links/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>友链</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E8%B0%9C%E9%A2%98"><span class="nav-number">1.</span> <span class="nav-text"> 初始谜题</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E8%B0%9C%E9%A2%981"><span class="nav-number">1.1.</span> <span class="nav-text"> 初始谜题1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E8%B0%9C%E9%A2%982"><span class="nav-number">1.2.</span> <span class="nav-text"> 初始谜题2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E8%B0%9C%E9%A2%983"><span class="nav-number">1.3.</span> <span class="nav-text"> 初始谜题3</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%86%E7%A0%81%E7%B3%BB%E7%BB%9F"><span class="nav-number">2.</span> <span class="nav-text"> 密码系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-tsp%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%99%BB%E5%BD%95"><span class="nav-number">2.1.</span> <span class="nav-text"> 1-TSP服务器登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-tsp%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%89%B4%E5%88%ABapp%E6%8E%A7%E5%88%B6%E7%AB%AF"><span class="nav-number">2.2.</span> <span class="nav-text"> 2-TSP服务器鉴别APP控制端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%9B%AE%E6%A0%87%E5%9C%B0%E7%82%B9%E7%BB%8F%E7%BA%AC%E5%BA%A6%E5%8A%A0%E5%AF%86"><span class="nav-number">2.3.</span> <span class="nav-text"> 3-目标地点经纬度加密</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-ota%E5%8D%87%E7%BA%A7%E5%8C%85%E5%8A%A0%E5%AF%86"><span class="nav-number">2.4.</span> <span class="nav-text"> 4-OTA升级包加密</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-ota%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8Eota%E5%8D%87%E7%BA%A7%E5%8C%85%E7%AD%BE%E5%90%8D"><span class="nav-number">2.5.</span> <span class="nav-text"> *5-OTA服务器与OTA升级包签名</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="languag3"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">languag3</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">14</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/languag3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;languag3" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1499304232@qq.com" title="E-Mail → mailto:1499304232@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://languag3.github.io/2025/07/20/%E7%86%B5%E5%AF%86%E6%9D%AF-2025/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="languag3">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="languag3">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="熵密杯 2025 | languag3">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          熵密杯 2025
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-07-20 16:26:24" itemprop="dateCreated datePublished" datetime="2025-07-20T16:26:24+08:00">2025-07-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-07-21 20:58:47" itemprop="dateModified" datetime="2025-07-21T20:58:47+08:00">2025-07-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>也是拿到了第一，可惜后面打的两眼昏花审最后一题代码的时候审差了，或许就可以 ak 了 /(ㄒoㄒ)/~~</p>
<span id="more"></span> 
<img src="\images\img\image-20250720163054224.png" alt="image-20250720163054224" style="zoom:50%;" />
<p>相比去年和前年，今年的难度是真的高，代码量也多了很多，打的也是两眼昏花。其中打*的是赛中没有出的。</p>
<h1 id="初始谜题"><a class="markdownIt-Anchor" href="#初始谜题"></a> 初始谜题</h1>
<p>总共 3 个初始谜题，只有做了其中一个才可以进入下面的密码系统进行做题。</p>
<h2 id="初始谜题1"><a class="markdownIt-Anchor" href="#初始谜题1"></a> 初始谜题1</h2>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> pyasn1.codec.der.decoder <span class="keyword">import</span> decode</span><br><span class="line"><span class="keyword">from</span> pyasn1.<span class="built_in">type</span> <span class="keyword">import</span> univ, namedtype</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> Cipher, algorithms, modes</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">from</span> gmssl <span class="keyword">import</span> sm3, func, sm2</span><br><span class="line"><span class="keyword">from</span> pyasn1.codec.der.encoder <span class="keyword">import</span> encode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SM2Cipher</span>(univ.<span class="type">Sequence</span>):</span><br><span class="line">    componentType = namedtype.NamedTypes(</span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;xCoordinate&#x27;</span>, univ.Integer()), <span class="comment"># -- x 分量</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;yCoordinate&#x27;</span>, univ.Integer()),             <span class="comment"># -- y 分量</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;hash&#x27;</span>, univ.OctetString()),                <span class="comment"># --哈希值</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;cipherText&#x27;</span>, univ.OctetString())           <span class="comment"># -- SM4密钥密文</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EncryptedData</span>(univ.<span class="type">Sequence</span>):</span><br><span class="line">    componentType = namedtype.NamedTypes(</span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;algorithm&#x27;</span>, univ.ObjectIdentifier(<span class="string">&#x27;1.2.156.10197.1.104.2&#x27;</span>)), <span class="comment"># -- SM4-CBC OID</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;iv&#x27;</span>, univ.OctetString()),                                                <span class="comment"># -- SM4-CBC加密使用的初始化向量（IV）</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;cipherText&#x27;</span>, univ.OctetString())                                         <span class="comment"># -- SM4加密的密文</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EnvelopedData</span>(univ.<span class="type">Sequence</span>):</span><br><span class="line">    componentType = namedtype.NamedTypes(</span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;encryptedKey&#x27;</span>, SM2Cipher()),                           <span class="comment"># -- 使用SM2公钥加密SM4密钥的密文</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;encryptedData&#x27;</span>, EncryptedData()),                                  <span class="comment">#  -- 使用SM4密钥对明文加密的密文</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;digestAlgorithm&#x27;</span>, univ.ObjectIdentifier(<span class="string">&#x27;1.2.156.10197.1.401.1&#x27;</span>)), <span class="comment"># -- SM3算法OID</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;digest&#x27;</span>, univ.OctetString())                                       <span class="comment"># -- 对明文计算的摘要值</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sm4_cbc_encrypt</span>(<span class="params">plaintext: <span class="built_in">bytes</span>, key: <span class="built_in">bytes</span>, iv: <span class="built_in">bytes</span></span>):</span><br><span class="line">    backend = default_backend()</span><br><span class="line">    cipher = Cipher(algorithms.SM4(key), modes.CBC(iv), backend=backend) <span class="comment">#填充模式 nopadding</span></span><br><span class="line">    encryptor = cipher.encryptor()</span><br><span class="line">    ciphertext = encryptor.update(plaintext) + encryptor.finalize()</span><br><span class="line">    <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sm2_encrypt</span>(<span class="params">plaintext: <span class="built_in">bytes</span>,public_key:<span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    sm2_crypt = sm2.CryptSM2(private_key=<span class="string">&quot;&quot;</span>,public_key=public_key.<span class="built_in">hex</span>())</span><br><span class="line">    ciphertext = sm2_crypt.encrypt(plaintext)</span><br><span class="line">    <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sm3_hash</span>(<span class="params">text:<span class="built_in">bytes</span></span>):</span><br><span class="line">    hash_value = sm3.sm3_hash(func.bytes_to_list(text))</span><br><span class="line">    <span class="keyword">return</span> hash_value</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_key_from_file</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            key = file.read().strip()</span><br><span class="line">            <span class="keyword">return</span> key</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 文件 <span class="subst">&#123;file_path&#125;</span> 未找到。&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 发生了未知错误 <span class="subst">&#123;e&#125;</span>。&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对由abcd组成的字符串加密的方法</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sm4_encrypt</span>(<span class="params">plaintext:<span class="built_in">str</span>,sm2_public_key: <span class="built_in">str</span>,sm4_iv:<span class="built_in">str</span></span>):</span><br><span class="line">    sm4_key = <span class="built_in">bytes</span>.fromhex(read_key_from_file(<span class="string">&quot;key.txt&quot;</span>)) <span class="comment">#从文件读取固定的key</span></span><br><span class="line">    <span class="comment"># sm4</span></span><br><span class="line">    envelope = EnvelopedData()</span><br><span class="line">    plaintext_bytes = plaintext.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    ciphertext = sm4_cbc_encrypt(plaintext_bytes,sm4_key,<span class="built_in">bytes</span>.fromhex(sm4_iv))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># sm2</span></span><br><span class="line">    encrypted_key = sm2_encrypt(sm4_key,<span class="built_in">bytes</span>.fromhex(sm2_public_key))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># sm3</span></span><br><span class="line">    digest = sm3_hash(plaintext_bytes)</span><br><span class="line"></span><br><span class="line">    envelope[<span class="string">&#x27;encryptedData&#x27;</span>] = EncryptedData()</span><br><span class="line">    envelope[<span class="string">&#x27;encryptedData&#x27;</span>][<span class="string">&#x27;iv&#x27;</span>] = univ.OctetString(<span class="built_in">bytes</span>.fromhex(sm4_iv))</span><br><span class="line">    envelope[<span class="string">&#x27;encryptedData&#x27;</span>][<span class="string">&#x27;cipherText&#x27;</span>] = univ.OctetString(ciphertext)</span><br><span class="line"></span><br><span class="line">    envelope[<span class="string">&#x27;encryptedKey&#x27;</span>] = SM2Cipher()</span><br><span class="line">    envelope[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;xCoordinate&#x27;</span>] = univ.Integer(<span class="built_in">int</span>.from_bytes(encrypted_key[:<span class="number">32</span>], <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">    envelope[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;yCoordinate&#x27;</span>] = univ.Integer(<span class="built_in">int</span>.from_bytes(encrypted_key[<span class="number">32</span>:<span class="number">64</span>], <span class="string">&#x27;big&#x27;</span>))</span><br><span class="line">    envelope[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;hash&#x27;</span>] = univ.OctetString(encrypted_key[<span class="number">64</span>:<span class="number">96</span>])</span><br><span class="line">    envelope[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;cipherText&#x27;</span>] = univ.OctetString(encrypted_key[<span class="number">96</span>:])</span><br><span class="line"></span><br><span class="line">    envelope[<span class="string">&#x27;digest&#x27;</span>] = univ.OctetString(<span class="built_in">bytes</span>.fromhex(digest))</span><br><span class="line">    <span class="keyword">return</span> encode(envelope).<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从asn1格式的16进制字符串提取参数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">asn1_parse</span>(<span class="params">asn1_hex_str:<span class="built_in">str</span>,asn1_spec</span>):</span><br><span class="line">    <span class="comment"># 将16进制字符串转换为字节</span></span><br><span class="line">    der_bytes = binascii.unhexlify(asn1_hex_str)</span><br><span class="line">    <span class="comment"># 解码为ASN.1对象</span></span><br><span class="line">    enveloped_data, _ = decode(der_bytes, asn1Spec=asn1_spec)</span><br><span class="line">    <span class="comment"># sm2</span></span><br><span class="line">    sm2_x = <span class="built_in">hex</span>(<span class="built_in">int</span>(enveloped_data[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;xCoordinate&#x27;</span>]))[<span class="number">2</span>:]</span><br><span class="line">    sm2_y = <span class="built_in">hex</span>(<span class="built_in">int</span>(enveloped_data[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;yCoordinate&#x27;</span>]))[<span class="number">2</span>:]</span><br><span class="line">    sm2_hash = enveloped_data[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;hash&#x27;</span>].asOctets().<span class="built_in">hex</span>()</span><br><span class="line">    sm2_ciphertext = enveloped_data[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;cipherText&#x27;</span>].asOctets().<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># sm4</span></span><br><span class="line">    sm4_algorithm = <span class="built_in">str</span>(enveloped_data[<span class="string">&#x27;encryptedData&#x27;</span>][<span class="string">&#x27;algorithm&#x27;</span>])</span><br><span class="line">    sm4_iv = enveloped_data[<span class="string">&#x27;encryptedData&#x27;</span>][<span class="string">&#x27;iv&#x27;</span>].asOctets().<span class="built_in">hex</span>()</span><br><span class="line">    sm4_cipherText = enveloped_data[<span class="string">&#x27;encryptedData&#x27;</span>][<span class="string">&#x27;cipherText&#x27;</span>].asOctets().<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># sm3</span></span><br><span class="line">    digestAlgorithm = <span class="built_in">str</span>(enveloped_data[<span class="string">&#x27;digestAlgorithm&#x27;</span>])</span><br><span class="line">    digest = enveloped_data[<span class="string">&#x27;digest&#x27;</span>].asOctets().<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出提取的值</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;asn1格式的16进制字符串:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  asn1: <span class="subst">&#123;asn1_hex_str&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;SM2参数:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  xCoordinate: <span class="subst">&#123;sm2_x&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  yCoordinate: <span class="subst">&#123;sm2_y&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  hash: <span class="subst">&#123;sm2_hash&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  cipherText: <span class="subst">&#123;sm2_ciphertext&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;SM4参数:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  algorithm: <span class="subst">&#123;sm4_algorithm&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  iv: <span class="subst">&#123;sm4_iv&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  cipherText: <span class="subst">&#123;sm4_cipherText&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;SM3参数:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  digestAlgorithm: <span class="subst">&#123;digestAlgorithm&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  digest: <span class="subst">&#123;digest&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    plaintext = <span class="string">&quot;6163616263626161626461646464636361626263626464626361616164636462636462646461646461626462646361636264616364646462646462626261636261646163626463636262616462646462616362616363646463646361616263646261636164636263646163646161636164646364646261626463636462636162636162646261626163636161616463616261646264616162646162626162626462616363616161636362616461626463616462646261626264626464626262636363636162616261626163616164616462626163636164646161646361626363646462626261636261636164646262646362616263636363626461636164646261636361646463616161626164626461636163636461646164616161616163616164636164646261646163626163636164616162636263616461636261646264626263626264636164646263616164626463626461646364616362626261616262616264616361626264636264616461646163626364626462636161636262636163616261616262626362636463616263616364616363626163636363636262646363616464626461616363646361626162636261636364646362626462616364626462626161616264636162626263626462626264646162626462616261616264626161616363636364616263626461636162616462616363616461646363636261636363616162646164626361616464646463646263646363636164626164646463646361636364616261626261646461646463626161616361626161626362626262636164626463636163626163616163636262646463646162616363616364636164646364626464626164626162636161616263646164636461626161636262646463636462646161636462626264626463646364636362626264616362646462636263616361626262616464636263616464616363646163616262616162626261626261616461636361636164636162626461646264636162646363636263616363646161636464626161616462636464646164616361646264616361626263646264616162636164636462616164646163616461646362626464&quot;</span></span><br><span class="line">    sm2_key = <span class="string">&quot;044f66804d1d30f4499377b96dc8e18faab8300ebddf3eb0fa2065214c260d64c08c6dfe7d9923d6d5baa3a0512a2ede03357c723230ebf77906f82dc1b0fccc1e&quot;</span></span><br><span class="line">    iv = <span class="string">&quot;43d4192f9f74e90543d4192f9f74e905&quot;</span></span><br><span class="line">    asn1_hex_str = sm4_encrypt(<span class="built_in">bytes</span>.fromhex(plaintext).decode(<span class="string">&#x27;utf-8&#x27;</span>),sm2_key,iv)</span><br><span class="line">    asn1_parse(asn1_hex_str,EnvelopedData())</span><br></pre></td></tr></table></figure>
<p>题目实现了一个数字信封，利用 SM4-CBC 对消息的进行加密得到密文，然后用 SM2 对 SM4-CBC 的密钥进行加密，并且给出消息的 SM3 哈希值。</p>
<p>挑战目标是给出一个组明密文，然后通过其恢复一段密文（两组明文都是 <code>abcd</code> 的随机组合）。首先它给的密文是 asn1 编码格式，不过无所谓，反正也给我们解 asn1 的代码了。然后再审计代码，你会发现——好像这个数字信封实现的也没啥问题哎。当时是直接懵逼了，那要咋打，总不能直接爆破明文然后对照 hash 吧。不过注意到给出的明密文很长，而要恢复的明文很短，这时候就脑洞打开了一下，把要恢复的密文的第一块用 ctrl f 搜索了一下，结果发现竟然给定的密文有一块和它一样的。那就好办了，因为是 CBC 形式的而且 iv 也给我们了，所以可以快速计算出第一块的消息。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> pyasn1.codec.der.decoder <span class="keyword">import</span> decode</span><br><span class="line"><span class="keyword">from</span> pyasn1.<span class="built_in">type</span> <span class="keyword">import</span> univ, namedtype</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.ciphers <span class="keyword">import</span> Cipher, algorithms, modes</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">from</span> gmssl <span class="keyword">import</span> sm3, func, sm2</span><br><span class="line"><span class="keyword">from</span> pyasn1.codec.der.encoder <span class="keyword">import</span> encode</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SM2Cipher</span>(univ.<span class="type">Sequence</span>):</span><br><span class="line">    componentType = namedtype.NamedTypes(</span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;xCoordinate&#x27;</span>, univ.Integer()), <span class="comment"># -- x 分量</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;yCoordinate&#x27;</span>, univ.Integer()),             <span class="comment"># -- y 分量</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;hash&#x27;</span>, univ.OctetString()),                <span class="comment"># --哈希值</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;cipherText&#x27;</span>, univ.OctetString())           <span class="comment"># -- SM4密钥密文</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EncryptedData</span>(univ.<span class="type">Sequence</span>):</span><br><span class="line">    componentType = namedtype.NamedTypes(</span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;algorithm&#x27;</span>, univ.ObjectIdentifier(<span class="string">&#x27;1.2.156.10197.1.104.2&#x27;</span>)), <span class="comment"># -- SM4-CBC OID</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;iv&#x27;</span>, univ.OctetString()),                                                <span class="comment"># -- SM4-CBC加密使用的初始化向量（IV）</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;cipherText&#x27;</span>, univ.OctetString())                                         <span class="comment"># -- SM4加密的密文</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EnvelopedData</span>(univ.<span class="type">Sequence</span>):</span><br><span class="line">    componentType = namedtype.NamedTypes(</span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;encryptedKey&#x27;</span>, SM2Cipher()),                           <span class="comment"># -- 使用SM2公钥加密SM4密钥的密文</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;encryptedData&#x27;</span>, EncryptedData()),                                  <span class="comment">#  -- 使用SM4密钥对明文加密的密文</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;digestAlgorithm&#x27;</span>, univ.ObjectIdentifier(<span class="string">&#x27;1.2.156.10197.1.401.1&#x27;</span>)), <span class="comment"># -- SM3算法OID</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;digest&#x27;</span>, univ.OctetString())                                       <span class="comment"># -- 对明文计算的摘要值</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从asn1格式的16进制字符串提取参数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">asn1_parse</span>(<span class="params">asn1_hex_str:<span class="built_in">str</span>,asn1_spec</span>):</span><br><span class="line">    <span class="comment"># 将16进制字符串转换为字节</span></span><br><span class="line">    der_bytes = binascii.unhexlify(asn1_hex_str)</span><br><span class="line">    <span class="comment"># 解码为ASN.1对象</span></span><br><span class="line">    enveloped_data, _ = decode(der_bytes, asn1Spec=asn1_spec)</span><br><span class="line">    <span class="comment"># sm2</span></span><br><span class="line">    sm2_x = <span class="built_in">hex</span>(<span class="built_in">int</span>(enveloped_data[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;xCoordinate&#x27;</span>]))[<span class="number">2</span>:]</span><br><span class="line">    sm2_y = <span class="built_in">hex</span>(<span class="built_in">int</span>(enveloped_data[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;yCoordinate&#x27;</span>]))[<span class="number">2</span>:]</span><br><span class="line">    sm2_hash = enveloped_data[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;hash&#x27;</span>].asOctets().<span class="built_in">hex</span>()</span><br><span class="line">    sm2_ciphertext = enveloped_data[<span class="string">&#x27;encryptedKey&#x27;</span>][<span class="string">&#x27;cipherText&#x27;</span>].asOctets().<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># sm4</span></span><br><span class="line">    sm4_algorithm = <span class="built_in">str</span>(enveloped_data[<span class="string">&#x27;encryptedData&#x27;</span>][<span class="string">&#x27;algorithm&#x27;</span>])</span><br><span class="line">    sm4_iv = enveloped_data[<span class="string">&#x27;encryptedData&#x27;</span>][<span class="string">&#x27;iv&#x27;</span>].asOctets().<span class="built_in">hex</span>()</span><br><span class="line">    sm4_cipherText = enveloped_data[<span class="string">&#x27;encryptedData&#x27;</span>][<span class="string">&#x27;cipherText&#x27;</span>].asOctets().<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># sm3</span></span><br><span class="line">    digestAlgorithm = <span class="built_in">str</span>(enveloped_data[<span class="string">&#x27;digestAlgorithm&#x27;</span>])</span><br><span class="line">    digest = enveloped_data[<span class="string">&#x27;digest&#x27;</span>].asOctets().<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出提取的值</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;asn1格式的16进制字符串:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  asn1: <span class="subst">&#123;asn1_hex_str&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;SM2参数:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  xCoordinate: <span class="subst">&#123;sm2_x&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  yCoordinate: <span class="subst">&#123;sm2_y&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  hash: <span class="subst">&#123;sm2_hash&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  cipherText: <span class="subst">&#123;sm2_ciphertext&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;SM4参数:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  algorithm: <span class="subst">&#123;sm4_algorithm&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  iv: <span class="subst">&#123;sm4_iv&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  cipherText: <span class="subst">&#123;sm4_cipherText&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;SM3参数:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  digestAlgorithm: <span class="subst">&#123;digestAlgorithm&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  digest: <span class="subst">&#123;digest&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">m1 = <span class="string">&#x27;6362646264646264646361636463646261636164626362646264616161636162636261616461646263626362626264636163616264626164616161616361616161636163636361626463616361626263626263646462626261616462646362626162646162646461646264626361646264636164626262626264646464626362626462626364646463636362636264616161636461626363626362616263636264636164636261646262626161636161616461616163616461626461646464616363646462636464646464636462636264636464636162616461646263646264636363616263616164646263646362646161616361646261616161626261626462636261646362626362626462636463616164636263646164636461646364646464616461626463616463636362626464646463636461626264636363636263646463626163636362646264616261636464626164646363626164626264616462626264646463646163646162626364616264646163636362646164616263616461626164636261646361636162616162646161646162636364646162626361646362646361626463616262646362636261616464626162636161616362616464616261626363616464626164616362616262616463626364646461636461636164636261626364646362626263636164626161636264646261636264626164626264636463616263646462646464636461626264626262626263626362636463636362636264646262626162626364616363636264626462636163646361636163616464626361616262646361626261646364646461636164626164646361626264616364626361636163626163636363626464626462646364646364616461616161616361646264626364636364626261636363636361616264636262646262616263636361616361616261616162636163646363646264636364616362626362626463616264646261626164646263646164646264616463646462626261616461636461626262636462646163636461646362616363616163616361626162636462616362636361646363626161636362636361616261636362636463&#x27;</span></span><br><span class="line">c1 = <span class="string">&#x27;308203ec30790220467b2389364b2ebd2eadfa624d668c9b0d530b89edbaf9676c1d7db18c7da40502210099f160a4fc540baa3c316e0b28db789f366fc4c84ba1a98e3aaf0806667a82d804204452c9104b87f44ac026d449cb5b5b5f306b2deab5187db7b3cb845659b1714b0410443c9a3f4f7b0083ddd323d6a1f576503082034006082a811ccf550168020410f414bdfbca9d9e902114536a3b9c443204820320d76516cc03294caaa08df866f53ac3ddc8331f5aa82c09d1ae49c41746165293d70f8d2e7578e4a6c59c9a2adb7b446fd7139e6e1d9f4fef7dca09425b574dfd30c24d773c59bcd86384f013439e7b0f61439192f9b7889a72d4fb59d20eaa7dc7191594aa5cdb855410f0b6be69cb5eb5f303a605300d48c8ca0b86549ba2c586009fa7a24e4b71a2c304aa34f9a6cb45d1e5d97e6d768dd63a1bfbe7a975be13585742aed7e3e606450530c05c0cd1c41dea44603f628bc2398cdd706abb66ca964178122b99c879bf1ded48268f662cbb1d06798e19ecb61c5719fd85b4bf72b25226778632e4510009f101a50fc66ef8f12088357ccac4749262f2eb07b6ea6d800ed3897a02d530b0e6f22b378354edddd8bf4a8df07d020986c1f49570853f4875e00fac96b2f8054288ebebb4d86ebfb644f53b1195fc2ff04effe18d419da605ba949ff7a3cc3624fdb71af173a8b8e0c721ff0095f1cfb08d1f236835013811502da499408de1ed0d329027d65b62790043f0b2f67a71f2056ca1c2e431147b145d8817b86a49d08e82c5d710e999078fa8bc1144bb77654a53d91591522540f3ac835ad1df444f94db2c07f223be6db215034ef39c2123690d0457877c40ea91f5662f2efb57cefa4d8b3bb6ce18bed2de4de3c8d53c9bd2f0be84471a88719f74a3e2193915db3c455c597e897ada24e6c3e628e03416a759ed1a7886525569a2b7e7431311504e27add6b43d85e704d364fe6446c29c314e95c498fea6b8123d811480a1add915a34d4ffeda304e0ee8456f842786a385eaac42c0beec3b37d30906a982340a1a9a0151eca11040fd2c467a8a014e2db9ccec96f0d927208de545fddd0cae8b7da3ce113d0ac95fb84ec74ed266ae8676ac662f21bb93034064a043e5969c378e825b3751d6c54e9d8d79a905c942857103564ce7ed5c61c899420d02170f42e41e3193cd5de116701c59043fc42ec596fc8cd05c75ed9fd514c9323ce01143b84080cc2d81ac477c7c2a9ef97ea0b76159fc2ea24e18c8511046f4e500d1653b16b71f0a1028155173a11c55e777dd13c23e67f9fa5e6a8c32162dcf01b09a3c50c106c63d13ce2a9e2fff014665ec490f947706092a811ccf5501831101042024d458eef08943e27b496fd180de68c18f467bee9d3c802bb56d607a364ddc70&#x27;</span></span><br><span class="line">c = <span class="string">&#x27;3081e830790220467b2389364b2ebd2eadfa624d668c9b0d530b89edbaf9676c1d7db18c7da40502210099f160a4fc540baa3c316e0b28db789f366fc4c84ba1a98e3aaf0806667a82d804204452c9104b87f44ac026d449cb5b5b5f306b2deab5187db7b3cb845659b1714b0410443c9a3f4f7b0083ddd323d6a1f57650303e06082a811ccf550168020410b63a85e103d362fb6247c19e324e97c4042098fea6b8123d811480a1add915a34d4fdbbfd86515a457e1b20bf4751ea0010706092a811ccf55018311010420aab05fca300811223b3b957bfe33130770fb7a6b55b030a5809c559344f66f79&#x27;</span></span><br><span class="line"><span class="comment"># print(asn1_parse(c, EnvelopedData()))</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">asn1格式的16进制字符串:</span></span><br><span class="line"><span class="string">  asn1: 308203ec30790220467b2389364b2ebd2eadfa624d668c9b0d530b89edbaf9676c1d7db18c7da40502210099f160a4fc540baa3c316e0b28db789f366fc4c84ba1a98e3aaf0806667a82d804204452c9104b87f44ac026d449cb5b5b5f306b2deab5187db7b3cb845659b1714b0410443c9a3f4f7b0083ddd323d6a1f576503082034006082a811ccf550168020410f414bdfbca9d9e902114536a3b9c443204820320d76516cc03294caaa08df866f53ac3ddc8331f5aa82c09d1ae49c41746165293d70f8d2e7578e4a6c59c9a2adb7b446fd7139e6e1d9f4fef7dca09425b574dfd30c24d773c59bcd86384f013439e7b0f61439192f9b7889a72d4fb59d20eaa7dc7191594aa5cdb855410f0b6be69cb5eb5f303a605300d48c8ca0b86549ba2c586009fa7a24e4b71a2c304aa34f9a6cb45d1e5d97e6d768dd63a1bfbe7a975be13585742aed7e3e606450530c05c0cd1c41dea44603f628bc2398cdd706abb66ca964178122b99c879bf1ded48268f662cbb1d06798e19ecb61c5719fd85b4bf72b25226778632e4510009f101a50fc66ef8f12088357ccac4749262f2eb07b6ea6d800ed3897a02d530b0e6f22b378354edddd8bf4a8df07d020986c1f49570853f4875e00fac96b2f8054288ebebb4d86ebfb644f53b1195fc2ff04effe18d419da605ba949ff7a3cc3624fdb71af173a8b8e0c721ff0095f1cfb08d1f236835013811502da499408de1ed0d329027d65b62790043f0b2f67a71f2056ca1c2e431147b145d8817b86a49d08e82c5d710e999078fa8bc1144bb77654a53d91591522540f3ac835ad1df444f94db2c07f223be6db215034ef39c2123690d0457877c40ea91f5662f2efb57cefa4d8b3bb6ce18bed2de4de3c8d53c9bd2f0be84471a88719f74a3e2193915db3c455c597e897ada24e6c3e628e03416a759ed1a7886525569a2b7e7431311504e27add6b43d85e704d364fe6446c29c314e95c498fea6b8123d811480a1add915a34d4ffeda304e0ee8456f842786a385eaac42c0beec3b37d30906a982340a1a9a0151eca11040fd2c467a8a014e2db9ccec96f0d927208de545fddd0cae8b7da3ce113d0ac95fb84ec74ed266ae8676ac662f21bb93034064a043e5969c378e825b3751d6c54e9d8d79a905c942857103564ce7ed5c61c899420d02170f42e41e3193cd5de116701c59043fc42ec596fc8cd05c75ed9fd514c9323ce01143b84080cc2d81ac477c7c2a9ef97ea0b76159fc2ea24e18c8511046f4e500d1653b16b71f0a1028155173a11c55e777dd13c23e67f9fa5e6a8c32162dcf01b09a3c50c106c63d13ce2a9e2fff014665ec490f947706092a811ccf5501831101042024d458eef08943e27b496fd180de68c18f467bee9d3c802bb56d607a364ddc70</span></span><br><span class="line"><span class="string">SM2参数:</span></span><br><span class="line"><span class="string">  xCoordinate: 467b2389364b2ebd2eadfa624d668c9b0d530b89edbaf9676c1d7db18c7da405</span></span><br><span class="line"><span class="string">  yCoordinate: 99f160a4fc540baa3c316e0b28db789f366fc4c84ba1a98e3aaf0806667a82d8</span></span><br><span class="line"><span class="string">  hash: 4452c9104b87f44ac026d449cb5b5b5f306b2deab5187db7b3cb845659b1714b</span></span><br><span class="line"><span class="string">  cipherText: 443c9a3f4f7b0083ddd323d6a1f57650</span></span><br><span class="line"><span class="string">SM4参数:</span></span><br><span class="line"><span class="string">  algorithm: 1.2.156.10197.1.104.2</span></span><br><span class="line"><span class="string">  iv: f414bdfbca9d9e902114536a3b9c4432</span></span><br><span class="line"><span class="string">  cipherText: d76516cc03294caaa08df866f53ac3ddc8331f5aa82c09d1ae49c41746165293d70f8d2e7578e4a6c59c9a2adb7b446fd7139e6e1d9f4fef7dca09425b574dfd30c24d773c59bcd86384f013439e7b0f61439192f9b7889a72d4fb59d20eaa7dc7191594aa5cdb855410f0b6be69cb5eb5f303a605300d48c8ca0b86549ba2c586009fa7a24e4b71a2c304aa34f9a6cb45d1e5d97e6d768dd63a1bfbe7a975be13585742aed7e3e606450530c05c0cd1c41dea44603f628bc2398cdd706abb66ca964178122b99c879bf1ded48268f662cbb1d06798e19ecb61c5719fd85b4bf72b25226778632e4510009f101a50fc66ef8f12088357ccac4749262f2eb07b6ea6d800ed3897a02d530b0e6f22b378354edddd8bf4a8df07d020986c1f49570853f4875e00fac96b2f8054288ebebb4d86ebfb644f53b1195fc2ff04effe18d419da605ba949ff7a3cc3624fdb71af173a8b8e0c721ff0095f1cfb08d1f236835013811502da499408de1ed0d329027d65b62790043f0b2f67a71f2056ca1c2e431147b145d8817b86a49d08e82c5d710e999078fa8bc1144bb77654a53d91591522540f3ac835ad1df444f94db2c07f223be6db215034ef39c2123690d0457877c40ea91f5662f2efb57cefa4d8b3bb6ce18bed2de4de3c8d53c9bd2f0be84471a88719f74a3e2193915db3c455c597e897ada24e6c3e628e03416a759ed1a7886525569a2b7e7431311504e27add6b43d85e704d364fe6446c29c314e95c498fea6b8123d811480a1add915a34d4ffeda304e0ee8456f842786a385eaac42c0beec3b37d30906a982340a1a9a0151eca11040fd2c467a8a014e2db9ccec96f0d927208de545fddd0cae8b7da3ce113d0ac95fb84ec74ed266ae8676ac662f21bb93034064a043e5969c378e825b3751d6c54e9d8d79a905c942857103564ce7ed5c61c899420d02170f42e41e3193cd5de116701c59043fc42ec596fc8cd05c75ed9fd514c9323ce01143b84080cc2d81ac477c7c2a9ef97ea0b76159fc2ea24e18c8511046f4e500d1653b16b71f0a1028155173a11c55e777dd13c23e67f9fa5e6a8c32162dcf01b09a3c50c106c63d13ce2a9e2fff014665ec490f9477</span></span><br><span class="line"><span class="string">SM3参数:</span></span><br><span class="line"><span class="string">  digestAlgorithm: 1.2.156.10197.1.401.1</span></span><br><span class="line"><span class="string">  digest: 24d458eef08943e27b496fd180de68c18f467bee9d3c802bb56d607a364ddc70</span></span><br><span class="line"><span class="string">None</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">asn1格式的16进制字符串:</span></span><br><span class="line"><span class="string">  asn1: 3081e830790220467b2389364b2ebd2eadfa624d668c9b0d530b89edbaf9676c1d7db18c7da40502210099f160a4fc540baa3c316e0b28db789f366fc4c84ba1a98e3aaf0806667a82d804204452c9104b87f44ac026d449cb5b5b5f306b2deab5187db7b3cb845659b1714b0410443c9a3f4f7b0083ddd323d6a1f57650303e06082a811ccf550168020410b63a85e103d362fb6247c19e324e97c4042098fea6b8123d811480a1add915a34d4fdbbfd86515a457e1b20bf4751ea0010706092a811ccf55018311010420aab05fca300811223b3b957bfe33130770fb7a6b55b030a5809c559344f66f79</span></span><br><span class="line"><span class="string">SM2参数:</span></span><br><span class="line"><span class="string">  xCoordinate: 467b2389364b2ebd2eadfa624d668c9b0d530b89edbaf9676c1d7db18c7da405</span></span><br><span class="line"><span class="string">  yCoordinate: 99f160a4fc540baa3c316e0b28db789f366fc4c84ba1a98e3aaf0806667a82d8</span></span><br><span class="line"><span class="string">  hash: 4452c9104b87f44ac026d449cb5b5b5f306b2deab5187db7b3cb845659b1714b</span></span><br><span class="line"><span class="string">  cipherText: 443c9a3f4f7b0083ddd323d6a1f57650</span></span><br><span class="line"><span class="string">SM4参数:</span></span><br><span class="line"><span class="string">  algorithm: 1.2.156.10197.1.104.2</span></span><br><span class="line"><span class="string">  iv: b63a85e103d362fb6247c19e324e97c4</span></span><br><span class="line"><span class="string">  cipherText: 98fea6b8123d811480a1add915a34d4fdbbfd86515a457e1b20bf4751ea00107</span></span><br><span class="line"><span class="string">SM3参数:</span></span><br><span class="line"><span class="string">  digestAlgorithm: 1.2.156.10197.1.401.1</span></span><br><span class="line"><span class="string">  digest: aab05fca300811223b3b957bfe33130770fb7a6b55b030a5809c559344f66f79</span></span><br><span class="line"><span class="string">None</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>([i ^ j <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(a, b)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">m1 = <span class="string">&#x27;6362646264646264646361636463646261636164626362646264616161636162636261616461646263626362626264636163616264626164616161616361616161636163636361626463616361626263626263646462626261616462646362626162646162646461646264626361646264636164626262626264646464626362626462626364646463636362636264616161636461626363626362616263636264636164636261646262626161636161616461616163616461626461646464616363646462636464646464636462636264636464636162616461646263646264636363616263616164646263646362646161616361646261616161626261626462636261646362626362626462636463616164636263646164636461646364646464616461626463616463636362626464646463636461626264636363636263646463626163636362646264616261636464626164646363626164626264616462626264646463646163646162626364616264646163636362646164616263616461626164636261646361636162616162646161646162636364646162626361646362646361626463616262646362636261616464626162636161616362616464616261626363616464626164616362616262616463626364646461636461636164636261626364646362626263636164626161636264646261636264626164626264636463616263646462646464636461626264626262626263626362636463636362636264646262626162626364616363636264626462636163646361636163616464626361616262646361626261646364646461636164626164646361626264616364626361636163626163636363626464626462646364646364616461616161616361646264626364636364626261636363636361616264636262646262616263636361616361616261616162636163646363646264636364616362626362626463616264646261626164646263646164646264616463646462626261616461636461626262636462646163636461646362616363616163616361626162636462616362636361646363626161636362636361616261636362636463&#x27;</span></span><br><span class="line">iv1 = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;f414bdfbca9d9e902114536a3b9c4432&#x27;</span>)</span><br><span class="line">ct1 = <span class="string">&#x27;d76516cc03294caaa08df866f53ac3ddc8331f5aa82c09d1ae49c41746165293d70f8d2e7578e4a6c59c9a2adb7b446fd7139e6e1d9f4fef7dca09425b574dfd30c24d773c59bcd86384f013439e7b0f61439192f9b7889a72d4fb59d20eaa7dc7191594aa5cdb855410f0b6be69cb5eb5f303a605300d48c8ca0b86549ba2c586009fa7a24e4b71a2c304aa34f9a6cb45d1e5d97e6d768dd63a1bfbe7a975be13585742aed7e3e606450530c05c0cd1c41dea44603f628bc2398cdd706abb66ca964178122b99c879bf1ded48268f662cbb1d06798e19ecb61c5719fd85b4bf72b25226778632e4510009f101a50fc66ef8f12088357ccac4749262f2eb07b6ea6d800ed3897a02d530b0e6f22b378354edddd8bf4a8df07d020986c1f49570853f4875e00fac96b2f8054288ebebb4d86ebfb644f53b1195fc2ff04effe18d419da605ba949ff7a3cc3624fdb71af173a8b8e0c721ff0095f1cfb08d1f236835013811502da499408de1ed0d329027d65b62790043f0b2f67a71f2056ca1c2e431147b145d8817b86a49d08e82c5d710e999078fa8bc1144bb77654a53d91591522540f3ac835ad1df444f94db2c07f223be6db215034ef39c2123690d0457877c40ea91f5662f2efb57cefa4d8b3bb6ce18bed2de4de3c8d53c9bd2f0be84471a88719f74a3e2193915db3c455c597e897ada24e6c3e628e03416a759ed1a7886525569a2b7e7431311504e27add6b43d85e704d364fe6446c29c314e95c498fea6b8123d811480a1add915a34d4ffeda304e0ee8456f842786a385eaac42c0beec3b37d30906a982340a1a9a0151eca11040fd2c467a8a014e2db9ccec96f0d927208de545fddd0cae8b7da3ce113d0ac95fb84ec74ed266ae8676ac662f21bb93034064a043e5969c378e825b3751d6c54e9d8d79a905c942857103564ce7ed5c61c899420d02170f42e41e3193cd5de116701c59043fc42ec596fc8cd05c75ed9fd514c9323ce01143b84080cc2d81ac477c7c2a9ef97ea0b76159fc2ea24e18c8511046f4e500d1653b16b71f0a1028155173a11c55e777dd13c23e67f9fa5e6a8c32162dcf01b09a3c50c106c63d13ce2a9e2fff014665ec490f9477&#x27;</span></span><br><span class="line">iv2 = <span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;b63a85e103d362fb6247c19e324e97c4&#x27;</span>)</span><br><span class="line">ct2 = <span class="string">&#x27;98fea6b8123d811480a1add915a34d4fdbbfd86515a457e1b20bf4751ea00107&#x27;</span></span><br><span class="line">d = <span class="string">&#x27;aab05fca300811223b3b957bfe33130770fb7a6b55b030a5809c559344f66f79&#x27;</span></span><br><span class="line">t = ct1.index(<span class="string">&#x27;98fea6b8123d811480a1add915a34d4f&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> ct1[t:t+<span class="number">32</span>] == ct2[:<span class="number">32</span>]</span><br><span class="line">mmm = <span class="built_in">bytes</span>.fromhex(m1[t:t+<span class="number">32</span>])</span><br><span class="line">m2 = xor(xor(mmm, <span class="built_in">bytes</span>.fromhex(ct1[t-<span class="number">32</span>:t])), iv2)</span><br><span class="line"><span class="built_in">print</span>(m2)</span><br></pre></td></tr></table></figure>
<p>然后对于第二块，因为长度也不长而且就是明文空间也很小，那就爆吧，时间复杂度也才 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup></mrow><annotation encoding="application/x-tex">2^{32}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>。但是我用 python 实现的话要 300h，那就让队友用 go 给我写了一个，最后用了 8min 就出了。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/tjfoc/gmsm/sm3&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> char = []<span class="type">byte</span>(<span class="string">&quot;abcd&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">index_to_char</span><span class="params">(index <span class="type">uint64</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	res := []<span class="type">byte</span>&#123;&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(res) == <span class="number">15</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">append</span>(res, char[index])</span><br><span class="line">		&#125;</span><br><span class="line">		res = <span class="built_in">append</span>(res, char[index%<span class="number">4</span>])</span><br><span class="line">		index /= <span class="number">4</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> char_set = []<span class="type">byte</span>(<span class="string">&quot;adcddbbadcacabad&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> tar_hex = <span class="string">&quot;aab05fca300811223b3b957bfe33130770fb7a6b55b030a5809c559344f66f79&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> j <span class="type">uint64</span></span><br><span class="line">	wg := &amp;sync.WaitGroup&#123;&#125;</span><br><span class="line">	wg.Add(<span class="number">256</span>)</span><br><span class="line">	time_start := time.Now()</span><br><span class="line">	<span class="keyword">defer</span> wg.Wait()</span><br><span class="line">	<span class="keyword">for</span> j = <span class="number">0</span>; j &lt;= <span class="number">0xff</span>; j++ &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(j <span class="type">uint64</span>)</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> wg.Done()</span><br><span class="line">			<span class="keyword">var</span> i <span class="type">uint64</span></span><br><span class="line">			<span class="keyword">for</span> i = <span class="number">0</span>; i &lt;= <span class="number">0xffffff</span>; i++ &#123;</span><br><span class="line">				data := <span class="built_in">append</span>(char_set, index_to_char((j &lt;&lt; <span class="number">24</span>) + i)...)</span><br><span class="line">				<span class="comment">// fmt.Println(data)	</span></span><br><span class="line">				hash := sm3.New()</span><br><span class="line">				hash.Write(data)</span><br><span class="line">				sum := hash.Sum(<span class="literal">nil</span>)</span><br><span class="line">				sum_hex := fmt.Sprintf(<span class="string">&quot;%x&quot;</span>, sum)</span><br><span class="line">				<span class="comment">// fmt.Printf(&quot;j: %d, i: %d, sum_hex: %s\n&quot;, j, i, sum_hex)</span></span><br><span class="line">				<span class="keyword">if</span> sum_hex ==  tar_hex &#123;</span><br><span class="line">					fmt.Println(<span class="type">string</span>(data))	</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;(j)</span><br><span class="line">	&#125;</span><br><span class="line">	wg.Wait()</span><br><span class="line">	time_end := time.Now()</span><br><span class="line">	fmt.Printf(<span class="string">&quot;Time taken: %v\n&quot;</span>, time_end.Sub(time_start))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="初始谜题2"><a class="markdownIt-Anchor" href="#初始谜题2"></a> 初始谜题2</h2>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> pyasn1.<span class="built_in">type</span> <span class="keyword">import</span> univ, namedtype</span><br><span class="line"><span class="keyword">from</span> pyasn1.codec.der.encoder <span class="keyword">import</span> encode</span><br><span class="line"><span class="keyword">from</span> pyasn1.codec.der.decoder <span class="keyword">import</span> decode</span><br><span class="line"><span class="keyword">from</span> gmssl <span class="keyword">import</span> sm2</span><br><span class="line"><span class="keyword">from</span> pyasn1.codec.der <span class="keyword">import</span> decoder, encoder</span><br><span class="line"><span class="keyword">from</span> pyasn1_modules <span class="keyword">import</span> rfc2459</span><br><span class="line"><span class="keyword">from</span> gmssl.sm2 <span class="keyword">import</span> CryptSM2</span><br><span class="line"><span class="keyword">from</span> pyasn1.<span class="built_in">type</span>.useful <span class="keyword">import</span> GeneralizedTime</span><br><span class="line"><span class="keyword">from</span> pyasn1.<span class="built_in">type</span>.univ <span class="keyword">import</span> <span class="type">Sequence</span></span><br><span class="line"><span class="keyword">from</span> pyasn1.<span class="built_in">type</span> <span class="keyword">import</span> useful</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ECPrimeFieldConfig</span>(univ.<span class="type">Sequence</span>):</span><br><span class="line">    componentType = namedtype.NamedTypes(</span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;fieldType&#x27;</span>, univ.ObjectIdentifier(<span class="string">&#x27;1.2.840.10045.1.1&#x27;</span>)),  <span class="comment"># Prime field OID</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;prime&#x27;</span>, univ.Integer()),  <span class="comment"># Prime number p</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ECCurveParameters</span>(univ.<span class="type">Sequence</span>):</span><br><span class="line">    componentType = namedtype.NamedTypes(</span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;coefficientA&#x27;</span>, univ.OctetString()),  <span class="comment"># Curve coefficient a</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;coefficientB&#x27;</span>, univ.OctetString()),  <span class="comment"># Curve coefficient b</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ECDomainParameters</span>(univ.<span class="type">Sequence</span>):</span><br><span class="line">    componentType = namedtype.NamedTypes(</span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;version&#x27;</span>, univ.Integer(<span class="number">1</span>)),  <span class="comment"># Version number (1)</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;fieldParameters&#x27;</span>, ECPrimeFieldConfig()),  <span class="comment"># Field parameters 包含参数oid，p</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;curveParameters&#x27;</span>, ECCurveParameters()),  <span class="comment"># Curve parameters 包含参数a，b</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;basePoint&#x27;</span>, univ.OctetString()),  <span class="comment"># Base point G 基点</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;order&#x27;</span>, univ.Integer()),  <span class="comment"># Order n of base point 参数n</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;cofactor&#x27;</span>, univ.Integer(<span class="number">1</span>)),  <span class="comment"># Cofactor 余因子 固定值为1</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SM2SignatureValue</span>(univ.<span class="type">Sequence</span>):</span><br><span class="line">    componentType = namedtype.NamedTypes(</span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;r&#x27;</span>, univ.Integer()),  <span class="comment"># First part of signature</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;s&#x27;</span>, univ.Integer()),  <span class="comment"># Second part of signature</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SM2SignedData</span>(univ.<span class="type">Sequence</span>):</span><br><span class="line">    componentType = namedtype.NamedTypes(</span><br><span class="line">        <span class="comment"># version</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;version&#x27;</span>, univ.Integer()),</span><br><span class="line">        <span class="comment"># 哈希算法 OID（SM3）</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;digestAlgorithms&#x27;</span>, univ.ObjectIdentifier()),</span><br><span class="line">        <span class="comment"># 签名值 r, s</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;sm2Signature&#x27;</span>, SM2SignatureValue()),</span><br><span class="line">        <span class="comment"># 曲线参数</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;ecDomainParameters&#x27;</span>, ECDomainParameters()),</span><br><span class="line">        <span class="comment"># 证书</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;certificate&#x27;</span>, univ.OctetString()),</span><br><span class="line">        <span class="comment"># 签名时间</span></span><br><span class="line">        namedtype.NamedType(<span class="string">&#x27;timestamp&#x27;</span>, GeneralizedTime()),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输入值全部为16进制字符串,g为x，y坐标的16进制字符串进行拼接</span></span><br><span class="line"><span class="comment"># p,a,b,n,g对应曲线参数;r,s为签名值的两部分</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">asn1_package</span>(<span class="params">version, oid, signature, curve_params, cert_hex, time_stamp</span>):</span><br><span class="line">    sm2_signed_data = SM2SignedData()</span><br><span class="line">    <span class="comment"># version</span></span><br><span class="line">    sm2_signed_data[<span class="string">&#x27;version&#x27;</span>] = version</span><br><span class="line">    <span class="comment"># 哈希算法 OID（SM3）</span></span><br><span class="line">    sm2_signed_data[<span class="string">&#x27;digestAlgorithms&#x27;</span>] = oid</span><br><span class="line">    <span class="comment"># 签名值 r, s</span></span><br><span class="line">    sm2_signed_data[<span class="string">&quot;sm2Signature&quot;</span>] = SM2SignatureValue()</span><br><span class="line">    sm2_signed_data[<span class="string">&quot;sm2Signature&quot;</span>][<span class="string">&#x27;r&#x27;</span>] = <span class="built_in">int</span>(signature[:<span class="number">64</span>], <span class="number">16</span>)</span><br><span class="line">    sm2_signed_data[<span class="string">&quot;sm2Signature&quot;</span>][<span class="string">&#x27;s&#x27;</span>] = <span class="built_in">int</span>(signature[<span class="number">64</span>:], <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># 曲线参数</span></span><br><span class="line">    sm2_signed_data[<span class="string">&quot;ecDomainParameters&quot;</span>] = ECDomainParameters()</span><br><span class="line">    sm2_signed_data[<span class="string">&quot;ecDomainParameters&quot;</span>][<span class="string">&quot;fieldParameters&quot;</span>] = ECPrimeFieldConfig()</span><br><span class="line">    sm2_signed_data[<span class="string">&quot;ecDomainParameters&quot;</span>][<span class="string">&quot;fieldParameters&quot;</span>][<span class="string">&quot;prime&quot;</span>] = <span class="built_in">int</span>(curve_params[<span class="string">&#x27;p&#x27;</span>], <span class="number">16</span>)</span><br><span class="line">    sm2_signed_data[<span class="string">&quot;ecDomainParameters&quot;</span>][<span class="string">&quot;curveParameters&quot;</span>] = ECCurveParameters()</span><br><span class="line">    sm2_signed_data[<span class="string">&quot;ecDomainParameters&quot;</span>][<span class="string">&quot;curveParameters&quot;</span>][<span class="string">&quot;coefficientA&quot;</span>] = univ.OctetString(</span><br><span class="line">        <span class="built_in">bytes</span>.fromhex(curve_params[<span class="string">&#x27;a&#x27;</span>]))</span><br><span class="line">    sm2_signed_data[<span class="string">&quot;ecDomainParameters&quot;</span>][<span class="string">&quot;curveParameters&quot;</span>][<span class="string">&quot;coefficientB&quot;</span>] = univ.OctetString(</span><br><span class="line">        <span class="built_in">bytes</span>.fromhex(curve_params[<span class="string">&#x27;b&#x27;</span>]))</span><br><span class="line">    sm2_signed_data[<span class="string">&quot;ecDomainParameters&quot;</span>][<span class="string">&#x27;basePoint&#x27;</span>] = univ.OctetString(<span class="built_in">bytes</span>.fromhex(<span class="string">&#x27;04&#x27;</span> + curve_params[<span class="string">&#x27;g&#x27;</span>]))</span><br><span class="line">    sm2_signed_data[<span class="string">&quot;ecDomainParameters&quot;</span>][<span class="string">&#x27;order&#x27;</span>] = <span class="built_in">int</span>(curve_params[<span class="string">&#x27;n&#x27;</span>], <span class="number">16</span>)</span><br><span class="line">    <span class="comment"># 证书</span></span><br><span class="line">    sm2_signed_data[<span class="string">&quot;certificate&quot;</span>] = univ.OctetString(<span class="built_in">bytes</span>.fromhex(cert_hex))</span><br><span class="line">    <span class="comment"># 时间</span></span><br><span class="line">    dt = datetime.strptime(time_stamp, <span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">    asn1_time_str = dt.strftime(<span class="string">&quot;%Y%m%d%H%M%SZ&quot;</span>)</span><br><span class="line">    sm2_signed_data[<span class="string">&quot;timestamp&quot;</span>] = GeneralizedTime(asn1_time_str)</span><br><span class="line">    <span class="keyword">return</span> encode(sm2_signed_data).<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sm2CertVerifier</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cert_hex: <span class="built_in">str</span></span>):</span><br><span class="line">        ca_pubkey = <span class="string">&quot;8E1860588D9900C16BD19A0FE0A5ACC600224DBD794FFD34179E03698D52421F46E6D8C6E8AADE512C7B543395AC39C76384726C7F8BA537ABCA0C129ECD9882&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.sm2_crypt = sm2.CryptSM2(public_key=ca_pubkey, private_key=<span class="literal">None</span>)</span><br><span class="line">        <span class="variable language_">self</span>.cert_tbs, <span class="variable language_">self</span>.signature_bytes, <span class="variable language_">self</span>.cert = <span class="variable language_">self</span>.parse_cert(<span class="built_in">bytes</span>.fromhex(cert_hex))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_cert</span>(<span class="params">cert_der_bytes: <span class="built_in">bytes</span></span>):</span><br><span class="line">        cert, _ = decoder.decode(cert_der_bytes, asn1Spec=rfc2459.Certificate())</span><br><span class="line">        tbs = cert.getComponentByName(<span class="string">&#x27;tbsCertificate&#x27;</span>)</span><br><span class="line">        signature_bytes = cert.getComponentByName(<span class="string">&#x27;signatureValue&#x27;</span>).asOctets()</span><br><span class="line">        <span class="keyword">return</span> tbs, signature_bytes, cert</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取签名值</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decode_rs_from_der</span>(<span class="params">self, signature: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        seq, _ = decode(signature, asn1Spec=<span class="type">Sequence</span>())</span><br><span class="line">        r = <span class="built_in">int</span>(seq[<span class="number">0</span>])</span><br><span class="line">        s = <span class="built_in">int</span>(seq[<span class="number">1</span>])</span><br><span class="line">        r_bytes = r.to_bytes(<span class="number">32</span>, byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        s_bytes = s.to_bytes(<span class="number">32</span>, byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> r_bytes + s_bytes</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify_signature</span>(<span class="params">self, signature: <span class="built_in">bytes</span>, tbs: <span class="built_in">str</span></span>):</span><br><span class="line">        inter_cert_tbs_der = encoder.encode(tbs)</span><br><span class="line">        inter_signature = <span class="variable language_">self</span>.decode_rs_from_der(signature)</span><br><span class="line">        <span class="comment"># 验证签名（tbs_der必须完整，签名必须64字节）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.sm2_crypt.verify_with_sm3(inter_signature.<span class="built_in">hex</span>(), inter_cert_tbs_der)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify_certificate_expiration_date</span>(<span class="params">self, tbs</span>):</span><br><span class="line">        validity = tbs.getComponentByName(<span class="string">&#x27;validity&#x27;</span>)</span><br><span class="line">        not_before = validity.getComponentByName(<span class="string">&#x27;notBefore&#x27;</span>).getComponent()</span><br><span class="line">        not_after = validity.getComponentByName(<span class="string">&#x27;notAfter&#x27;</span>).getComponent()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理 UTCTime 和 GeneralizedTime 两种类型</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(not_before, useful.UTCTime):</span><br><span class="line">            not_before_time = datetime.strptime(<span class="built_in">str</span>(not_before), <span class="string">&quot;%y%m%d%H%M%SZ&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(not_before, useful.GeneralizedTime):</span><br><span class="line">            not_before_time = datetime.strptime(<span class="built_in">str</span>(not_before), <span class="string">&quot;%Y%m%d%H%M%SZ&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Unsupported notBefore time format&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(not_after, useful.UTCTime):</span><br><span class="line">            not_after_time = datetime.strptime(<span class="built_in">str</span>(not_after), <span class="string">&quot;%y%m%d%H%M%SZ&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(not_after, useful.GeneralizedTime):</span><br><span class="line">            not_after_time = datetime.strptime(<span class="built_in">str</span>(not_after), <span class="string">&quot;%Y%m%d%H%M%SZ&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Unsupported notAfter time format&quot;</span>)</span><br><span class="line"></span><br><span class="line">        now = datetime.now()</span><br><span class="line">        <span class="keyword">return</span> not_before_time &lt;= now &lt;= not_after_time</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 验证中间证书有效期</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.verify_certificate_expiration_date(<span class="variable language_">self</span>.cert_tbs):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;证书已过期或尚未生效&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># 验证中间证书签名</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.verify_signature(<span class="variable language_">self</span>.signature_bytes, <span class="variable language_">self</span>.cert_tbs):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;证书验证未通过&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SM2Config</span>:</span><br><span class="line">    <span class="comment"># sm2参数初始化</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, asn1_str</span>):</span><br><span class="line">        <span class="variable language_">self</span>.sm2_signed_data,asn1_acess = <span class="variable language_">self</span>.hex_to_asn1(asn1_str, SM2SignedData())</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(asn1_acess) != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;asn1长度有问题&quot;</span>)</span><br><span class="line">        cert_hex = <span class="variable language_">self</span>.get_hex_value(<span class="variable language_">self</span>.sm2_signed_data[<span class="string">&#x27;certificate&#x27;</span>])</span><br><span class="line">        sm2_cert_verifier = Sm2CertVerifier(cert_hex)</span><br><span class="line">        valid = sm2_cert_verifier.verify()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> valid:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">&quot;证书验证不通过&quot;</span>)</span><br><span class="line">        g = <span class="variable language_">self</span>.get_hex_value(<span class="variable language_">self</span>.sm2_signed_data[<span class="string">&#x27;ecDomainParameters&#x27;</span>][<span class="string">&#x27;basePoint&#x27;</span>])</span><br><span class="line">        g = g[<span class="number">2</span>:] <span class="keyword">if</span> g.startswith(<span class="string">&quot;04&quot;</span>) <span class="keyword">else</span> g</span><br><span class="line">        <span class="variable language_">self</span>.ecc_table = &#123;</span><br><span class="line">            <span class="string">&#x27;n&#x27;</span>: <span class="variable language_">self</span>.get_hex_value(<span class="variable language_">self</span>.sm2_signed_data[<span class="string">&#x27;ecDomainParameters&#x27;</span>][<span class="string">&#x27;order&#x27;</span>]),</span><br><span class="line">            <span class="string">&#x27;p&#x27;</span>: <span class="variable language_">self</span>.get_hex_value(<span class="variable language_">self</span>.sm2_signed_data[<span class="string">&#x27;ecDomainParameters&#x27;</span>][<span class="string">&#x27;fieldParameters&#x27;</span>][<span class="string">&#x27;prime&#x27;</span>]),</span><br><span class="line">            <span class="string">&#x27;g&#x27;</span>: g,</span><br><span class="line">            <span class="string">&#x27;a&#x27;</span>: <span class="variable language_">self</span>.get_hex_value(<span class="variable language_">self</span>.sm2_signed_data[<span class="string">&#x27;ecDomainParameters&#x27;</span>][<span class="string">&#x27;curveParameters&#x27;</span>][<span class="string">&#x27;coefficientA&#x27;</span>]),</span><br><span class="line">            <span class="string">&#x27;b&#x27;</span>: <span class="variable language_">self</span>.get_hex_value(<span class="variable language_">self</span>.sm2_signed_data[<span class="string">&#x27;ecDomainParameters&#x27;</span>][<span class="string">&#x27;curveParameters&#x27;</span>][<span class="string">&#x27;coefficientB&#x27;</span>]),</span><br><span class="line">        &#125;</span><br><span class="line">        public_key = <span class="variable language_">self</span>.extract_public_key(sm2_cert_verifier.cert_tbs)</span><br><span class="line">        <span class="variable language_">self</span>.sm2_crypt = CryptSM2(</span><br><span class="line">            private_key=<span class="string">&quot;&quot;</span>,</span><br><span class="line">            public_key=public_key,</span><br><span class="line">            ecc_table=<span class="variable language_">self</span>.ecc_table</span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">self</span>.sign = (<span class="built_in">int</span>(<span class="variable language_">self</span>.sm2_signed_data[<span class="string">&#x27;sm2Signature&#x27;</span>][<span class="string">&#x27;r&#x27;</span>]).to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>).<span class="built_in">hex</span>().upper() +</span><br><span class="line">                     <span class="built_in">int</span>(<span class="variable language_">self</span>.sm2_signed_data[<span class="string">&#x27;sm2Signature&#x27;</span>][<span class="string">&#x27;s&#x27;</span>]).to_bytes(<span class="number">32</span>, <span class="string">&#x27;big&#x27;</span>).<span class="built_in">hex</span>().upper())</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hex_to_asn1</span>(<span class="params">hex_str, asn1_spec</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将16进制字符串转换回ASN.1对象</span></span><br><span class="line"><span class="string">        :param hex_str: 16进制字符串</span></span><br><span class="line"><span class="string">        :param asn1_spec: ASN.1结构定义</span></span><br><span class="line"><span class="string">        :return: ASN.1对象</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 将16进制字符串转换为字节</span></span><br><span class="line">        der_bytes = binascii.unhexlify(hex_str)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 解码为ASN.1对象</span></span><br><span class="line">        asn1_object, excess = decode(der_bytes, asn1Spec=asn1_spec)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> asn1_object,excess</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_hex_value</span>(<span class="params">value</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;通用转换函数：将 ASN.1 值转换为 16 进制字符串（大写，无前缀）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, univ.Integer):</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">format</span>(<span class="built_in">int</span>(value), <span class="string">&#x27;X&#x27;</span>)  <span class="comment"># Integer -&gt; 直接转十六进制</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(value, univ.OctetString):</span><br><span class="line">            <span class="keyword">return</span> value.asOctets().<span class="built_in">hex</span>().upper()  <span class="comment"># OctetString -&gt; 字节转十六进制</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> TypeError(<span class="string">f&quot;Unsupported type: <span class="subst">&#123;<span class="built_in">type</span>(value)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract_public_key</span>(<span class="params">tbs</span>):</span><br><span class="line">        spki = tbs.getComponentByName(<span class="string">&#x27;subjectPublicKeyInfo&#x27;</span>)</span><br><span class="line">        public_key_bitstring = spki.getComponentByName(<span class="string">&#x27;subjectPublicKey&#x27;</span>)</span><br><span class="line">        <span class="comment"># 提取位串内容（包含开头的 0x04）</span></span><br><span class="line">        pubkey_bytes = <span class="built_in">bytearray</span>(public_key_bitstring.asOctets())</span><br><span class="line">        <span class="comment"># 转成十六进制字符串</span></span><br><span class="line">        <span class="keyword">return</span> pubkey_bytes.<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify_misc</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">int</span>(<span class="variable language_">self</span>.sm2_signed_data[<span class="string">&#x27;version&#x27;</span>]) != <span class="number">1</span> <span class="keyword">or</span></span><br><span class="line">                <span class="built_in">str</span>(<span class="variable language_">self</span>.sm2_signed_data[<span class="string">&#x27;digestAlgorithms&#x27;</span>]) != <span class="string">&#x27;1.2.156.10197.1.401.1&#x27;</span> <span class="keyword">or</span></span><br><span class="line">                <span class="built_in">str</span>(<span class="variable language_">self</span>.sm2_signed_data[<span class="string">&#x27;timestamp&#x27;</span>]) != <span class="string">&quot;20250520101000Z&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># sm2验签</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">self, data</span>):</span><br><span class="line">        valid = <span class="variable language_">self</span>.verify_misc()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> valid:</span><br><span class="line">            <span class="keyword">return</span> valid</span><br><span class="line">        valid = <span class="variable language_">self</span>.sm2_crypt.verify_with_sm3(<span class="variable language_">self</span>.sign, data)</span><br><span class="line">        <span class="keyword">return</span> valid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过该函数可以产生一个合法的SM2SignedData</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generateSM2SignedDataExample</span>():</span><br><span class="line">    <span class="comment"># 版本</span></span><br><span class="line">    version = <span class="number">1</span></span><br><span class="line">    <span class="comment"># 哈希算法oid</span></span><br><span class="line">    oid = <span class="string">&#x27;1.2.156.10197.1.401.1&#x27;</span></span><br><span class="line">    <span class="comment"># 签名值r, s</span></span><br><span class="line">    signature = <span class="string">&#x27;6f8eaff551d0f3fa6de74b75b33e1e58f9fdb4dc58e61c82e11e717ffcf168c4db3d5a90ff3625d12b8b658f8dbab34340c278b412b3aff25489e7feb1c75598&#x27;</span></span><br><span class="line">    r = signature[:<span class="number">64</span>]</span><br><span class="line">    s = signature[<span class="number">64</span>:]</span><br><span class="line">    <span class="comment"># 曲线参数</span></span><br><span class="line">    curve_params = &#123;</span><br><span class="line">        <span class="string">&quot;n&quot;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;p&quot;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;g&quot;</span>: <span class="string">&#x27;32c4ae2c1f1981195f9904466a39c9948fe30bbff2660be1715a4589334c74c7bc3736a2f4f6779c59bdcee36b692153d0a9877cc62a474002df32e52139f0a0&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;a&quot;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;b&quot;</span>: <span class="string">&#x27;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 证书</span></span><br><span class="line">    cert_hex = <span class="string">&#x27;3082017C30820122A003020102020D00947C8427D3E849B48A7E5136300A06082A811CCF550183753036310B300906035504061302434E31133011060355040A130A5368616E674D6942656931123010060355040313095368616E674D694341301E170D3235303532303035353330365A170D3330303531393035353330365A304D310B300906035504061302434E3110300E060355040A1307496E746572434131173015060355040B130E5368616E674D6942656932303235311330110603550403130A7368616E676D696265693059301306072A8648CE3D020106082A811CCF5501822D03420004CECC0005AED684A1E7E39C316E7F3F39BDD0490936BC0E1AFDDC1B9627A05B4418809E5327746EE1977913F036EF0A9A255C27D73C00E45D0BB205B34D2C80D4300A06082A811CCF5501837503480030450220360779CBF5AA6E5E9CC073D95E22C52C09E81CFC06A3916559063A3C8C1DFDE6022100ED0E5E5E51F3894A3EAC11F247739D9F6A88C961D89F68337972BC3CC6BB6706&#x27;</span>  <span class="comment"># 证书16进制格式</span></span><br><span class="line">    <span class="comment"># 时间</span></span><br><span class="line">    time_stamp = <span class="string">&#x27;2025-05-20 10:10:00&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># asn1封装</span></span><br><span class="line">    asn1_package_hex = asn1_package(version, oid, signature, curve_params, cert_hex, time_stamp)</span><br><span class="line">    <span class="keyword">return</span>(asn1_package_hex)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 验签</span></span><br><span class="line">    data = <span class="string">b&quot;Hello, CryptoCup!&quot;</span></span><br><span class="line">    asn1_package_hex = generateSM2SignedDataExample()</span><br><span class="line">    sm2_config = SM2Config(asn1_package_hex)</span><br><span class="line">    result = sm2_config.verify(data)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>SM2SignedData.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">308202CD02010106092A811CCF5501831101304502206F8EAFF551D0F3FA6DE74B75B33E1E58F9FDB4DC58E61C82E11E717FFCF168C4022100DB3D5A90FF3625D12B8B658F8DBAB34340C278B412B3AFF25489E7FEB1C755983081E0020101302C06072A8648CE3D0101022100FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF30440420FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC042028E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E9304410432C4AE2C1F1981195F9904466A39C9948FE30BBFF2660BE1715A4589334C74C7BC3736A2F4F6779C59BDCEE36B692153D0A9877CC62A474002DF32E52139F0A0022100FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123020101048201803082017C30820122A003020102020D00947C8427D3E849B48A7E5136300A06082A811CCF550183753036310B300906035504061302434E31133011060355040A130A5368616E674D6942656931123010060355040313095368616E674D694341301E170D3235303532303035353330365A170D3330303531393035353330365A304D310B300906035504061302434E3110300E060355040A1307496E746572434131173015060355040B130E5368616E674D6942656932303235311330110603550403130A7368616E676D696265693059301306072A8648CE3D020106082A811CCF5501822D03420004CECC0005AED684A1E7E39C316E7F3F39BDD0490936BC0E1AFDDC1B9627A05B4418809E5327746EE1977913F036EF0A9A255C27D73C00E45D0BB205B34D2C80D4300A06082A811CCF5501837503480030450220360779CBF5AA6E5E9CC073D95E22C52C09E81CFC06A3916559063A3C8C1DFDE6022100ED0E5E5E51F3894A3EAC11F247739D9F6A88C961D89F68337972BC3CC6BB6706180F32303235303532303130313030305A</span><br></pre></td></tr></table></figure>
<p>题目代码需要生成一个指定数据的签名，而这个公钥是在证书中，证书链验证时公钥固定，所以无法修改证书，但是题目额外让我们自己指定曲线参数。</p>
<p>直接对给定的证书里面的公钥Q，可以用sagemath计算出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>255</mn><msup><mi>G</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>Q</mi></mrow><annotation encoding="application/x-tex">255G&#x27;=Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">5</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">Q</span></span></span></span>，然后把基点替换为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>G</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">G&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> 即可通过验签。</p>
<p>首先计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>G</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">G&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pub = <span class="string">&quot;cecc0005aed684a1e7e39c316e7f3f39bdd0490936bc0e1afddc1b9627a05b4418809e5327746ee1977913f036ef0a9a255c27d73c00e45d0bb205b34d2c80d4&quot;</span></span><br><span class="line"></span><br><span class="line">x,y = <span class="built_in">int</span>(pub[:<span class="number">64</span>],<span class="number">16</span>), <span class="built_in">int</span>(pub[<span class="number">64</span>:], <span class="number">16</span>)</span><br><span class="line">P = E(x,y)</span><br><span class="line">G = P * inverse_mod(<span class="number">0xff</span>,n)</span><br><span class="line">G</span><br><span class="line">x = <span class="number">36937047021928959731165221160519944594794112257956092575886609274654427603612</span>  </span><br><span class="line">y = <span class="number">104673289685811405702677634451265453400814492624193002291684496503421528948368</span>  </span><br><span class="line"><span class="built_in">hex</span>(x)[<span class="number">2</span>:].zfill(<span class="number">64</span>) + <span class="built_in">hex</span>(y)[<span class="number">2</span>:].zfill(<span class="number">64</span>)</span><br></pre></td></tr></table></figure>
<p>然后调用gmssl库生成签名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> gmssl.sm2 <span class="keyword">import</span> CryptSM2</span><br><span class="line"></span><br><span class="line">curve_params = &#123;</span><br><span class="line">    <span class="string">&quot;n&quot;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;p&quot;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFF&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;g&quot;</span>: <span class="string">&#x27;51a9a0b4050aaa36ea04d9004d0e477dad7dfb19021147a168969748cd46629ce76afb832729a051f24993c9c201921933b29657a070fd6c537fca04af0fbe90&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: <span class="string">&#x27;FFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF00000000FFFFFFFFFFFFFFFC&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: <span class="string">&#x27;28E9FA9E9D9F5E344D5A9E4BCF6509A7F39789F515AB8F92DDBCBD414D940E93&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sm2_crypt = CryptSM2(</span><br><span class="line">            private_key=<span class="string">&quot;ff&quot;</span>,</span><br><span class="line">            public_key=<span class="string">&quot;cecc0005aed684a1e7e39c316e7f3f39bdd0490936bc0e1afddc1b9627a05b4418809e5327746ee1977913f036ef0a9a255c27d73c00e45d0bb205b34d2c80d4&quot;</span>,</span><br><span class="line">            ecc_table=curve_params</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">msg = <span class="string">b&#x27;EUWJSFTFHGQEQVRXZHJYKPUXDPUMRDQQ&#x27;</span></span><br><span class="line">sig = sm2_crypt.sign_with_sm3(msg)</span><br><span class="line"><span class="built_in">print</span>(sig)</span><br></pre></td></tr></table></figure>
<h2 id="初始谜题3"><a class="markdownIt-Anchor" href="#初始谜题3"></a> 初始谜题3</h2>
<p>题目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Callable</span></span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hex_to_32byte_chunks</span>(<span class="params">hex_str</span>):</span><br><span class="line">    <span class="comment"># 确保十六进制字符串长度是64的倍数（因为32字节 = 64个十六进制字符）</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(hex_str) % <span class="number">64</span> != <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;十六进制字符串长度必须是64的倍数&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 每64个字符分割一次，并转换为字节</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">bytes</span>.fromhex(hex_str[i:i + <span class="number">64</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(hex_str), <span class="number">64</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">openssl_sha256</span>(<span class="params">message: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="keyword">return</span> sha256(message).digest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WOTSPLUS</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        w: <span class="built_in">int</span> = <span class="number">16</span>,  <span class="comment"># Winternitz 参数，控制空间与时间的复杂度</span></span></span><br><span class="line"><span class="params">        hashfunction: <span class="type">Callable</span> = openssl_sha256,  <span class="comment"># 哈希函数</span></span></span><br><span class="line"><span class="params">        digestsize: <span class="built_in">int</span> = <span class="number">256</span>,  <span class="comment"># 摘要大小，单位为比特</span></span></span><br><span class="line"><span class="params">        pubkey: <span class="type">List</span>[<span class="built_in">bytes</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.w = w</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">2</span> &lt;= w &lt;= (<span class="number">1</span> &lt;&lt; digestsize)):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;规则错误:2 &lt;= w &lt;= 2^digestsize&quot;</span>)</span><br><span class="line">        <span class="comment"># 消息摘要所需的密钥数量（默认8个）</span></span><br><span class="line">        <span class="variable language_">self</span>.msg_key_count = <span class="number">8</span></span><br><span class="line">        <span class="comment"># 校验和密钥数量</span></span><br><span class="line">        <span class="variable language_">self</span>.cs_key_count = <span class="number">0</span></span><br><span class="line">        <span class="comment"># 总密钥数量 = 消息密钥 + 校验和密钥</span></span><br><span class="line">        <span class="variable language_">self</span>.key_count = <span class="variable language_">self</span>.msg_key_count + <span class="variable language_">self</span>.cs_key_count</span><br><span class="line">        <span class="variable language_">self</span>.hashfunction = hashfunction</span><br><span class="line">        <span class="variable language_">self</span>.digestsize = digestsize</span><br><span class="line">        <span class="variable language_">self</span>.pubkey = pubkey</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod   </span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">number_to_base</span>(<span class="params">num: <span class="built_in">int</span>, base: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="keyword">if</span> num == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> [<span class="number">0</span>]  <span class="comment"># 如果数字是 0，直接返回 0</span></span><br><span class="line"></span><br><span class="line">        digits = []  <span class="comment"># 存储转换后的数字位</span></span><br><span class="line">        <span class="keyword">while</span> num:</span><br><span class="line">            digits.append(<span class="built_in">int</span>(num % base))  <span class="comment"># 获取当前数字在目标进制下的个位，并添加到结果列表</span></span><br><span class="line">            num //= base  <span class="comment"># 对数字进行整除，处理下一位</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> digits[::-<span class="number">1</span>]  <span class="comment"># 返回按顺序排列的结果</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_chain</span>(<span class="params">self, value: <span class="built_in">bytes</span>, startidx: <span class="built_in">int</span>, endidx: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(startidx, endidx):</span><br><span class="line">            value = <span class="variable language_">self</span>.hashfunction(value)  <span class="comment"># 每次迭代对当前哈希值进行哈希操作</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_signature_base_message</span>(<span class="params">self, msghash: <span class="built_in">bytes</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">        <span class="comment"># 将消息哈希从字节转换为整数</span></span><br><span class="line">        msgnum = <span class="built_in">int</span>.from_bytes(msghash, <span class="string">&quot;big&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 将消息的数字表示转换为特定进制下的比特组表示</span></span><br><span class="line">        msg_to_sign = <span class="variable language_">self</span>.number_to_base(msgnum, <span class="variable language_">self</span>.w)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 校验消息比特组的数量是否符合预期</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(msg_to_sign) &gt; <span class="variable language_">self</span>.msg_key_count:</span><br><span class="line">            err = (</span><br><span class="line">                <span class="string">&quot;The fingerprint of the message could not be split into the&quot;</span></span><br><span class="line">                + <span class="string">&quot; expected amount of bitgroups. This is most likely &quot;</span></span><br><span class="line">                + <span class="string">&quot;because the digestsize specified does not match to the &quot;</span></span><br><span class="line">                + <span class="string">&quot; real digestsize of the specified hashfunction Excepted:&quot;</span></span><br><span class="line">                + <span class="string">&quot; &#123;&#125; bitgroups\nGot: &#123;&#125; bitgroups&quot;</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">raise</span> IndexError(err.<span class="built_in">format</span>(<span class="variable language_">self</span>.msg_key_count, <span class="built_in">len</span>(msg_to_sign)))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> msg_to_sign</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_pubkey_from_signature</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, digest: <span class="built_in">bytes</span>, signature: <span class="type">List</span>[<span class="built_in">bytes</span>]</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="type">List</span>[<span class="built_in">bytes</span>]:</span><br><span class="line">        msg_to_verify = <span class="variable language_">self</span>.get_signature_base_message(digest)</span><br><span class="line"></span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> idx, val <span class="keyword">in</span> <span class="built_in">enumerate</span>(msg_to_verify):</span><br><span class="line">            sig_part = signature[idx]</span><br><span class="line">            chained_val = <span class="variable language_">self</span>._chain(sig_part, val, <span class="variable language_">self</span>.w - <span class="number">1</span>)</span><br><span class="line">            result.append(chained_val)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verify</span>(<span class="params">self, digest: <span class="built_in">bytes</span>, signature: <span class="type">List</span>[<span class="built_in">bytes</span>]</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        pubkey = <span class="variable language_">self</span>.get_pubkey_from_signature(digest, signature)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span> <span class="keyword">if</span> pubkey == <span class="variable language_">self</span>.pubkey <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pubkey_hex = <span class="string">&quot;5057432973dc856a7a00272d83ea1c14de52b5eb3ba8b70b373db8204eb2f902450e38dbade5e9b8c2c3f8258edc4b7e8101e94ac86e4b3cba92ddf3d5de2a2b454c067a995060d1664669b45974b15b3423cec342024fe9ccd4936670ec3abaae4f6b97279bd8eb26463a8cb3112e6dcbf6301e4142b9cdc4adfb644c7b114af4f0cf8f80e22c3975ba477dc4769c3ef67ffdf2090735d81d07bc2e6235af1ee41ef332215422d31208c2bc2163d6690bd32f4926b2858ca41c12eec88c0a300571901a3f674288e4a623220fb6b70e558d9819d2f23da6d897278f4056c346d7f729f5f70805ad4e5bd25cfa502c0625ac02185e014cf36db4ebcdb3ed1a38&quot;</span></span><br><span class="line">    pubkey_list_bytes = hex_to_32byte_chunks(pubkey_hex)</span><br><span class="line">    wots = WOTSPLUS(pubkey = pubkey_list_bytes)</span><br><span class="line">    digest_hex = <span class="string">&quot;84ffb82e&quot;</span></span><br><span class="line">    signature_hex = <span class="string">&quot;25d5a0e650d683506bfe9d2eca6a3a99b547a4b99398622f6666ce10131e971b6bd36841c9074fe9b4de2900ebe3fadb3202a173be486da6cf8f3d8c699c95c3454c067a995060d1664669b45974b15b3423cec342024fe9ccd4936670ec3abaae4f6b97279bd8eb26463a8cb3112e6dcbf6301e4142b9cdc4adfb644c7b114a4966398a789b56bdb09ea195925e7e8cde372305d244604c48db08f08a6e8a38951030deb25a7aaf1c07152a302ebc07d5d0893b5e9a5953f3b8500179d138b9aa90c0aaacea0c23d22a25a86c0b747c561b480175b548fcb1f4ad1153413bc74d9c049d43ffe18ceee31e5be8bdb9968103ef32fb4054a4a23c400bbfe0d89f&quot;</span></span><br><span class="line">    digest_bytes = <span class="built_in">bytes</span>.fromhex(digest_hex)</span><br><span class="line">    signature = hex_to_32byte_chunks(signature_hex)</span><br><span class="line">    valid = wots.verify(digest_bytes,signature)</span><br><span class="line">    <span class="built_in">print</span>(valid)</span><br></pre></td></tr></table></figure>
<p>这个最简单了，它实现了一个 OTS 的验签函数，但是没有给出签名函数。目标是给定一组签名和公钥要求你伪造一组签名可以通过。</p>
<p>我们都知道，OTS 的私钥是不能重用的，这里公钥一样那私钥也肯定一样的。一个简单的想法，我直接令摘要为 <code>ffffffff</code> 那么对于每一组其的签名都是对私钥进行 255 次 hash 操作。但是公钥也是对私钥进行 255 次摘要，那就说明了如果摘要是 <code>ffffffff</code>，那么签名就是公钥了。所以这题其实只给公钥也可以伪造的。</p>
<h1 id="密码系统"><a class="markdownIt-Anchor" href="#密码系统"></a> 密码系统</h1>
<p>这里总共 6 个flag，其中 <code>flag1</code> 做完了才可以做后面的 2、3、4、5，然后全部做完就会送一个 <code>flag6</code>。</p>
<h2 id="1-tsp服务器登录"><a class="markdownIt-Anchor" href="#1-tsp服务器登录"></a> 1-TSP服务器登录</h2>
<p>题目：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> service</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/ecdsa&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/asn1&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/tjfoc/gmsm/sm2&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *LoginService)</span></span> Login(username, authInfo, certStr <span class="type">string</span>) (token <span class="type">string</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 读取用户证书</span></span><br><span class="line">	cert, err := s.CertService.LoadCertificate(certStr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := s.CertService.ValidateCertificate(cert, RootCert); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 校验用户名</span></span><br><span class="line">	<span class="keyword">if</span> cert.Subject.CommonName != username &#123;</span><br><span class="line">		err = errors.New(<span class="string">&quot;username is not valid&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判断是否挑战成功（随机字符串的签名能否用证书中的公钥验签过）</span></span><br><span class="line">	ecdsaPubKey, ok := cert.PublicKey.(*ecdsa.PublicKey)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;public key in cert is not sm2&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	sm2PubKey := sm2.PublicKey&#123;</span><br><span class="line">		Curve: ecdsaPubKey.Curve,</span><br><span class="line">		X:     ecdsaPubKey.X,</span><br><span class="line">		Y:     ecdsaPubKey.Y,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从 authInfo 中提取 randomStr 和 signature</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(authInfo) != <span class="number">256</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;鉴别信息格式有误&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	randomStr := authInfo[<span class="number">0</span>:<span class="number">128</span>]</span><br><span class="line">	signature := authInfo[<span class="number">128</span>:]</span><br><span class="line"></span><br><span class="line">	_, err = ValidateSignature(randomStr, signature, &amp;sm2PubKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s.generateToken(username)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证签名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ValidateSignature</span><span class="params">(messageHex, signatureHex <span class="type">string</span>, publicKey *sm2.PublicKey)</span></span> (<span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	msg, err := hex.DecodeString(messageHex)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, errors.New(<span class="string">&quot;挑战值格式有误&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(signatureHex) != <span class="number">128</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, errors.New(<span class="string">&quot;签名值格式有误&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	r, ok := big.NewInt(<span class="number">0</span>).SetString(signatureHex[:<span class="number">64</span>], <span class="number">16</span>)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, errors.New(<span class="string">&quot;签名值格式有误&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	s, ok := big.NewInt(<span class="number">0</span>).SetString(signatureHex[<span class="number">64</span>:], <span class="number">16</span>)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, errors.New(<span class="string">&quot;签名值格式有误&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	signature, err := asn1.Marshal(<span class="keyword">struct</span>&#123; R, S *big.Int &#125;&#123;r, s&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, errors.New(<span class="string">&quot;签名值格式有误&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	isValid := publicKey.Verify(msg, signature)</span><br><span class="line">	<span class="keyword">if</span> isValid &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;签名无效&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>使用智能密码钥匙登录TSP服务器的历史抓包数据.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">智能密码钥匙抓包数据分析备忘：如果一条指令未全部发送完数据，下一条指令继续发送数据时第一个字节为标志位。</span><br><span class="line"></span><br><span class="line">Bus Hound 6.00 capture on Windows Vista (x64). Complements of www.perisoft.net</span><br><span class="line"></span><br><span class="line">  Device - Device ID (followed by the endpoint for USB devices)</span><br><span class="line">            (29) USB Input Device</span><br><span class="line">  Phase  - Phase Type</span><br><span class="line">            CTL   USB control transfer       </span><br><span class="line">            IN    Data in transfer           </span><br><span class="line">            OUT   Data out transfer          </span><br><span class="line">  Data   - Hex dump of the data transferred</span><br><span class="line">  Descr  - Description of the phase</span><br><span class="line">  Cmd... - Position in the captured data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Device  Phase  Data                                                                                                    Description                       Cmd.Phase.Ofs(rep)</span><br><span class="line">------  -----  ------------------------------------------------------------------------------------------------------  --------------------------------  ------------------</span><br><span class="line">  29.0  CTL    21 0a 00 00  00 00 00 00                                                                                SET IDLE                                 1.1.0(2)     </span><br><span class="line">  29.1  OUT    de fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 0a 00 00  01 12 00 07  c0 0a 00 80  00 00 80 00  ................................         3.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................         3.1.32       </span><br><span class="line">  29.1  IN     bf aa aa 85  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  01 12 00 82  67 6d 33 30  30 30 00 00  ........................gm3000..         4.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................         4.1.32       </span><br><span class="line">  29.1  IN     3f 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ?...............................         5.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................         5.1.32       </span><br><span class="line">  29.1  IN     5b 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 90 00  00 00 00 00  [...............................         6.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................         6.1.32       </span><br><span class="line">  29.1  OUT    de fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 0a 00 00  02 12 00 07  80 04 01 00  00 00 00 00  ................................         7.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................         7.1.32       </span><br><span class="line">  29.1  IN     bf aa aa 49  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  02 12 00 46  47 4d 33 30  30 30 00 00  ...I...................FGM3000..         8.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  37 39 37 33  33 30 41 31  ........................797330A1         8.1.32       </span><br><span class="line">  29.1  IN     5e 35 30 46  33 36 41 45  45 38 39 33  39 43 42 36  41 36 39 36  39 41 30 44  00 05 00 02  17 90 00 00  ^50F36AEE8939CB6A6969A0D........         9.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................         9.1.32       </span><br><span class="line">  29.1  OUT    de fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 0a 00 00  03 12 00 07  80 04 00 00  00 00 00 00  ................................        10.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        10.1.32       </span><br><span class="line">  29.1  IN     bf aa aa 25  01 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  03 12 01 22  01 00 01 00  4c 6f 6e 67  ...%...................&quot;....Long        11.1.0        </span><br><span class="line">               6d 61 69 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  mai.............................        11.1.32       </span><br><span class="line">  29.1  IN     3f 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 4c 6f 6e  ?............................Lon        12.1.0        </span><br><span class="line">               67 6d 61 69  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  gmai............................        12.1.32       </span><br><span class="line">  29.1  IN     3f 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 47 4d  ?.............................GM        13.1.0        </span><br><span class="line">               33 30 30 30  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 37 39  3000..........................79        13.1.32       </span><br><span class="line">  29.1  IN     3f 37 33 33  30 41 31 35  30 46 33 36  41 45 45 38  39 33 39 43  42 36 41 36  39 36 39 41  30 44 00 05  ?7330A150F36AEE8939CB6A6969A0D..        14.1.0        </span><br><span class="line">               00 02 17 07  07 00 00 00  07 03 00 07  00 00 00 01  04 00 00 00  02 00 00 00  01 ee 80 04  20 00 01 00  ............................ ...        14.1.32       </span><br><span class="line">  29.1  IN     7d 02 00 00  10 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        15.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  90 00 00 00  ................................        15.1.32       </span><br><span class="line">  29.1  OUT    de fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 0a 00 00  04 12 00 07  80 22 00 00  00 00 00 00  .........................&quot;......        16.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        16.1.32       </span><br><span class="line">  29.1  IN     e4 aa aa 10  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  04 12 00 0d  47 4d 33 30  30 30 52 53  ........................GM3000RS        17.1.0        </span><br><span class="line">               41 00 00 90  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  A...............................        17.1.32       </span><br><span class="line">  29.1  OUT    e9 fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 15 00 00  05 12 00 12  80 26 00 00  00 00 09 47  .........................&amp;.....G        18.1.0        </span><br><span class="line">               4d 33 30 30  30 52 53 41  00 0a 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  M3000RSA........................        18.1.32       </span><br><span class="line">  29.1  IN     e3 aa aa 0f  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  05 12 00 0c  ff 00 00 00  00 00 00 00  ................................        19.1.0        </span><br><span class="line">               10 00 90 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        19.1.32       </span><br><span class="line">  29.1  OUT    de fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 0a 00 00  06 12 00 07  80 50 00 00  00 00 08 00  .........................P......        20.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        20.1.32       </span><br><span class="line">  29.1  IN     e1 aa aa 0d  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  06 12 00 0a  b1 22 84 f7  e6 0f b4 5c  .........................&quot;.....\        21.1.0        </span><br><span class="line">               90 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        21.1.32       </span><br><span class="line">  29.1  OUT    f0 fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 1c 00 00  07 12 00 19  80 18 00 01  00 00 12 10  ................................        22.1.0        </span><br><span class="line">               00 cf 87 86  2f eb 06 65  9e d8 8a 10  61 09 e7 42  f0 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ..../..e....a..B................        22.1.32       </span><br><span class="line">  29.1  IN     d9 aa aa 05  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  07 12 00 02  90 00 00 00  00 00 00 00  ................................        23.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        23.1.32       </span><br><span class="line">  29.1  OUT    e0 fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 0c 00 00  08 12 00 09  80 46 00 00  00 00 02 10  .........................F......        24.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        24.1.32       </span><br><span class="line">  29.1  IN     eb aa aa 17  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  08 12 00 14  44 65 66 61  75 6c 74 43  ........................DefaultC        25.1.0        </span><br><span class="line">               6f 6e 74 61  69 6e 65 72  00 00 90 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ontainer........................        25.1.32       </span><br><span class="line">  29.1  OUT    f2 fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 1e 00 00  09 12 00 1b  80 42 00 00  00 00 12 10  .........................B......        26.1.0        </span><br><span class="line">               00 44 65 66  61 75 6c 74  43 6f 6e 74  61 69 6e 65  72 00 02 00  00 00 00 00  00 00 00 00  00 00 00 00  .DefaultContainer...............        26.1.32       </span><br><span class="line">  29.1  IN     db aa aa 07  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  09 12 00 04  30 01 90 00  00 00 00 00  ........................0.......        27.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        27.1.32       </span><br><span class="line">  29.1  OUT    db fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 07 00 00  0a 12 00 04  c0 52 00 00  00 00 00 00  .........................R......        28.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        28.1.32       </span><br><span class="line">  29.1  IN     d9 aa aa 05  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  0a 12 00 02  90 00 00 00  00 00 00 00  ................................        29.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        29.1.32       </span><br><span class="line">  29.1  OUT    e4 fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 10 00 00  0b 12 00 0d  80 4e 01 00  00 00 04 10  .........................N......        30.1.0        </span><br><span class="line">               00 30 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  .0..............................        30.1.32       </span><br><span class="line">  29.1  IN     bf aa aa f5  01 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  0b 12 01 f2  00 00 03 82  2d 2d 2d 2d  ............................----        31.1.0        </span><br><span class="line">               2d 42 45 47  49 4e 20 43  45 52 54 49  46 49 43 41  54 45 2d 2d  2d 2d 2d 0d  0a 4d 49 49  43 58 7a 43  -BEGIN CERTIFICATE-----..MIICXzC        31.1.32       </span><br><span class="line">  29.1  IN     3f 43 41 67  57 67 41 77  49 42 41 67  49 49 52 64  4f 6f 49 6f  58 58 64 4d  41 77 43 67  59 49 4b 6f  ?CAgWgAwIBAgIIRdOoIoXXdMAwCgYIKo        32.1.0        </span><br><span class="line">               45 63 7a 31  55 42 67 33  55 77 4e 6a  45 4c 4d 41  6b 47 41 31  55 45 42 68  4d 43 0d 0a  51 30 34 78  Ecz1UBg3UwNjELMAkGA1UEBhMC..Q04x        32.1.32       </span><br><span class="line">  29.1  IN     3f 45 7a 41  52 42 67 4e  56 42 41 6f  54 43 6c 4e  6f 59 57 35  6e 54 57 6c  43 5a 57 6b  78 45 6a 41  ?EzARBgNVBAoTClNoYW5nTWlCZWkxEjA        33.1.0        </span><br><span class="line">               51 42 67 4e  56 42 41 4d  54 43 56 4e  6f 59 57 35  6e 54 57 6c  44 51 54 41  65 46 77 30  79 0d 0a 4e  QBgNVBAMTCVNoYW5nTWlDQTAeFw0y..N        33.1.32       </span><br><span class="line">  29.1  IN     3f 54 41 32  4d 44 6b 77  4d 6a 55 77  4e 44 6c 61  46 77 30 30  4e 54 45 77  4d 54 41 78  4d 6a 41 78  ?TA2MDkwMjUwNDlaFw00NTEwMTAxMjAx        34.1.0        </span><br><span class="line">               4d 44 46 61  4d 46 55 78  45 7a 41 52  42 67 4e 56  42 41 6f 54  43 6c 4e 6f  59 57 35 6e  54 57 6c 43  MDFaMFUxEzARBgNVBAoTClNoYW5nTWlC        34.1.32       </span><br><span class="line">  29.1  IN     3f 0d 0a 5a  57 6b 78 46  7a 41 56 42  67 4e 56 42  41 73 54 44  6c 4e 6f 59  57 35 6e 54  57 6c 43 5a  ?..ZWkxFzAVBgNVBAsTDlNoYW5nTWlCZ        35.1.0        </span><br><span class="line">               57 6b 79 4d  44 49 31 4d  52 67 77 46  67 59 44 56  51 51 44 45  77 39 7a 61  47 46 75 5a  32 31 70 59  WkyMDI1MRgwFgYDVQQDEw9zaGFuZ21pY        35.1.32       </span><br><span class="line">  29.1  IN     3f 6d 56 70  0d 0a 59 57  52 74 61 57  34 78 43 7a  41 4a 42 67  4e 56 42 41  59 54 41 6b  4e 4f 4d 46  ?mVp..YWRtaW4xCzAJBgNVBAYTAkNOMF        36.1.0        </span><br><span class="line">               6b 77 45 77  59 48 4b 6f  5a 49 7a 6a  30 43 41 51  59 49 4b 6f  45 63 7a 31  55 42 67 69  30 44 51 67  kwEwYHKoZIzj0CAQYIKoEcz1UBgi0DQg        36.1.32       </span><br><span class="line">  29.1  IN     3f 41 45 37  2b 74 35 0d  0a 34 51 6f  78 4c 50 48  49 68 78 6b  64 41 54 65  6d 62 45 66  69 52 62 2f  ?AE7+t5..4QoxLPHIhxkdATembEfiRb/        37.1.0        </span><br><span class="line">               2f 4b 38 48  42 6e 39 4c  34 72 4a 71  56 4d 62 38  64 47 4e 32  51 39 51 38  41 52 75 55  53 75 56 37  /K8HBn9L4rJqVMb8dGN2Q9Q8ARuUSuV7        37.1.32       </span><br><span class="line">  29.1  IN     3f 71 33 6f  5a 50 78 4a  34 77 0d 0a  73 6b 73 39  56 45 76 55  2f 41 68 6b  39 30 43 79  36 61 4f 42  ?q3oZPxJ4w..sks9VEvU/Ahk90Cy6aOB        38.1.0        </span><br><span class="line">               33 54 43 42  32 6a 41 4f  42 67 4e 56  48 51 38 42  41 66 38 45  42 41 4d 43  41 34 67 77  48 51 59 44  3TCB2jAOBgNVHQ8BAf8EBAMCA4gwHQYD        38.1.32       </span><br><span class="line">  29.1  IN     51 56 52 30  6c 42 42 59  77 46 41 59  49 0d 0a 4b  6a 9e 00 00  00 00 00 00  00 00 00 00  00 00 00 00  QVR0lBBYwFAYI..Kj...............        39.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        39.1.32       </span><br><span class="line">  29.1  OUT    e4 fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 10 00 00  0c 12 00 0d  80 4e 01 00  00 00 04 10  .........................N......        40.1.0        </span><br><span class="line">               00 30 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  .0..............................        40.1.32       </span><br><span class="line">  29.1  IN     bf aa aa 9b  01 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  0c 12 01 98  77 59 42 42  51 55 48 41  ........................wYBBQUHA        41.1.0        </span><br><span class="line">               77 49 47 43  43 73 47 41  51 55 46 42  77 4d 42 4d  41 38 47 41  31 55 64 44  67 51 49 42  41 59 42 41  wIGCCsGAQUFBwMBMA8GA1UdDgQIBAYBA        41.1.32       </span><br><span class="line">  29.1  IN     3f 67 4d 45  42 51 59 77  44 77 59 44  56 52 30 6a  42 41 67 77  42 6f 41 45  0d 0a 41 51  49 44 42 44  ?gMEBQYwDwYDVR0jBAgwBoAE..AQIDBD        42.1.0        </span><br><span class="line">               41 75 42 67  4e 56 48 52  45 45 4a 7a  41 6c 67 51  74 6e 61 58  52 41 5a 32  6c 30 4c 6d  4e 76 62 59  AuBgNVHREEJzAlgQtnaXRAZ2l0LmNvbY        42.1.32       </span><br><span class="line">  29.1  IN     3f 63 45 66  77 41 41 41  59 63 51 49  41 46 49 59  41 41 41 49  41 45 41 41  41 41 41 0d  0a 41 41 41  ?cEfwAAAYcQIAFIYAAAIAEAAAAA..AAA        43.1.0        </span><br><span class="line">               41 61 44 42  58 42 67 4e  56 48 52 38  45 55 44 42  4f 4d 43 57  67 49 36 41  68 68 68 39  6f 64 48 52  AaDBXBgNVHR8EUDBOMCWgI6Ahhh9odHR        43.1.32       </span><br><span class="line">  29.1  IN     3f 77 4f 69  38 76 59 33  4a 73 4d 53  35 6c 65 47  46 74 63 47  78 6c 4c 6d  4e 76 62 53  39 6a 0d 0a  ?wOi8vY3JsMS5leGFtcGxlLmNvbS9j..        44.1.0        </span><br><span class="line">               59 54 45 75  59 33 4a 73  4d 43 57 67  49 36 41 68  68 68 39 6f  64 48 52 77  4f 69 38 76  59 33 4a 73  YTEuY3JsMCWgI6Ahhh9odHRwOi8vY3Js        44.1.32       </span><br><span class="line">  29.1  IN     3f 4d 69 35  6c 65 47 46  74 63 47 78  6c 4c 6d 4e  76 62 53 39  6a 59 54 45  75 59 33 4a  73 4d 41 6f  ?Mi5leGFtcGxlLmNvbS9jYTEuY3JsMAo        45.1.0        </span><br><span class="line">               47 0d 0a 43  43 71 42 48  4d 39 56 41  59 4e 31 41  30 67 41 4d  45 55 43 49  41 64 2b 6d  6d 50 75 4d  G..CCqBHM9VAYN1A0gAMEUCIAd+mmPuM        45.1.32       </span><br><span class="line">  29.1  IN     3f 2f 43 79  2b 2f 44 31  43 73 38 62  57 47 56 31  65 39 6d 76  72 63 4d 36  52 5a 39 4e  48 78 57 47  ?/Cy+/D1Cs8bWGV1e9mvrcM6RZ9NHxWG        46.1.0        </span><br><span class="line">               48 50 6c 74  0d 0a 41 69  45 41 6a 76  34 31 34 77  45 6d 6c 5a  64 33 50 55  37 41 6b 59  61 4f 35 44  HPlt..AiEAjv414wEmlZd3PU7AkYaO5D        46.1.32       </span><br><span class="line">  29.1  IN     75 7a 36 47  62 56 6f 58  78 77 6a 30  52 4f 52 39  4f 48 2b 44  76 77 3d 0d  0a 2d 2d 2d  2d 2d 45 4e  uz6GbVoXxwj0ROR9OH+Dvw=..-----EN        47.1.0        </span><br><span class="line">               44 20 43 45  52 54 49 46  49 43 41 54  45 2d 2d 2d  2d 2d 0d 0a  90 00 00 00  00 00 00 00  00 00 00 00  D CERTIFICATE-----..............        47.1.32       </span><br><span class="line">  29.1  OUT    e4 fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 10 00 00  0d 12 00 0d  80 88 01 00  00 00 04 10  ................................        48.1.0        </span><br><span class="line">               00 30 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  .0..............................        48.1.32       </span><br><span class="line">  29.1  IN     bf aa aa 49  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  0d 12 00 46  00 00 01 00  ef eb 79 e1  ...I...................F......y.        49.1.0        </span><br><span class="line">               0a 31 2c f1  c8 87 19 1d  01 37 a6 6c  47 e2 45 bf  ff 2b c1 c1  9f d2 f8 ac  9a 95 31 bf  1d 18 dd 90  .1,......7.lG.E..+........1.....        49.1.32       </span><br><span class="line">  29.1  IN     5e f5 0f 00  46 e5 12 b9  5e ea de 86  4f c4 9e 30  b2 4b 3d 54  4b d4 fc 08  64 f7 40 b2  e9 90 00 00  ^...F...^...O..0.K=TK...d.@.....        50.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        50.1.32       </span><br><span class="line">  29.1  OUT    de fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 0a 00 00  0e 12 00 07  80 04 00 00  00 00 00 00  ................................        51.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        51.1.32       </span><br><span class="line">  29.1  IN     bf aa aa 25  01 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  0e 12 01 22  01 00 01 00  4c 6f 6e 67  ...%...................&quot;....Long        52.1.0        </span><br><span class="line">               6d 61 69 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  mai.............................        52.1.32       </span><br><span class="line">  29.1  IN     3f 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 4c 6f 6e  ?............................Lon        53.1.0        </span><br><span class="line">               67 6d 61 69  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  gmai............................        53.1.32       </span><br><span class="line">  29.1  IN     3f 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 47 4d  ?.............................GM        54.1.0        </span><br><span class="line">               33 30 30 30  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 37 39  3000..........................79        54.1.32       </span><br><span class="line">  29.1  IN     3f 37 33 33  30 41 31 35  30 46 33 36  41 45 45 38  39 33 39 43  42 36 41 36  39 36 39 41  30 44 00 05  ?7330A150F36AEE8939CB6A6969A0D..        55.1.0        </span><br><span class="line">               00 02 17 07  07 00 00 00  07 03 00 07  00 00 00 01  04 00 00 00  02 00 00 00  01 ee 80 04  20 00 01 00  ............................ ...        55.1.32       </span><br><span class="line">  29.1  IN     7d 02 00 00  10 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        56.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  90 00 00 00  ................................        56.1.32       </span><br><span class="line">  29.1  OUT    bf fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 62 00 00  0f 12 00 5f  80 b4 00 01  00 00 58 00  .................b....._......X.        57.1.0        </span><br><span class="line">               00 01 00 ef  eb 79 e1 0a  31 2c f1 c8  87 19 1d 01  37 a6 6c 47  e2 45 bf ff  2b c1 c1 9f  d2 f8 ac 9a  .....y..1,......7.lG.E..+.......        57.1.32       </span><br><span class="line">  29.1  OUT    77 95 31 bf  1d 18 dd 90  f5 0f 00 46  e5 12 b9 5e  ea de 86 4f  c4 9e 30 b2  4b 3d 54 4b  d4 fc 08 64  w.1........F...^...O..0.K=TK...d        58.1.0        </span><br><span class="line">               f7 40 b2 e9  00 00 00 10  31 32 33 34  35 36 37 38  31 32 33 34  35 36 37 38  00 00 00 00  00 00 00 00  .@......1234567812345678........        58.1.32       </span><br><span class="line">  29.1  IN     d9 aa aa 05  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  0f 12 00 02  90 00 00 00  00 00 00 00  ................................        59.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        59.1.32       </span><br><span class="line">  29.1  OUT    bf fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 4c 00 00  10 12 00 49  80 b6 00 00  00 00 40 61  .................L.....I......@a        60.1.0        </span><br><span class="line">               73 64 6b 66  68 6a 32 33  73 6c 61 6a  64 66 39 32  33 61 66 64  73 6c 6a 31  33 6b 7a 48  66 31 72 6f  sdkfhj23slajdf923afdslj13kzHf1ro        60.1.32       </span><br><span class="line">  29.1  OUT    61 69 75 6c  73 61 64 6a  66 61 6c 73  31 32 73 6c  64 6a 30 75  32 33 72 32  33 61 6e 73  76 30 6a 32  aiulsadjfals12sldj0u23r23ansv0j2        61.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        61.1.32       </span><br><span class="line">  29.1  IN     f9 aa aa 25  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  10 12 00 22  b0 e5 68 94  2a 01 d2 2d  ...%...................&quot;..h.*..-        62.1.0        </span><br><span class="line">               2c 7e e4 4c  85 e2 2e 95  f1 78 cd 1f  86 a9 78 ca  bc 96 1b a0  24 d8 60 71  90 00 00 00  00 00 00 00  ,..L.....x....x.....$.`q........        62.1.32       </span><br><span class="line">  29.1  OUT    bf fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 2e 00 00  11 12 00 2b  80 74 02 00  00 00 24 10  .......................+.t....$.        63.1.0        </span><br><span class="line">               00 30 01 b0  e5 68 94 2a  01 d2 2d 2c  7e e4 4c 85  e2 2e 95 f1  78 cd 1f 86  a9 78 ca bc  96 1b a0 24  .0...h.*..-,..L.....x....x.....$        63.1.32       </span><br><span class="line">  29.1  OUT    43 d8 60 71  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  C.`q............................        64.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        64.1.32       </span><br><span class="line">  29.1  IN     bf aa aa 49  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  11 12 00 46  00 00 01 00  8e f2 a9 51  ...I...................F.......Q        65.1.0        </span><br><span class="line">               b5 19 4e 0b  5c 98 a6 16  0b d7 9e 02  4b b9 58 58  04 ae dc 97  3a 9f ce 6d  cd e2 17 03  9e 70 c5 42  ..N.\.......K.XX....:..m.....p.B        65.1.32       </span><br><span class="line">  29.1  IN     5e 83 63 8b  6f ba 3c 00  3b d9 17 24  47 ce 4f aa  4c 0e 8b b7  89 57 54 ac  7b 0e 55 d0  44 90 00 00  ^.c.o.&lt;.;..$G.O.L....WT...U.D...        66.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        66.1.32       </span><br><span class="line">  29.1  OUT    e2 fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 0e 00 00  12 12 00 0b  80 44 00 00  00 00 04 10  .........................D......        67.1.0        </span><br><span class="line">               00 30 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  .0..............................        67.1.32       </span><br><span class="line">  29.1  IN     d9 aa aa 05  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  12 12 00 02  90 00 00 00  00 00 00 00  ................................        68.1.0        </span><br><span class="line">               00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        68.1.32       </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其实题目目标很简单，我们只要把证书、签名值和 hash 摘要提取出来就好了。</p>
<p>根据 <strong>GB-T 0017-2023</strong>，提证书的话，我们先找 OUT 中 <code>80 4e</code>  字段，然后把下面的值都提取出来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">29.1  IN     bf aa aa f5  01 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  0b 12 01 f2  00 00 03 82  2d 2d 2d 2d  ............................----        31.1.0        </span><br><span class="line">              2d 42 45 47  49 4e 20 43  45 52 54 49  46 49 43 41  54 45 2d 2d  2d 2d 2d 0d  0a 4d 49 49  43 58 7a 43  -BEGIN CERTIFICATE-----..MIICXzC        31.1.32       </span><br><span class="line"> 29.1  IN     3f 43 41 67  57 67 41 77  49 42 41 67  49 49 52 64  4f 6f 49 6f  58 58 64 4d  41 77 43 67  59 49 4b 6f  ?CAgWgAwIBAgIIRdOoIoXXdMAwCgYIKo        32.1.0        </span><br><span class="line">              45 63 7a 31  55 42 67 33  55 77 4e 6a  45 4c 4d 41  6b 47 41 31  55 45 42 68  4d 43 0d 0a  51 30 34 78  Ecz1UBg3UwNjELMAkGA1UEBhMC..Q04x        32.1.32       </span><br><span class="line"> 29.1  IN     3f 45 7a 41  52 42 67 4e  56 42 41 6f  54 43 6c 4e  6f 59 57 35  6e 54 57 6c  43 5a 57 6b  78 45 6a 41  ?EzARBgNVBAoTClNoYW5nTWlCZWkxEjA        33.1.0        </span><br><span class="line">              51 42 67 4e  56 42 41 4d  54 43 56 4e  6f 59 57 35  6e 54 57 6c  44 51 54 41  65 46 77 30  79 0d 0a 4e  QBgNVBAMTCVNoYW5nTWlDQTAeFw0y..N        33.1.32       </span><br><span class="line"> 29.1  IN     3f 54 41 32  4d 44 6b 77  4d 6a 55 77  4e 44 6c 61  46 77 30 30  4e 54 45 77  4d 54 41 78  4d 6a 41 78  ?TA2MDkwMjUwNDlaFw00NTEwMTAxMjAx        34.1.0        </span><br><span class="line">              4d 44 46 61  4d 46 55 78  45 7a 41 52  42 67 4e 56  42 41 6f 54  43 6c 4e 6f  59 57 35 6e  54 57 6c 43  MDFaMFUxEzARBgNVBAoTClNoYW5nTWlC        34.1.32       </span><br><span class="line"> 29.1  IN     3f 0d 0a 5a  57 6b 78 46  7a 41 56 42  67 4e 56 42  41 73 54 44  6c 4e 6f 59  57 35 6e 54  57 6c 43 5a  ?..ZWkxFzAVBgNVBAsTDlNoYW5nTWlCZ        35.1.0        </span><br><span class="line">              57 6b 79 4d  44 49 31 4d  52 67 77 46  67 59 44 56  51 51 44 45  77 39 7a 61  47 46 75 5a  32 31 70 59  WkyMDI1MRgwFgYDVQQDEw9zaGFuZ21pY        35.1.32       </span><br><span class="line"> 29.1  IN     3f 6d 56 70  0d 0a 59 57  52 74 61 57  34 78 43 7a  41 4a 42 67  4e 56 42 41  59 54 41 6b  4e 4f 4d 46  ?mVp..YWRtaW4xCzAJBgNVBAYTAkNOMF        36.1.0        </span><br><span class="line">              6b 77 45 77  59 48 4b 6f  5a 49 7a 6a  30 43 41 51  59 49 4b 6f  45 63 7a 31  55 42 67 69  30 44 51 67  kwEwYHKoZIzj0CAQYIKoEcz1UBgi0DQg        36.1.32       </span><br><span class="line"> 29.1  IN     3f 41 45 37  2b 74 35 0d  0a 34 51 6f  78 4c 50 48  49 68 78 6b  64 41 54 65  6d 62 45 66  69 52 62 2f  ?AE7+t5..4QoxLPHIhxkdATembEfiRb/        37.1.0        </span><br><span class="line">              2f 4b 38 48  42 6e 39 4c  34 72 4a 71  56 4d 62 38  64 47 4e 32  51 39 51 38  41 52 75 55  53 75 56 37  /K8HBn9L4rJqVMb8dGN2Q9Q8ARuUSuV7        37.1.32       </span><br><span class="line"> 29.1  IN     3f 71 33 6f  5a 50 78 4a  34 77 0d 0a  73 6b 73 39  56 45 76 55  2f 41 68 6b  39 30 43 79  36 61 4f 42  ?q3oZPxJ4w..sks9VEvU/Ahk90Cy6aOB        38.1.0        </span><br><span class="line">              33 54 43 42  32 6a 41 4f  42 67 4e 56  48 51 38 42  41 66 38 45  42 41 4d 43  41 34 67 77  48 51 59 44  3TCB2jAOBgNVHQ8BAf8EBAMCA4gwHQYD        38.1.32       </span><br><span class="line"> 29.1  IN     51 56 52 30  6c 42 42 59  77 46 41 59  49 0d 0a 4b  6a 9e 00 00  00 00 00 00  00 00 00 00  00 00 00 00  QVR0lBBYwFAYI..Kj...............        39.1.0        </span><br><span class="line">              00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        39.1.32       </span><br><span class="line"> 29.1  OUT    e4 fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 10 00 00  0c 12 00 0d  80 4e 01 00  00 00 04 10  .........................N......        40.1.0        </span><br><span class="line">              00 30 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  .0..............................        40.1.32       </span><br><span class="line"> 29.1  IN     bf aa aa 9b  01 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  0c 12 01 98  77 59 42 42  51 55 48 41  ........................wYBBQUHA        41.1.0        </span><br><span class="line">              77 49 47 43  43 73 47 41  51 55 46 42  77 4d 42 4d  41 38 47 41  31 55 64 44  67 51 49 42  41 59 42 41  wIGCCsGAQUFBwMBMA8GA1UdDgQIBAYBA        41.1.32       </span><br><span class="line"> 29.1  IN     3f 67 4d 45  42 51 59 77  44 77 59 44  56 52 30 6a  42 41 67 77  42 6f 41 45  0d 0a 41 51  49 44 42 44  ?gMEBQYwDwYDVR0jBAgwBoAE..AQIDBD        42.1.0        </span><br><span class="line">              41 75 42 67  4e 56 48 52  45 45 4a 7a  41 6c 67 51  74 6e 61 58  52 41 5a 32  6c 30 4c 6d  4e 76 62 59  AuBgNVHREEJzAlgQtnaXRAZ2l0LmNvbY        42.1.32       </span><br><span class="line"> 29.1  IN     3f 63 45 66  77 41 41 41  59 63 51 49  41 46 49 59  41 41 41 49  41 45 41 41  41 41 41 0d  0a 41 41 41  ?cEfwAAAYcQIAFIYAAAIAEAAAAA..AAA        43.1.0        </span><br><span class="line">              41 61 44 42  58 42 67 4e  56 48 52 38  45 55 44 42  4f 4d 43 57  67 49 36 41  68 68 68 39  6f 64 48 52  AaDBXBgNVHR8EUDBOMCWgI6Ahhh9odHR        43.1.32       </span><br><span class="line"> 29.1  IN     3f 77 4f 69  38 76 59 33  4a 73 4d 53  35 6c 65 47  46 74 63 47  78 6c 4c 6d  4e 76 62 53  39 6a 0d 0a  ?wOi8vY3JsMS5leGFtcGxlLmNvbS9j..        44.1.0        </span><br><span class="line">              59 54 45 75  59 33 4a 73  4d 43 57 67  49 36 41 68  68 68 39 6f  64 48 52 77  4f 69 38 76  59 33 4a 73  YTEuY3JsMCWgI6Ahhh9odHRwOi8vY3Js        44.1.32       </span><br><span class="line"> 29.1  IN     3f 4d 69 35  6c 65 47 46  74 63 47 78  6c 4c 6d 4e  76 62 53 39  6a 59 54 45  75 59 33 4a  73 4d 41 6f  ?Mi5leGFtcGxlLmNvbS9jYTEuY3JsMAo        45.1.0        </span><br><span class="line">              47 0d 0a 43  43 71 42 48  4d 39 56 41  59 4e 31 41  30 67 41 4d  45 55 43 49  41 64 2b 6d  6d 50 75 4d  G..CCqBHM9VAYN1A0gAMEUCIAd+mmPuM        45.1.32       </span><br><span class="line"> 29.1  IN     3f 2f 43 79  2b 2f 44 31  43 73 38 62  57 47 56 31  65 39 6d 76  72 63 4d 36  52 5a 39 4e  48 78 57 47  ?/Cy+/D1Cs8bWGV1e9mvrcM6RZ9NHxWG        46.1.0        </span><br><span class="line">              48 50 6c 74  0d 0a 41 69  45 41 6a 76  34 31 34 77  45 6d 6c 5a  64 33 50 55  37 41 6b 59  61 4f 35 44  HPlt..AiEAjv414wEmlZd3PU7AkYaO5D        46.1.32       </span><br><span class="line"> 29.1  IN     75 7a 36 47  62 56 6f 58  78 77 6a 30  52 4f 52 39  4f 48 2b 44  76 77 3d 0d  0a 2d 2d 2d  2d 2d 45 4e  uz6GbVoXxwj0ROR9OH+Dvw=..-----EN        47.1.0        </span><br><span class="line">              44 20 43 45  52 54 49 46  49 43 41 54  45 2d 2d 2d  2d 2d 0d 0a  90 00 00 00  00 00 00 00  00 00 00 00  D CERTIFICATE-----..............        47.1.32     </span><br></pre></td></tr></table></figure>
<p>这里注意对于连续的 IN，从第二个开始第一个字符是多余的要删去。然后我们从第一行的倒数第 8 个字节符开始看， <code>00 00 03 82</code>  表示证书长度，后面开始才是证书。然后在第一个连续的 IN 的末尾有一个 <code>6a 9e</code> 表示证书还没有传完，那我们就要往下接着看，下面那个 OUT 不用管，然后继续从倒数第 8 个字节开始才是证书，最后末尾是 <code>90 00</code> 表示证书已经传完了。</p>
<p>然后找 hash 值，找 <code>80 b6</code> 字段，可以拿到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">29.1  OUT    bf fe 01 00  00 00 00 00  00 00 00 00  00 00 00 00  00 4c 00 00  10 12 00 49  80 b6 00 00  00 00 40 61  .................L.....I......@a        60.1.0        </span><br><span class="line">              73 64 6b 66  68 6a 32 33  73 6c 61 6a  64 66 39 32  33 61 66 64  73 6c 6a 31  33 6b 7a 48  66 31 72 6f  sdkfhj23slajdf923afdslj13kzHf1ro        60.1.32       </span><br><span class="line"> 29.1  OUT    61 69 75 6c  73 61 64 6a  66 61 6c 73  31 32 73 6c  64 6a 30 75  32 33 72 32  33 61 6e 73  76 30 6a 32  aiulsadjfals12sldj0u23r23ansv0j2        61.1.0        </span><br><span class="line">              00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        61.1.32       </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后后面就是 hash 值了，直接提取就好了，注意第二个 OUT的第一个字节要删去</p>
<p>最后就是取签名值，还是 <code>80 74</code> 字段，不过在后面的 IN 里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">29.1  IN     bf aa aa 49  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  11 12 00 46  00 00 01 00  8e f2 a9 51  ...I...................F.......Q        65.1.0        </span><br><span class="line">             b5 19 4e 0b  5c 98 a6 16  0b d7 9e 02  4b b9 58 58  04 ae dc 97  3a 9f ce 6d  cd e2 17 03  9e 70 c5 42  ..N.\.......K.XX....:..m.....p.B        65.1.32       </span><br><span class="line">29.1  IN     5e 83 63 8b  6f ba 3c 00  3b d9 17 24  47 ce 4f aa  4c 0e 8b b7  89 57 54 ac  7b 0e 55 d0  44 90 00 00  ^.c.o.&lt;.;..$G.O.L....WT...U.D...        66.1.0        </span><br><span class="line">             00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  ................................        66.1.32       </span><br></pre></td></tr></table></figure>
<p>同样的，从倒数第 8 个字节开始，<code>00 00 01 00</code> 表模数的 bit 大小，后面就是签名值了，注意连续的 IN 里第一个字符要删去</p>
<p>最后就能登陆了</p>
<h2 id="2-tsp服务器鉴别app控制端"><a class="markdownIt-Anchor" href="#2-tsp服务器鉴别app控制端"></a> 2-TSP服务器鉴别APP控制端</h2>
<p>题目：</p>
<p>auth_client.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> client</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 日期：2025/5/21</span></span><br><span class="line"><span class="comment">* 用途：TSP 服务器鉴别 APP 控制端身份</span></span><br><span class="line"><span class="comment">* 作者：X</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/elliptic&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/base64&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/tjfoc/gmsm/sm2&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> errZeroParam = errors.New(<span class="string">&quot;zero parameter&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> one = <span class="built_in">new</span>(big.Int).SetInt64(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Point <span class="keyword">struct</span> &#123;</span><br><span class="line">	X, Y *big.Int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">randFieldElement</span><span class="params">(c elliptic.Curve, random io.Reader)</span></span> (k *big.Int, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> random == <span class="literal">nil</span> &#123;</span><br><span class="line">		random = rand.Reader <span class="comment">//If there is no external trusted random source,please use rand.Reader to instead of it.</span></span><br><span class="line">	&#125;</span><br><span class="line">	params := c.Params()</span><br><span class="line">	b := <span class="built_in">make</span>([]<span class="type">byte</span>, params.BitSize/<span class="number">8</span>+<span class="number">8</span>)</span><br><span class="line">	_, err = io.ReadFull(random, b)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	k = <span class="built_in">new</span>(big.Int).SetBytes(b)</span><br><span class="line">	n := <span class="built_in">new</span>(big.Int).Sub(params.N, one)</span><br><span class="line">	k.Mod(k, n)</span><br><span class="line">	k.Add(k, one)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AuthClient <span class="keyword">struct</span> &#123;</span><br><span class="line">	c               elliptic.Curve</span><br><span class="line">	N               *big.Int</span><br><span class="line">	commonPublicKey *sm2.PublicKey</span><br><span class="line">	D1              *big.Int</span><br><span class="line">	random          io.Reader</span><br><span class="line"></span><br><span class="line">	k1 *big.Int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// passwd 为 APP 控制端的登录口令</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ComputeD1</span><span class="params">(passwd <span class="type">string</span>)</span></span> (*big.Int, <span class="type">error</span>) &#123;</span><br><span class="line">	d1Bytes, err := base64.StdEncoding.DecodeString(passwd)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">new</span>(big.Int).SetBytes(d1Bytes), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAuthClient</span><span class="params">(commonPublicKey *sm2.PublicKey, D1 *big.Int, random io.Reader)</span></span> (*AuthClient, <span class="type">error</span>) &#123;</span><br><span class="line">	c := sm2.P256Sm2()</span><br><span class="line">	N := c.Params().N</span><br><span class="line">	<span class="keyword">if</span> N.Sign() == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errZeroParam</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;AuthClient&#123;c: c, N: N, commonPublicKey: commonPublicKey, D1: D1, random: random&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(signer *AuthClient)</span></span> GenerateQ1E(msg, uid []<span class="type">byte</span>) (Q1 *Point, e *big.Int, err <span class="type">error</span>) &#123;</span><br><span class="line">	digest, err := signer.commonPublicKey.Sm3Digest(msg, uid)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	e = <span class="built_in">new</span>(big.Int).SetBytes(digest)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> k1 *big.Int</span><br><span class="line">	k1, err = randFieldElement(signer.c, signer.random)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	signer.k1 = k1</span><br><span class="line">	x1, y1 := signer.c.ScalarBaseMult(k1.Bytes())</span><br><span class="line">	Q1 = &amp;Point&#123;X: x1, Y: y1&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> Q1, e, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(signer *AuthClient)</span></span> GenerateS(r, s2, s3 *big.Int) (s *big.Int, err <span class="type">error</span>) &#123;</span><br><span class="line">	t1 := <span class="built_in">new</span>(big.Int).Mul(signer.D1, signer.k1)</span><br><span class="line">	t1.Mul(t1, s2)</span><br><span class="line">	t2 := <span class="built_in">new</span>(big.Int).Mul(signer.D1, s3)</span><br><span class="line">	t3 := t1.Add(t1, t2)</span><br><span class="line">	s = t3.Sub(t3, r)</span><br><span class="line">	s.Mod(s, signer.N)</span><br><span class="line"></span><br><span class="line">	nMinusR := <span class="built_in">new</span>(big.Int).Sub(signer.N, r)</span><br><span class="line">	<span class="keyword">if</span> s.Sign() != <span class="number">0</span> &amp;&amp; s.Cmp(nMinusR) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> s, <span class="literal">nil</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;invalid s&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>auth_server.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* 日期：2025/5/21</span></span><br><span class="line"><span class="comment">* 用途：TSP 服务器鉴别 APP 控制端身份</span></span><br><span class="line"><span class="comment">* 作者：X</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/elliptic&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/tjfoc/gmsm/sm2&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> errZeroParam = errors.New(<span class="string">&quot;zero parameter&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> one = <span class="built_in">new</span>(big.Int).SetInt64(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Point <span class="keyword">struct</span> &#123;</span><br><span class="line">	X, Y *big.Int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">randFieldElement</span><span class="params">(c elliptic.Curve, random io.Reader)</span></span> (k *big.Int, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> random == <span class="literal">nil</span> &#123;</span><br><span class="line">		random = rand.Reader <span class="comment">//If there is no external trusted random source,please use rand.Reader to instead of it.</span></span><br><span class="line">	&#125;</span><br><span class="line">	params := c.Params()</span><br><span class="line">	b := <span class="built_in">make</span>([]<span class="type">byte</span>, params.BitSize/<span class="number">8</span>+<span class="number">8</span>)</span><br><span class="line">	_, err = io.ReadFull(random, b)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	k = <span class="built_in">new</span>(big.Int).SetBytes(b)</span><br><span class="line">	n := <span class="built_in">new</span>(big.Int).Sub(params.N, one)</span><br><span class="line">	k.Mod(k, n)</span><br><span class="line">	k.Add(k, one)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AuthServer <span class="keyword">struct</span> &#123;</span><br><span class="line">	c               elliptic.Curve</span><br><span class="line">	N               *big.Int</span><br><span class="line">	commonPublicKey *sm2.PublicKey</span><br><span class="line">	D2              *big.Int</span><br><span class="line">	random          io.Reader</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAuthServer</span><span class="params">(commonPublicKey *sm2.PublicKey, D2 *big.Int, random io.Reader)</span></span> (*AuthServer, <span class="type">error</span>) &#123;</span><br><span class="line">	c := sm2.P256Sm2()</span><br><span class="line">	N := c.Params().N</span><br><span class="line">	<span class="keyword">if</span> N.Sign() == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errZeroParam</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;AuthServer&#123;c: c, N: N, commonPublicKey: commonPublicKey, D2: D2, random: random&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(signer *AuthServer)</span></span> GenerateRS2S3(Q1 *Point, e *big.Int) (r, s2, s3 *big.Int, err <span class="type">error</span>) &#123;</span><br><span class="line">	x1, y1 := Q1.X, Q1.Y</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> k2 *big.Int</span><br><span class="line">		k2, err = randFieldElement(signer.c, signer.random)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		x2, y2 := signer.c.ScalarBaseMult(k2.Bytes()) <span class="comment">// k2 * G</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> k3 *big.Int</span><br><span class="line">		k3, err = randFieldElement(signer.c, signer.random)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		tempX, tempY := signer.c.ScalarMult(x1, y1, k3.Bytes())</span><br><span class="line">		x3, _ := signer.c.Add(tempX, tempY, x2, y2)</span><br><span class="line"></span><br><span class="line">		r = <span class="built_in">new</span>(big.Int).Add(x3, e)</span><br><span class="line">		r.Mod(r, signer.N)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> r.Sign() != <span class="number">0</span> &#123;</span><br><span class="line">			s2 = <span class="built_in">new</span>(big.Int).Mul(signer.D2, k3)</span><br><span class="line">			s2.Mod(s2, signer.N)</span><br><span class="line"></span><br><span class="line">			s3 = <span class="built_in">new</span>(big.Int).Add(r, k2)</span><br><span class="line">			s3.Mul(s3, signer.D2)</span><br><span class="line">			s3.Mod(s3, signer.N)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> r, s2, s3, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(signer *AuthServer)</span></span> Verify(msg []<span class="type">byte</span>, uid []<span class="type">byte</span>, r *big.Int, s *big.Int) <span class="type">bool</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> sm2.Sm2Verify(signer.commonPublicKey, msg, uid, r, s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>是一个基于 SM2 的协同签名算法，然后其实就是去年熵密杯最后的协同签名算法流程，完全一样的，这里就不再多做叙述了。</p>
<p>当时没有截图，只能简单讲述一下，就是 APP 客户端会给 TSP 服务器发送 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">Q_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">e</span></span></span></span>。然后 TSP 服务器会生成自己的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo separator="true">,</mo><msub><mi>s</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>s</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">r,s_2,s_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，最后你要点击一个按钮，这样子 TSP 服务器会把这些值发送回 APP 客户端然后计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span></span></span>。我们的目标是计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">d_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>这时候就有个好玩的点了，就是我们要点一个按钮才会传参，那我们可以在这个时候进行抓包重新伪造 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo separator="true">,</mo><msub><mi>s</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>s</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">r,s_2,s_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，我们注意 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span></span></span> 的生成方式</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mo>=</mo><msub><mi>d</mi><mn>1</mn></msub><msub><mi>k</mi><mn>1</mn></msub><msub><mi>s</mi><mn>2</mn></msub><mo>+</mo><msub><mi>d</mi><mn>1</mn></msub><msub><mi>s</mi><mn>3</mn></msub><mo>−</mo><mi>r</mi><mspace></mspace><mspace width="1em"/><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mtext> </mtext><mi>n</mi></mrow><annotation encoding="application/x-tex">s=d_1k_1s_2+d_1s_3-r\mod n
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:1em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">n</span></span></span></span></span></p>
<p>如果我们可以让 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">s_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为 0，那么这个式子只有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">d_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是未知的了。所以我们直接打一个重放攻击，修改 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">s_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为 0 即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">n = <span class="number">0xFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFF7203DF6B21C6052B53BBF40939D54123</span></span><br><span class="line">d = PolynomialRing(Zmod(n), name=<span class="string">&#x27;d&#x27;</span>).gen()</span><br><span class="line"></span><br><span class="line">s = <span class="number">0x8539bcb663238748bfc1fa0f417359d64b46ef6e46abbe7b2cef3f8a4cddc73f</span></span><br><span class="line">r = <span class="number">0x93b5851e2a534f38a3edf7bada4b50f3c2326273117f956677e5f9ca0219cced</span></span><br><span class="line">s2 = <span class="number">0</span></span><br><span class="line">s3 = <span class="number">0x7a3e83db456607b842aa4a37511a155717f9e3fd82120920d8917edaa1f86a11</span></span><br><span class="line">f1 = d * s3 - r - s</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(long_to_bytes(<span class="built_in">int</span>(f1.roots()[<span class="number">0</span>][<span class="number">0</span>]))))</span><br></pre></td></tr></table></figure>
<h2 id="3-目标地点经纬度加密"><a class="markdownIt-Anchor" href="#3-目标地点经纬度加密"></a> 3-目标地点经纬度加密</h2>
<p>题目：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sdf_cryptoapi.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *devHandle = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">void</span> *sessionHandle = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">void</span> *keyHandle = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> encrypt_key_hex[] = <span class="string">&quot;FE61D7ED4A6376AAF13E7D78CB42E645&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">open_session</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打开设备</span></span><br><span class="line">    ret = SDF_OpenDeviceWithPath(<span class="string">&quot;./sdt_hsmcrypt.conf&quot;</span>, &amp;devHandle);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SDF_OpenDeviceWithPath error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打开会话</span></span><br><span class="line">    ret = SDF_OpenSession(devHandle, &amp;sessionHandle);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SDF_OpenSession error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        SDF_CloseDevice(devHandle);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">hex_string_to_char_array</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *hex, <span class="type">unsigned</span> <span class="type">char</span> *out)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> hex_len = <span class="built_in">strlen</span>(hex);</span><br><span class="line">    <span class="keyword">if</span> (hex_len % <span class="number">2</span> != <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 奇数长度报错</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; hex_len; i += <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> byte;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">sscanf</span>(hex + i, <span class="string">&quot;%2X&quot;</span>, &amp;byte) != <span class="number">1</span>) <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// 解析失败</span></span><br><span class="line">        out[i / <span class="number">2</span>] = (<span class="type">unsigned</span> <span class="type">char</span>) byte;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hex_len / <span class="number">2</span>; <span class="comment">// 返回转换后的字节数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">import_key</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> encrypt_key[<span class="number">128</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> key_len = <span class="number">16</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> inner_key_index = <span class="number">1</span>;</span><br><span class="line">    ret = hex_string_to_char_array(encrypt_key_hex, encrypt_key);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hex_string_to_char_array error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = SDF_ImportKeyWithKEK(sessionHandle, SGD_SM4, inner_key_index, encrypt_key, key_len, &amp;keyHandle);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SDF_ImportKeyWithKEK error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    ret = open_session();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open_session error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    ret = import_key();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;import_key error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">close_session</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//关闭会话</span></span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    ret = SDF_CloseSession(sessionHandle);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SDF_CloseSession error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        SDF_CloseDevice(devHandle);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//关闭设备</span></span><br><span class="line">    ret = SDF_CloseDevice(devHandle);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SDF_CloseDevice error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//销毁密钥句柄</span></span><br><span class="line">    ret = SDF_DestroyKey(sessionHandle, keyHandle);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[ts_symm] SDF_DestroyKey error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ret = close_session();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[ts_symm] close_session error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">encrypt_with_sm4_cfb</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *iv, <span class="type">unsigned</span> <span class="type">char</span> *plaintext, <span class="type">unsigned</span> <span class="type">int</span> plaintext_len,</span></span><br><span class="line"><span class="params">                         <span class="type">unsigned</span> <span class="type">char</span> *ciphertext,</span></span><br><span class="line"><span class="params">                         <span class="type">unsigned</span> <span class="type">int</span> *ciphertext_len)</span> &#123;</span><br><span class="line">    <span class="comment">// TODO 此处代码已省略</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *<span class="title function_">transform</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *input, <span class="type">size_t</span> in_len)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (in_len &lt; <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *output = <span class="built_in">malloc</span>(in_len + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (output == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(output, input, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(output + <span class="number">8</span>, input + in_len - <span class="number">8</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(output + <span class="number">8</span> * <span class="number">2</span>, input + <span class="number">8</span>, in_len - <span class="number">8</span> * <span class="number">2</span>);</span><br><span class="line">    output[in_len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *<span class="title function_">pkcs7_padding</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *input, <span class="type">size_t</span> in_len, <span class="type">size_t</span> block_size, <span class="type">size_t</span> *out_len)</span> &#123;</span><br><span class="line">    <span class="comment">// TODO 此处代码已省略</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> hex_table[] = <span class="string">&quot;0123456789ABCDEF&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">char_array_to_hex_string</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *src, <span class="type">size_t</span> len, <span class="type">char</span> *dst)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        dst[<span class="number">2</span> * i] = hex_table[(src[i] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F</span>];</span><br><span class="line">        dst[<span class="number">2</span> * i + <span class="number">1</span>] = hex_table[src[i] &amp; <span class="number">0x0F</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    dst[<span class="number">2</span> * len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加密地理位置经纬度</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">encrypt_geo_location</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *iv, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *location, <span class="type">unsigned</span> <span class="type">int</span> location_len,</span></span><br><span class="line"><span class="params">                         <span class="type">char</span> *ciphertext_hex,</span></span><br><span class="line"><span class="params">                         <span class="type">unsigned</span> <span class="type">int</span> *ciphertext_hex_len)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> buffer[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="comment">// 1. 转换格式</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *transformed_location = transform(location, location_len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 填充</span></span><br><span class="line">    <span class="type">size_t</span> padded_plaintext_len = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *padded_plaintext = pkcs7_padding(transformed_location, location_len, <span class="number">16</span>, &amp;padded_plaintext_len);</span><br><span class="line">    <span class="keyword">if</span> (padded_plaintext == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ret = <span class="number">-1</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;pkcs7_padding failed!&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(transformed_location);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 加密</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> ciphertext_len = <span class="number">0</span>;</span><br><span class="line">    ret = encrypt_with_sm4_cfb(iv, padded_plaintext, padded_plaintext_len, buffer, &amp;ciphertext_len);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;encrypt error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="built_in">free</span>(transformed_location);</span><br><span class="line">        <span class="built_in">free</span>(padded_plaintext);</span><br><span class="line">        <span class="built_in">free</span>(iv);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    char_array_to_hex_string(buffer, ciphertext_len, ciphertext_hex);</span><br><span class="line">    *ciphertext_hex_len = <span class="number">2</span> * ciphertext_len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 清理</span></span><br><span class="line">    <span class="built_in">free</span>(transformed_location);</span><br><span class="line">    <span class="built_in">free</span>(padded_plaintext);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> location[] = <span class="string">&quot;xxxxxxxxxxxxxxxxxxxx&quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> location_len = <span class="keyword">sizeof</span>(location) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ret = init();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;init error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ciphertext_hex[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> ciphertext_hex_len = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> iv[] = &#123;<span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;x&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    ret = encrypt_geo_location(iv, location, location_len, ciphertext_hex, &amp;ciphertext_hex_len);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;encrypt error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;encrypt ok\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ciphertext_hex: %s\n&quot;</span>, (<span class="type">char</span> *) ciphertext_hex);</span><br><span class="line"></span><br><span class="line">    ret = destroy();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;destroy error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后题目给出了一个 sdk 接口，让你自己去编译。</p>
<p>首先要注意一个坑点，在对消息进行加密的时候会先做一个混淆，python 表示为</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">trans</span>(<span class="params">m</span>):</span><br><span class="line">    p1 = m[:<span class="number">8</span>]</span><br><span class="line">    p2 = m[-<span class="number">8</span>:]</span><br><span class="line">    p3 = m[<span class="number">8</span>:-<span class="number">8</span>]</span><br><span class="line">    <span class="keyword">return</span> p1 + p2 + p3</span><br></pre></td></tr></table></figure>
<p>不过这个是可逆的。</p>
<p>然后题目会给出两组明密文，然后要恢复一个目标密文。</p>
<p>不过题目中 IV 是固定的，然后又是 CFB 模式，所以我们可以算出第一组的密钥流恢复目标密文的第一块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> unpad</span><br><span class="line">c1 = <span class="string">&quot;949FBEA9806D720CF8FAC4AF56309A4DDC5554862D8DD597ACD6B41CCA55B8D1&quot;</span></span><br><span class="line">c2 = <span class="string">&quot;949FBFAF806C7507F8F9C4A5543C9D4D260FC54E8492147BA230CCF78F528E9C&quot;</span></span><br><span class="line">c3 = <span class="string">&#x27;949FBFA28061720CF3A1D9FB5863C619BB8769FF8994013B98E0D6968EA7B8E08F9B0E1F44FF6C37A185E9A7892FB831BD6D33EB1F586A35CD500C3B867DA2F7&#x27;</span></span><br><span class="line"></span><br><span class="line">c1 = <span class="built_in">bytes</span>.fromhex(c1)</span><br><span class="line">c3 = <span class="built_in">bytes</span>.fromhex(c3)</span><br><span class="line">m1 = <span class="string">b&quot;(113.8383,34.3784)&quot;</span></span><br><span class="line">m2 = <span class="string">b&quot;(105.9434,37.9543)&quot;</span></span><br><span class="line">key = xor(c1[:<span class="number">16</span>], trans(m1)[:<span class="number">16</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(xor(key, c3[:<span class="number">16</span>]))</span><br></pre></td></tr></table></figure>
<p>然后就是调用服务器密码机的SDF_Encrypt接口，对密文解密（其实这时候你会发现，好像前面不用 IV 固定先算第一块也没事）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> location[] = <span class="string">&quot;xxxxxxxxxxxxxxxxxxxx&quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> location_len = <span class="keyword">sizeof</span>(location) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    ret = init();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;init error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> cip_hex[<span class="number">1024</span>] = <span class="string">&quot;949FBFA28061720CF3A1D9FB5863C619BB8769FF8994013B98E0D6968EA7B8E08F9B0E1F44FF6C37A185E9A7892FB831BD6D33EB1F586A35CD500C3B867DA2F7&quot;</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> cip[<span class="number">512</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> ciphertext_hex_len = <span class="number">0</span>;</span><br><span class="line">    ret = hex_string_to_char_array(cip_hex, cip);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hex_string_to_char_array error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> key[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> key_len = <span class="number">64</span>;</span><br><span class="line">    ret = SDF_Encrypt(sessionHandle, keyHandle, SGD_SM4_ECB, <span class="literal">NULL</span>, cip, <span class="number">64</span>, key, &amp;key_len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;SDF_OpenDeviceWithPath error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">64</span>;i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%02x&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)key[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ret = destroy();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;destroy error, ret=%08x\n&quot;</span>, ret);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-ota升级包加密"><a class="markdownIt-Anchor" href="#4-ota升级包加密"></a> 4-OTA升级包加密</h2>
<p>题目：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/cipher&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/tjfoc/gmsm/sm4&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">encrypt</span><span class="params">(key, nonce, plaintext, additionalData []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	block, err := sm4.NewCipher(key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gcm, err := cipher.NewGCM(block)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ciphertext := gcm.Seal(<span class="literal">nil</span>, nonce, plaintext, additionalData)</span><br><span class="line">	<span class="comment">// 最终结果为：12字节nonce + 密文 + 16字节认证tag</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">append</span>(nonce, ciphertext...), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">EncryptOTAPackage</span><span class="params">(plaintextFilePath <span class="type">string</span>, key, nonce []<span class="type">byte</span>)</span></span> (ciphertextFilePath <span class="type">string</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(key) != <span class="number">16</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;invalid key&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(nonce) != <span class="number">12</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;invalid nonce&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 读取明文 OTA 升级包内容</span></span><br><span class="line">	<span class="comment">// TODO 此处代码已省略</span></span><br><span class="line"></span><br><span class="line">	ciphertextContent, err := encrypt(key, nonce, plaintextContent, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 以字节流形式将加密后的升级包文件内容写到文件中</span></span><br><span class="line">	<span class="comment">// TODO 此处代码已省略</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	plainFilePath := <span class="string">&quot;./files/firm-v1.0-plain.bin&quot;</span></span><br><span class="line">	expectedCipherFilePath := <span class="string">&quot;./files/firm-v1.0.bin&quot;</span></span><br><span class="line">	key := []<span class="type">byte</span>(<span class="string">&quot;xxxxxxxxxxxxxxxx&quot;</span>)</span><br><span class="line">	nonce := []<span class="type">byte</span>(<span class="string">&quot;xxxxxxxxxxxx&quot;</span>)</span><br><span class="line">	cipherFilePath, err := EncryptOTAPackage(plainFilePath, key, nonce)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> cipherFilePath != expectedCipherFilePath &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;invalid cipherFilePath&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后会给出 <code>firm-v1.0.bin</code> 和 <code>firm-v1.1.bin</code>，要求你构造一个新的 bin 文件使得实现自动驾驶功能使能位。其实就是把明文第 8 位的指定 bit 改成 1 就好了。</p>
<p>首先 两个给我们的文件都是密文，所以我们是读不到明文信息的。不过注意 GCM 对密文的加密就是 CTR，所以是流密码形式的，那我只要对指定 bit 做翻转就好了。然后后面就是伪造 tag 了，因为你把消息改了那 tag 肯定也不会一样了。</p>
<p>审计代码可以发现 GCM 的 key 和 nonce 是重用的，那这就为我们伪造 tag 提供了漏洞。我们要伪造的值是 10 块的，这里为了简单介绍，我假设两组密文都是 4 块的。并且记为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">a_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ~ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mn>3</mn></msub><mo separator="true">,</mo><msub><mi>b</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">a_3,b_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> ~ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">b_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，然后记第一组密文 tag 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span></span></span></span>，第二组密文 tag 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>，有</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo>=</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><msub><mi>a</mi><mn>0</mn></msub><mi>h</mi><mo>+</mo><msub><mi>a</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mi>h</mi><mo>+</mo><msub><mi>a</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mi>h</mi><mo>+</mo><msub><mi>a</mi><mn>3</mn></msub><mo stretchy="false">)</mo><mi>h</mi><mo>+</mo><mi>l</mi><mo stretchy="false">)</mo><mi>h</mi><mo>+</mo><mi>s</mi><mo>=</mo><msub><mi>a</mi><mn>0</mn></msub><msup><mi>h</mi><mn>5</mn></msup><mo>+</mo><msub><mi>a</mi><mn>1</mn></msub><msup><mi>h</mi><mn>4</mn></msup><mo>+</mo><msub><mi>a</mi><mn>2</mn></msub><msup><mi>h</mi><mn>3</mn></msup><mo>+</mo><msub><mi>a</mi><mn>3</mn></msub><msup><mi>h</mi><mn>2</mn></msup><mo>+</mo><mi>l</mi><mi>h</mi><mo>+</mo><mi>s</mi><mspace linebreak="newline"></mspace><mi>B</mi><mo>=</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><msub><mi>b</mi><mn>0</mn></msub><mi>h</mi><mo>+</mo><msub><mi>b</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mi>h</mi><mo>+</mo><msub><mi>b</mi><mn>2</mn></msub><mo stretchy="false">)</mo><mi>h</mi><mo>+</mo><msub><mi>b</mi><mn>3</mn></msub><mo stretchy="false">)</mo><mi>h</mi><mo>+</mo><mi>l</mi><mo stretchy="false">)</mo><mi>h</mi><mo>+</mo><mi>s</mi><mo>=</mo><msub><mi>b</mi><mn>0</mn></msub><msup><mi>h</mi><mn>5</mn></msup><mo>+</mo><msub><mi>b</mi><mn>1</mn></msub><msup><mi>h</mi><mn>4</mn></msup><mo>+</mo><msub><mi>b</mi><mn>2</mn></msub><msup><mi>h</mi><mn>3</mn></msup><mo>+</mo><msub><mi>b</mi><mn>3</mn></msub><msup><mi>h</mi><mn>2</mn></msup><mo>+</mo><mi>l</mi><mi>h</mi><mo>+</mo><mi>s</mi><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex">A=((((a_0h+a_1)h+a_2)h+a_3)h+l)h+s=a_0h^5+a_1h^4+a_2h^3+a_3h^2+lh+s\\
B=((((b_0h+b_1)h+b_2)h+b_3)h+l)h+s=b_0h^5+b_1h^4+b_2h^3+b_3h^2+lh+s\\
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mopen">(</span><span class="mopen">(</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mopen">(</span><span class="mopen">(</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">s</span></span><span class="mspace newline"></span></span></span></span></p>
<p>这里注意因为是在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mi>F</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mn>128</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">GF(2^{128})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathnormal">G</span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span><span class="mord mtight">8</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 下所以异或和加是等价的，然后两者相加就是两者异或变为 0，故有</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo>+</mo><mi>B</mi><mo>=</mo><mo stretchy="false">(</mo><msub><mi>a</mi><mn>0</mn></msub><mo>+</mo><msub><mi>b</mi><mn>0</mn></msub><mo stretchy="false">)</mo><msup><mi>h</mi><mn>5</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>a</mi><mn>1</mn></msub><mo>+</mo><msub><mi>b</mi><mn>1</mn></msub><mo stretchy="false">)</mo><msup><mi>h</mi><mn>4</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>a</mi><mn>2</mn></msub><mo>+</mo><msub><mi>b</mi><mn>2</mn></msub><mo stretchy="false">)</mo><msup><mi>h</mi><mn>3</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>a</mi><mn>3</mn></msub><mo>+</mo><msub><mi>b</mi><mn>3</mn></msub><mo stretchy="false">)</mo><msup><mi>h</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">A+B=(a_0+b_0)h^5+(a_1+b_1)h^4+(a_2+b_2)h^3+(a_3+b_3)h^2
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>注意到在这个等式中我们只有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span> 是未知的，那我们可以直接解方程就好了。得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span> 以后，那么伪造 tag 就是非常简单的事情了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">b1 = <span class="built_in">open</span>(<span class="string">&#x27;firm-v1.0.bin&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">b2 = <span class="built_in">open</span>(<span class="string">&#x27;firm-v1.1.bin&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line">nonce = b1[:<span class="number">12</span>]</span><br><span class="line"></span><br><span class="line">tag1 = b1[-<span class="number">16</span>:]</span><br><span class="line">tag2 = b2[-<span class="number">16</span>:]</span><br><span class="line"></span><br><span class="line">c1 = b1[<span class="number">12</span>:-<span class="number">16</span>]</span><br><span class="line">c2 = b2[<span class="number">12</span>:-<span class="number">16</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(c1) == <span class="built_in">len</span>(c2) == <span class="number">160</span></span><br><span class="line"></span><br><span class="line">t = <span class="number">8</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bin</span>(c2[t])[<span class="number">2</span>:].zfill(<span class="number">8</span>))</span><br><span class="line"><span class="comment"># 01101000</span></span><br><span class="line">ttt = <span class="number">0b01101100</span></span><br><span class="line">c3 = c2[:t] + <span class="built_in">bytes</span>([ttt]) + c2[t+<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">x = var(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">R = GF(<span class="number">2</span>**<span class="number">128</span>, modulus=x**<span class="number">128</span> + x**<span class="number">7</span> + x**<span class="number">2</span> + x + <span class="number">1</span>, name=<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">a = R.gen()</span><br><span class="line">F = PolynomialRing(R, name=<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">x = F.gen()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_poly</span>(<span class="params">c</span>):</span><br><span class="line">    <span class="keyword">return</span> R.from_integer(<span class="built_in">int</span>(<span class="string">f&#x27;<span class="subst">&#123;c:0128b&#125;</span>&#x27;</span>[::-<span class="number">1</span>], <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">from_poly</span>(<span class="params">p</span>):</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">int</span>(<span class="string">f&#x27;<span class="subst">&#123;p.to_integer():0128b&#125;</span>&#x27;</span>[::-<span class="number">1</span>], <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">C1 = [to_poly(<span class="built_in">int</span>.from_bytes(c1[<span class="number">16</span> * i:<span class="number">16</span> * i +<span class="number">16</span>])) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(c1) // <span class="number">16</span>)]</span><br><span class="line">C2 = [to_poly(<span class="built_in">int</span>.from_bytes(c2[<span class="number">16</span> * i:<span class="number">16</span> * i +<span class="number">16</span>])) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(c2) // <span class="number">16</span>)]</span><br><span class="line"></span><br><span class="line">tag1 = to_poly(<span class="built_in">int</span>.from_bytes(tag1))</span><br><span class="line">tag2 = to_poly(<span class="built_in">int</span>.from_bytes(tag2))</span><br><span class="line">f = <span class="built_in">sum</span>((C1[i] + C2[i]) * x**(<span class="built_in">len</span>(C1) - i + <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(C1))) - tag1 - tag2</span><br><span class="line">H = f.roots()[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">tag3 = tag2 - C2[<span class="number">0</span>] * H**<span class="number">11</span> + to_poly(<span class="built_in">int</span>.from_bytes(c3[:<span class="number">16</span>])) * H**<span class="number">11</span></span><br><span class="line">C3 = nonce + c3 + long_to_bytes(from_poly(tag3), <span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(C3)</span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;firm-v1.2.bin&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>).write(C3)</span><br></pre></td></tr></table></figure>
<h2 id="5-ota服务器与ota升级包签名"><a class="markdownIt-Anchor" href="#5-ota服务器与ota升级包签名"></a> *5-OTA服务器与OTA升级包签名</h2>
<p>题目：</p>
<p>challenge_handler.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> handlers</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/cipher&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/elliptic&quot;</span></span><br><span class="line">	_ <span class="string">&quot;embed&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/tjfoc/gmsm/sm2&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/tjfoc/gmsm/sm4&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed auth_private_key.hex</span></span><br><span class="line"><span class="keyword">var</span> gPrivateHex <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed auth_public_key.hex</span></span><br><span class="line"><span class="keyword">var</span> gPublicHex <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> errZeroParam = errors.New(<span class="string">&quot;zero parameter&quot;</span>)</span><br><span class="line"><span class="keyword">var</span> one = <span class="built_in">new</span>(big.Int).SetInt64(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">var</span> key []<span class="type">byte</span> <span class="comment">// SM4/GCM</span></span><br><span class="line"><span class="keyword">var</span> nonce []<span class="type">byte</span></span><br><span class="line"><span class="keyword">var</span> gPrivateKey *sm2.PrivateKey</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"></span><br><span class="line">	key, err = hex.DecodeString(<span class="string">&quot;6c87d37a658ab6b00fee969d4b107ef0&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(key) != <span class="number">16</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Errorf(<span class="string">&quot;key 配置有误&quot;</span>))</span><br><span class="line">	&#125;</span><br><span class="line">	nonce, err = hex.DecodeString(<span class="string">&quot;17d77a33826174759e01273c&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(nonce) != <span class="number">12</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Errorf(<span class="string">&quot;nonce 配置有误&quot;</span>))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 转换为密钥对象</span></span><br><span class="line">	gPrivateKey, _, err = HexToSM2Key(gPrivateHex, gPublicHex[<span class="number">2</span>:])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;密钥加载失败: &quot;</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HexToSM2Key  十六进制字符串转密钥对象</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HexToSM2Key</span><span class="params">(privateHex, publicHex <span class="type">string</span>)</span></span> (*sm2.PrivateKey, *sm2.PublicKey, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 解析私钥</span></span><br><span class="line">	privateBytes, err := hex.DecodeString(privateHex)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;私钥解码失败: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	privateKey := <span class="built_in">new</span>(sm2.PrivateKey)</span><br><span class="line">	privateKey.D = <span class="built_in">new</span>(big.Int).SetBytes(privateBytes)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解析公钥</span></span><br><span class="line">	publicBytes, err := hex.DecodeString(publicHex)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;公钥解码失败: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据曲线参数重建公钥</span></span><br><span class="line">	curve := sm2.P256Sm2()</span><br><span class="line">	x := <span class="built_in">new</span>(big.Int).SetBytes(publicBytes[:<span class="number">32</span>])</span><br><span class="line">	y := <span class="built_in">new</span>(big.Int).SetBytes(publicBytes[<span class="number">32</span>:])</span><br><span class="line">	privateKey.PublicKey = sm2.PublicKey&#123;</span><br><span class="line">		Curve: curve,</span><br><span class="line">		X:     x,</span><br><span class="line">		Y:     y,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> privateKey, &amp;privateKey.PublicKey, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChallengeHandler 对 APP 控制端发来的挑战值用私钥进行签名并返回给 APP 控制端，APP 控制端对签名值进行验签从而确认 OTA 服务器的身份。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ChallengeHandler</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> req <span class="keyword">struct</span> &#123;</span><br><span class="line">		Challenge <span class="type">string</span> <span class="string">`json:&quot;challenge&quot; binding:&quot;required,min=1,max=2048&quot;`</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := c.ShouldBindJSON(&amp;req); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;参数不合法&quot;</span>&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 补 0</span></span><br><span class="line">	challengeHex := req.Challenge</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(challengeHex)%<span class="number">2</span> == <span class="number">1</span> &#123;</span><br><span class="line">		challengeHex = <span class="string">&quot;0&quot;</span> + challengeHex</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	challenge, err := hex.DecodeString(challengeHex)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;参数不合法&quot;</span>&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 签名</span></span><br><span class="line">	sigHex, err := signMessage(challenge, gPrivateKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		c.JSON(http.StatusInternalServerError, gin.H&#123;<span class="string">&quot;error&quot;</span>: err.Error()&#125;)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	c.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;signature&quot;</span>: sigHex&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hash</span><span class="params">(data []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	block, err := sm4.NewCipher(key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gcm, err := cipher.NewGCM(block)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// func (AEAD) Seal(dst []byte, nonce []byte, plaintext []byte, additionalData []byte) []byte</span></span><br><span class="line">	authTag := gcm.Seal(<span class="literal">nil</span>, nonce, []<span class="type">byte</span>(<span class="string">&quot;&quot;</span>), data)</span><br><span class="line">	<span class="keyword">return</span> authTag, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">myRandFieldElement</span><span class="params">(c elliptic.Curve, msg, d []<span class="type">byte</span>)</span></span> (k *big.Int, err <span class="type">error</span>) &#123;</span><br><span class="line">	params := c.Params()</span><br><span class="line">	b := <span class="built_in">make</span>([]<span class="type">byte</span>, params.BitSize/<span class="number">8</span>+<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">	h, err := hash(<span class="built_in">append</span>(msg, d...))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">copy</span>(b, h)</span><br><span class="line">	k = <span class="built_in">new</span>(big.Int).SetBytes(b)</span><br><span class="line">	n := <span class="built_in">new</span>(big.Int).Sub(params.N, one)</span><br><span class="line">	k.Mod(k, n)</span><br><span class="line">	k.Add(k, one)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mySm2Sign</span><span class="params">(priv *sm2.PrivateKey, msg, uid []<span class="type">byte</span>)</span></span> (r, s *big.Int, err <span class="type">error</span>) &#123;</span><br><span class="line">	digest, err := priv.PublicKey.Sm3Digest(msg, uid)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	e := <span class="built_in">new</span>(big.Int).SetBytes(digest)</span><br><span class="line">	c := priv.PublicKey.Curve</span><br><span class="line">	N := c.Params().N</span><br><span class="line">	<span class="keyword">if</span> N.Sign() == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, errZeroParam</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> k *big.Int</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			k, err = myRandFieldElement(c, msg, priv.D.Bytes())</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				r = <span class="literal">nil</span></span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">			r, _ = priv.Curve.ScalarBaseMult(k.Bytes())</span><br><span class="line">			r.Add(r, e)</span><br><span class="line">			r.Mod(r, N)</span><br><span class="line">			<span class="keyword">if</span> r.Sign() != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> t := <span class="built_in">new</span>(big.Int).Add(r, k); t.Cmp(N) != <span class="number">0</span> &#123;</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line">		rD := <span class="built_in">new</span>(big.Int).Mul(priv.D, r)</span><br><span class="line">		s = <span class="built_in">new</span>(big.Int).Sub(k, rD)</span><br><span class="line">		d1 := <span class="built_in">new</span>(big.Int).Add(priv.D, one)</span><br><span class="line">		d1Inv := <span class="built_in">new</span>(big.Int).ModInverse(d1, N)</span><br><span class="line">		s.Mul(s, d1Inv)</span><br><span class="line">		s.Mod(s, N)</span><br><span class="line">		<span class="keyword">if</span> s.Sign() != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">signMessage</span><span class="params">(message []<span class="type">byte</span>, priv *sm2.PrivateKey)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 生成 SM2 签名</span></span><br><span class="line">	r, s, err := mySm2Sign(priv, message, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 裸签名</span></span><br><span class="line">	<span class="comment">// 将 r 和 s 转换为字节切片</span></span><br><span class="line">	rBytes := r.Bytes()</span><br><span class="line">	sBytes := s.Bytes()</span><br><span class="line">	<span class="comment">// 确保 r 和 s 为 32 字节</span></span><br><span class="line">	<span class="keyword">var</span> rPadded [<span class="number">32</span>]<span class="type">byte</span></span><br><span class="line">	<span class="keyword">var</span> sPadded [<span class="number">32</span>]<span class="type">byte</span></span><br><span class="line">	<span class="built_in">copy</span>(rPadded[<span class="number">32</span>-<span class="built_in">len</span>(rBytes):], rBytes)</span><br><span class="line">	<span class="built_in">copy</span>(sPadded[<span class="number">32</span>-<span class="built_in">len</span>(sBytes):], sBytes)</span><br><span class="line">	rHex := hex.EncodeToString(rPadded[:])</span><br><span class="line">	sHex := hex.EncodeToString(sPadded[:])</span><br><span class="line"></span><br><span class="line">	rawSignature := rHex + sHex</span><br><span class="line">	<span class="keyword">return</span> rawSignature, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>generate_auth_sign_key.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> key_generator</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/cipher&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/tjfoc/gmsm/sm4&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> key []<span class="type">byte</span> <span class="comment">// SM4/GCM</span></span><br><span class="line"><span class="keyword">var</span> nonce []<span class="type">byte</span></span><br><span class="line"><span class="keyword">var</span> one = <span class="built_in">new</span>(big.Int).SetInt64(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">var</span> two = <span class="built_in">new</span>(big.Int).SetInt64(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"></span><br><span class="line">	key, err = hex.DecodeString(<span class="string">&quot;6c87d37a658ab6b00fee969d4b107ef0&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(key) != <span class="number">16</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Errorf(<span class="string">&quot;key 配置有误&quot;</span>))</span><br><span class="line">	&#125;</span><br><span class="line">	nonce, err = hex.DecodeString(<span class="string">&quot;17d77a33826174759e01273c&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(nonce) != <span class="number">12</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(fmt.Errorf(<span class="string">&quot;nonce 配置有误&quot;</span>))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hash</span><span class="params">(data []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	block, err := sm4.NewCipher(key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gcm, err := cipher.NewGCM(block)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// func (AEAD) Seal(dst []byte, nonce []byte, plaintext []byte, additionalData []byte) []byte</span></span><br><span class="line">	authTag := gcm.Seal(<span class="literal">nil</span>, nonce, []<span class="type">byte</span>(<span class="string">&quot;&quot;</span>), data)</span><br><span class="line">	<span class="keyword">return</span> authTag, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成对 OTA 升级包签名的私钥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateSignKey</span><span class="params">(masterKey []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(masterKey) != <span class="number">16</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;masterKey must be 16 bytes&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将 masterKey 转为整数</span></span><br><span class="line">	masterKeyInt := <span class="built_in">new</span>(big.Int).SetBytes(masterKey)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 计算 DSign 的高 128 bit</span></span><br><span class="line">	signKeyHighBytes, err := hash(masterKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// masterKey + 1</span></span><br><span class="line">	masterKeyInt.Add(masterKeyInt, one)</span><br><span class="line">	<span class="comment">// 计算 DSign 的低 128 bit</span></span><br><span class="line">	signKeyLowBytes, err := hash(masterKeyInt.Bytes())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// signKeyBytes</span></span><br><span class="line">	signKeyBytes := <span class="built_in">append</span>(signKeyHighBytes, signKeyLowBytes...)</span><br><span class="line">	<span class="keyword">return</span> signKeyBytes, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成 APP 控制端鉴别 OTA 服务器身份的私钥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateAuthKey</span><span class="params">(masterKey []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(masterKey) != <span class="number">16</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;masterKey must be 16 bytes&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将 masterKey 转为整数</span></span><br><span class="line">	masterKeyInt := <span class="built_in">new</span>(big.Int).SetBytes(masterKey)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// masterKey + 2</span></span><br><span class="line">	masterKeyInt.Add(masterKeyInt, two)</span><br><span class="line">	<span class="comment">// 计算 DAuth 的高 128 bit</span></span><br><span class="line">	authKeyHighBytes, err := hash(masterKeyInt.Bytes())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// masterKey + 3</span></span><br><span class="line">	masterKeyInt.Add(masterKeyInt, one)</span><br><span class="line">	<span class="comment">// 计算 DAuth 的低 128 bit</span></span><br><span class="line">	authKeyLowBytes, err := hash(masterKeyInt.Bytes())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// authKeyBytes</span></span><br><span class="line">	authKeyBytes := <span class="built_in">append</span>(authKeyHighBytes, authKeyLowBytes...)</span><br><span class="line">	<span class="keyword">return</span> authKeyBytes, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>sign_package.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sign_package</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/tjfoc/gmsm/sm2&quot;</span></span><br><span class="line">	<span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// LoadHexFromFile 从文件加载十六进制密钥</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadHexFromFile</span><span class="params">(filename <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	data, err := ioutil.ReadFile(filename)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;文件读取失败: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">string</span>(data), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HexToSM2Key 十六进制字符串转密钥对象</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HexToSM2Key</span><span class="params">(privateHex, publicHex <span class="type">string</span>)</span></span> (*sm2.PrivateKey, *sm2.PublicKey, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 解析私钥</span></span><br><span class="line">	privateBytes, err := hex.DecodeString(privateHex)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;私钥解码失败: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	privateKey := <span class="built_in">new</span>(sm2.PrivateKey)</span><br><span class="line">	privateKey.D = <span class="built_in">new</span>(big.Int).SetBytes(privateBytes)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解析公钥</span></span><br><span class="line">	publicBytes, err := hex.DecodeString(publicHex)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;公钥解码失败: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 根据曲线参数重建公钥</span></span><br><span class="line">	curve := sm2.P256Sm2()</span><br><span class="line">	x := <span class="built_in">new</span>(big.Int).SetBytes(publicBytes[:<span class="number">32</span>])</span><br><span class="line">	y := <span class="built_in">new</span>(big.Int).SetBytes(publicBytes[<span class="number">32</span>:])</span><br><span class="line">	privateKey.PublicKey = sm2.PublicKey&#123;</span><br><span class="line">		Curve: curve,</span><br><span class="line">		X:     x,</span><br><span class="line">		Y:     y,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> privateKey, &amp;privateKey.PublicKey, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">signMessage</span><span class="params">(message []<span class="type">byte</span>, priv *sm2.PrivateKey)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="comment">// 生成 SM2 签名</span></span><br><span class="line">	r, s, err := sm2.Sm2Sign(priv, message, <span class="literal">nil</span>, rand.Reader)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 裸签名</span></span><br><span class="line">	<span class="comment">// 将 r 和 s 转换为字节切片</span></span><br><span class="line">	rBytes := r.Bytes()</span><br><span class="line">	sBytes := s.Bytes()</span><br><span class="line">	<span class="comment">// 确保 r 和 s 为 32 字节</span></span><br><span class="line">	<span class="keyword">var</span> rPadded [<span class="number">32</span>]<span class="type">byte</span></span><br><span class="line">	<span class="keyword">var</span> sPadded [<span class="number">32</span>]<span class="type">byte</span></span><br><span class="line">	<span class="built_in">copy</span>(rPadded[<span class="number">32</span>-<span class="built_in">len</span>(rBytes):], rBytes)</span><br><span class="line">	<span class="built_in">copy</span>(sPadded[<span class="number">32</span>-<span class="built_in">len</span>(sBytes):], sBytes)</span><br><span class="line">	rHex := hex.EncodeToString(rPadded[:])</span><br><span class="line">	sHex := hex.EncodeToString(sPadded[:])</span><br><span class="line"></span><br><span class="line">	rawSignature := rHex + sHex</span><br><span class="line">	<span class="keyword">return</span> rawSignature, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对 OTA 升级包进行签名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">signPackage</span><span class="params">(filename <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="comment">// 1. 读取文件内容</span></span><br><span class="line">	content, err := ioutil.ReadFile(filename)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;读取文件内容失败: &quot;</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 加载私钥</span></span><br><span class="line">	privateHex, _ := LoadHexFromFile(<span class="string">&quot;sign_private_key.hex&quot;</span>)</span><br><span class="line">	publicHex, _ := LoadHexFromFile(<span class="string">&quot;sign_public_key.hex&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 转换为密钥对象</span></span><br><span class="line">	privateKey, _, err := HexToSM2Key(privateHex, publicHex[<span class="number">2</span>:])</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(<span class="string">&quot;密钥加载失败: &quot;</span> + err.Error())</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. 签名并输出结果</span></span><br><span class="line">	sigHex, err := signMessage(content, privateKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sigHex</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>题目给出了一个APP 控制端的签名端口，你可以输入任意的消息进行签名，然后目标是计算出其的私钥然后回推 masterKey，最后再用 masterKey 计算出 OTA 升级包签名的私钥。</p>
<p>在这次比赛中，我们选择性略过了 <code>generate_auth_sign_key.go</code> 导致最后拿到APP 控制端的私钥后一直大眼瞪小眼，最后注意到时候已经迷迷糊糊了还是没有做出来(T_T)</p>
<p>首先 APP 控制端的签名算法是 SM2 签名算法，流程并没有差错，但是注意随机数的生成，是对消息和私钥进行拼接作为 GCM 的 add ，然后加密空字符，然后将生成的 tag 作为随机数。这时候思路就很明了了，只要构造两个合适的消息，使得生成的随机数一样即可计算出私钥。</p>
<p>我们构造两个消息，使得计算 tag 的时候可以分成两组，那么就可以写作</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><msup><mi>h</mi><mn>5</mn></msup><mo>+</mo><msub><mi>A</mi><mn>2</mn></msub><msup><mi>h</mi><mn>4</mn></msup><mo>+</mo><mi>B</mi><mspace linebreak="newline"></mspace><msub><mi>A</mi><mn>3</mn></msub><msup><mi>h</mi><mn>5</mn></msup><mo>+</mo><msub><mi>A</mi><mn>4</mn></msub><msup><mi>h</mi><mn>4</mn></msup><mo>+</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A_1h^5+A_2h^4+B\\
A_3h^5+A_4h^4+B
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0141079999999998em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span></p>
<p>其中 B 为后面的值（因为都是相等的），我们需要两个等式相等，那么就随便选择一下 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>A</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>A</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">A_1,A_2,A_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，就可以拿到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>4</mn></msub></mrow><annotation encoding="application/x-tex">A_4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">import</span> gmalg</span><br><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">x = var(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">R = GF(<span class="number">2</span>**<span class="number">128</span>, modulus=x**<span class="number">128</span> + x**<span class="number">7</span> + x**<span class="number">2</span> + x + <span class="number">1</span>, name=<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">a = R.gen()</span><br><span class="line">F = PolynomialRing(R, name=<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">x = F.gen()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_poly</span>(<span class="params">c</span>):</span><br><span class="line">    <span class="keyword">return</span> R.from_integer(<span class="built_in">int</span>(<span class="string">f&#x27;<span class="subst">&#123;c:0128b&#125;</span>&#x27;</span>[::-<span class="number">1</span>], <span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">from_poly</span>(<span class="params">p</span>):</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">int</span>(<span class="string">f&#x27;<span class="subst">&#123;p.to_integer():0128b&#125;</span>&#x27;</span>[::-<span class="number">1</span>], <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sm4 = gmalg.SM4(<span class="string">b&#x27;1&#x27;</span>*<span class="number">16</span>) </span><br><span class="line">key = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;6c87d37a658ab6b00fee969d4b107ef0&quot;</span>)</span><br><span class="line">nonce = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;17d77a33826174759e01273c&quot;</span>)</span><br><span class="line">plaintext = <span class="string">b&quot;\x00&quot;</span>*<span class="number">16</span> </span><br><span class="line">cipher = gmalg.SM4(key)</span><br><span class="line">ciphertext = cipher.encrypt(plaintext) </span><br><span class="line">h = to_poly(<span class="built_in">int</span>(ciphertext.<span class="built_in">hex</span>(), <span class="number">16</span>))</span><br><span class="line">ciphertext = cipher.encrypt(nonce + <span class="string">b&#x27;\x01&#x27;</span>.zfill(<span class="number">4</span>)) </span><br><span class="line">s = to_poly(<span class="built_in">int</span>(ciphertext.<span class="built_in">hex</span>(), <span class="number">16</span>))</span><br><span class="line">x1 = <span class="string">b&#x27;1&#x27;</span>*<span class="number">16</span> </span><br><span class="line">x1 = to_poly(bytes_to_long(x1))</span><br><span class="line">x2 = x1*h</span><br><span class="line">A1 = to_poly(bytes_to_long(<span class="string">b&#x27;1&#x27;</span>*<span class="number">16</span>)) </span><br><span class="line">A3 = A1 - x1 </span><br><span class="line">A2 = to_poly(bytes_to_long(<span class="string">b&#x27;1&#x27;</span>*<span class="number">16</span>)) </span><br><span class="line">A4 = A2 - x2</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tt</span>(<span class="params">A</span>): <span class="keyword">return</span> long_to_bytes(from_poly(A), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">tar1,tar2 = tt(A1) + tt(A2), tt(A3) + tt(A4)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(tar1.<span class="built_in">hex</span>(), tar2.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>
<p>拿到两个消息之后，就可以拿到私钥了，后面就简单了对着流程逆就好了。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ctf/" rel="tag"><i class="fa fa-tag"></i> ctf</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/23/square-attack/" rel="prev" title="square attack">
                  <i class="fa fa-angle-left"></i> square attack
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">languag3</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{"copy_tex_js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js","integrity":"sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="}}</script>
  <script src="/js/third-party/math/katex.js"></script>



</body>
</html>
