<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"languag3.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="爽玩">
<meta property="og:type" content="article">
<meta property="og:title" content="强网杯2025">
<meta property="og:url" content="https://languag3.github.io/2025/10/20/%E5%BC%BA%E7%BD%91%E6%9D%AF2025/index.html">
<meta property="og:site_name" content="languag3">
<meta property="og:description" content="爽玩">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-10-20T02:27:41.000Z">
<meta property="article:modified_time" content="2025-10-20T04:53:24.824Z">
<meta property="article:author" content="languag3">
<meta property="article:tag" content="ctf">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://languag3.github.io/2025/10/20/%E5%BC%BA%E7%BD%91%E6%9D%AF2025/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://languag3.github.io/2025/10/20/%E5%BC%BA%E7%BD%91%E6%9D%AF2025/","path":"2025/10/20/强网杯2025/","title":"强网杯2025"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>强网杯2025 | languag3</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">languag3</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">众里寻他千百度。蓦然回首，那人却在，灯火阑珊处。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-link"><a href="/links/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>友链</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#check-little"><span class="nav-number">1.</span> <span class="nav-text"> check-little</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ezran"><span class="nav-number">2.</span> <span class="nav-text"> ezran</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sk"><span class="nav-number">3.</span> <span class="nav-text"> sk</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#blurred"><span class="nav-number">4.</span> <span class="nav-text"> Blurred</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#theorezhnp"><span class="nav-number">5.</span> <span class="nav-text"> *theorezhnp</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="languag3"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">languag3</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/languag3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;languag3" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1499304232@qq.com" title="E-Mail → mailto:1499304232@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://languag3.github.io/2025/10/20/%E5%BC%BA%E7%BD%91%E6%9D%AF2025/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="languag3">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="languag3">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="强网杯2025 | languag3">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          强网杯2025
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-10-20 10:27:41 / 修改时间：12:53:24" itemprop="dateCreated datePublished" datetime="2025-10-20T10:27:41+08:00">2025-10-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>爽玩</p>
<span id="more"></span> 
<h2 id="check-little"><a class="markdownIt-Anchor" href="#check-little"></a> check-little</h2>
<p>题目</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">e = <span class="number">3</span></span><br><span class="line">N = <span class="number">18795243691459931102679430418438577487182868999316355192329142792373332586982081116157618183340526639820832594356060100434223256500692328397325525717520080923556460823312550686675855168462443732972471029248411895298194999914208659844399140111591879226279321744653193556611846787451047972910648795242491084639500678558330667893360111323258122486680221135246164012614985963764584815966847653119900209852482555918436454431153882157632072409074334094233788430465032930223125694295658614266389920401471772802803071627375280742728932143483927710162457745102593163282789292008750587642545379046283071314559771249725541879213</span></span><br><span class="line">c = <span class="number">10533300439600777643268954021939765793377776034841545127500272060105769355397400380934565940944293911825384343828681859639313880125620499839918040578655561456321389174383085564588456624238888480505180939435564595727140532113029361282409382333574306251485795629774577583957179093609859781367901165327940565735323086825447814974110726030148323680609961403138324646232852291416574755593047121480956947869087939071823527722768175903469966103381291413103667682997447846635505884329254225027757330301667560501132286709888787328511645949099996122044170859558132933579900575094757359623257652088436229324185557055090878651740</span></span><br><span class="line">iv = <span class="string">b&#x27;\x91\x16\x04\xb9\xf0RJ\xdd\xf7&#125;\x8cW\xe7n\x81\x8d&#x27;</span></span><br><span class="line">ciphertext = <span class="string">&#x27;bf87027bc63e69d3096365703a6d47b559e0364b1605092b6473ecde6babeff2&#x27;</span></span><br><span class="line"></span><br><span class="line">p = GCD(N, c)</span><br><span class="line">q = N // p</span><br><span class="line">d = inverse(e, (p - <span class="number">1</span>) * (q - <span class="number">1</span>))</span><br><span class="line">key = <span class="built_in">pow</span>(c, d, N)</span><br><span class="line"><span class="built_in">print</span>(AES.new(key = long_to_bytes(key)[:<span class="number">16</span>], iv = iv, mode = AES.MODE_CBC).decrypt(<span class="built_in">bytes</span>.fromhex(ciphertext)))</span><br></pre></td></tr></table></figure>
<p>对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">n</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">c</span></span></span></span> 计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>gcd</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\gcd</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mop"><span style="margin-right:0.01389em;">g</span>cd</span></span></span></span> 发现有公因子</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">e = <span class="number">3</span></span><br><span class="line">N = <span class="number">18795243691459931102679430418438577487182868999316355192329142792373332586982081116157618183340526639820832594356060100434223256500692328397325525717520080923556460823312550686675855168462443732972471029248411895298194999914208659844399140111591879226279321744653193556611846787451047972910648795242491084639500678558330667893360111323258122486680221135246164012614985963764584815966847653119900209852482555918436454431153882157632072409074334094233788430465032930223125694295658614266389920401471772802803071627375280742728932143483927710162457745102593163282789292008750587642545379046283071314559771249725541879213</span></span><br><span class="line">c = <span class="number">10533300439600777643268954021939765793377776034841545127500272060105769355397400380934565940944293911825384343828681859639313880125620499839918040578655561456321389174383085564588456624238888480505180939435564595727140532113029361282409382333574306251485795629774577583957179093609859781367901165327940565735323086825447814974110726030148323680609961403138324646232852291416574755593047121480956947869087939071823527722768175903469966103381291413103667682997447846635505884329254225027757330301667560501132286709888787328511645949099996122044170859558132933579900575094757359623257652088436229324185557055090878651740</span></span><br><span class="line">iv = <span class="string">b&#x27;\x91\x16\x04\xb9\xf0RJ\xdd\xf7&#125;\x8cW\xe7n\x81\x8d&#x27;</span></span><br><span class="line">ciphertext = <span class="string">&#x27;bf87027bc63e69d3096365703a6d47b559e0364b1605092b6473ecde6babeff2&#x27;</span></span><br><span class="line"></span><br><span class="line">p = GCD(N, c)</span><br><span class="line">q = N // p</span><br><span class="line">d = inverse(e, (p - <span class="number">1</span>) * (q - <span class="number">1</span>))</span><br><span class="line">key = <span class="built_in">pow</span>(c, d, N)</span><br><span class="line"><span class="built_in">print</span>(AES.new(key = long_to_bytes(key)[:<span class="number">16</span>], iv = iv, mode = AES.MODE_CBC).decrypt(<span class="built_in">bytes</span>.fromhex(ciphertext)))</span><br></pre></td></tr></table></figure>
<h2 id="ezran"><a class="markdownIt-Anchor" href="#ezran"></a> ezran</h2>
<p>题目</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">flag = f.read().encode()</span><br><span class="line"></span><br><span class="line">gift=<span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3108</span>):</span><br><span class="line">    r1 = getrandbits(<span class="number">8</span>)</span><br><span class="line">    r2 = getrandbits(<span class="number">16</span>)</span><br><span class="line">    x=(<span class="built_in">pow</span>(r1, <span class="number">2</span>*i, <span class="number">257</span>) &amp; <span class="number">0xff</span>) ^ r2</span><br><span class="line">    c=long_to_bytes(x, <span class="number">2</span>)</span><br><span class="line">    gift+=c</span><br><span class="line"></span><br><span class="line">m = <span class="built_in">list</span>(flag)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2025</span>):</span><br><span class="line">    shuffle(m)</span><br><span class="line"></span><br><span class="line">c = <span class="string">&quot;&quot;</span>.join(<span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">chr</span>,m)))</span><br><span class="line"></span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;output.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">f.write(<span class="string">f&quot;gift = <span class="subst">&#123;bytes_to_long(gift)&#125;</span>\n&quot;</span>)</span><br><span class="line">f.write(<span class="string">f&quot;c = <span class="subst">&#123;c&#125;</span>\n&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>分析代码知道 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">x</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">r_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的高 8 位一样，然后可以用 gf2bv 求，由于多解所以用 <code>solve_all</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gf2bv <span class="keyword">import</span> LinearSystem</span><br><span class="line"><span class="keyword">from</span> gf2bv.crypto.mt <span class="keyword">import</span> MT19937</span><br><span class="line"><span class="keyword">from</span> output <span class="keyword">import</span> gift, c</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mt19937</span>(<span class="params">bs, out</span>):</span><br><span class="line">    lin = LinearSystem([<span class="number">32</span>] * <span class="number">624</span>)</span><br><span class="line">    mt = lin.gens()</span><br><span class="line"></span><br><span class="line">    rng = MT19937(mt)</span><br><span class="line">    zeros = []</span><br><span class="line">    <span class="keyword">for</span> o <span class="keyword">in</span> out:</span><br><span class="line">        rng.getrandbits(<span class="number">8</span>)</span><br><span class="line">        zeros.append(rng.getrandbits(bs) &gt;&gt; <span class="number">8</span> ^ <span class="built_in">int</span>(o))</span><br><span class="line">    zeros.append(mt[<span class="number">0</span>] ^ <span class="built_in">int</span>(<span class="number">0x80000000</span>))</span><br><span class="line">    <span class="keyword">for</span> sol <span class="keyword">in</span> lin.solve_all(zeros):</span><br><span class="line"></span><br><span class="line">        rng = MT19937(sol)</span><br><span class="line">        pyrand = rng.to_python_random()</span><br><span class="line">        <span class="keyword">yield</span> pyrand</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ins</span>(<span class="params">s, rng, rounds = <span class="number">2025</span></span>):</span><br><span class="line">    a = <span class="built_in">list</span>(s)</span><br><span class="line">    n = <span class="built_in">len</span>(a)</span><br><span class="line">    sw = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(rounds):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">            j = rng.randrange(i + <span class="number">1</span>)   </span><br><span class="line">            sw.append((i, j))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">reversed</span>(sw):</span><br><span class="line">        a[i], a[j] = a[j], a[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(s, (<span class="built_in">bytes</span>, <span class="built_in">bytearray</span>)):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(a)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(a)</span><br><span class="line"></span><br><span class="line">gift = long_to_bytes(gift)</span><br><span class="line">g = [gift[<span class="number">2</span> * i:<span class="number">2</span> * i + <span class="number">2</span>][<span class="number">0</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(gift) // <span class="number">2</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> rng <span class="keyword">in</span> mt19937(<span class="number">16</span>, g):</span><br><span class="line">    gg=<span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3108</span>):</span><br><span class="line">        r1 = rng.getrandbits(<span class="number">8</span>)</span><br><span class="line">        r2 = rng.getrandbits(<span class="number">16</span>)</span><br><span class="line">        x=(<span class="built_in">pow</span>(r1, <span class="number">2</span>*i, <span class="number">257</span>) &amp; <span class="number">0xff</span>) ^ r2</span><br><span class="line">        cc=long_to_bytes(x, <span class="number">2</span>)</span><br><span class="line">        gg+=cc</span><br><span class="line">    <span class="keyword">if</span> gg == gift:</span><br><span class="line">        <span class="built_in">print</span>(ins(c, rng))</span><br></pre></td></tr></table></figure>
<h2 id="sk"><a class="markdownIt-Anchor" href="#sk"></a> sk</h2>
<p>题目</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> getPrime, inverse, long_to_bytes, bytes_to_long</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen_coprime_num</span>(<span class="params">pbits</span>):</span><br><span class="line">    lbits = <span class="number">2</span> * pbits + <span class="number">8</span></span><br><span class="line">    lb = <span class="number">2</span>**lbits</span><br><span class="line">    ub = <span class="number">2</span>**(lbits + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        r = randint(lb, ub)</span><br><span class="line">        s = randint(lb, ub)</span><br><span class="line">        <span class="keyword">if</span> gcd(r, s) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> r, s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mult_mod</span>(<span class="params">A, B, p</span>):</span><br><span class="line">    result = [<span class="number">0</span>] * (<span class="built_in">len</span>(A) + <span class="built_in">len</span>(B) - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(A)):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(B)):</span><br><span class="line">            result[i + j] = (result[i + j] + A[i] * B[j]) % p</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen_key</span>(<span class="params">p</span>):</span><br><span class="line">    f = [randint(<span class="number">1</span>, <span class="number">2</span>**<span class="number">128</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;:)&quot;</span>]</span><br><span class="line">    h = [randint(<span class="number">1</span>, <span class="number">2</span>**<span class="number">128</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;:(&quot;</span>]</span><br><span class="line">    </span><br><span class="line">    R1, S1 = gen_coprime_num(p.bit_length())</span><br><span class="line">    R2, S2 = gen_coprime_num(p.bit_length())</span><br><span class="line"></span><br><span class="line">    B = [[randint(<span class="number">1</span>, p - <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;:(&quot;</span>] <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">&quot;:)&quot;</span>]</span><br><span class="line"></span><br><span class="line">    P = []</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> B:</span><br><span class="line">        P.append(mult_mod(f, b, p))</span><br><span class="line">    </span><br><span class="line">    Q = []</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> B:</span><br><span class="line">        Q.append(mult_mod(h, b, p))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(P)):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(P[i])):</span><br><span class="line">            P[i][j] = P[i][j] * R1 % S1</span><br><span class="line">            Q[i][j] = Q[i][j] * R2 % S2</span><br><span class="line"></span><br><span class="line">    sk = [(R1, S1), (R2, S2), f, h, p]</span><br><span class="line">    pk = [P, Q, p]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sk, pk</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">pk, pt</span>):</span><br><span class="line">    P, Q, p = pk</span><br><span class="line">    pt = bytes_to_long(pt)</span><br><span class="line"></span><br><span class="line">    PP = <span class="number">0</span></span><br><span class="line">    QQ = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(P)):</span><br><span class="line">        u = randint(<span class="number">1</span>, p)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(P[<span class="number">0</span>])):</span><br><span class="line">            PP = PP + P[i][j] * (u * pt**j % p)</span><br><span class="line">            QQ = QQ + Q[i][j] * (u * pt**j % p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PP, QQ</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">sk, ct</span>):</span><br><span class="line">    RS1, RS2, f, h, p = sk</span><br><span class="line">    R1, S1 = RS1</span><br><span class="line">    R2, S2 = RS2</span><br><span class="line"></span><br><span class="line">    P, Q = ct</span><br><span class="line">    invR1 = inverse(R1, S1)</span><br><span class="line">    invR2 = inverse(R2, S2)</span><br><span class="line">    P = (P * invR1 % S1) % p</span><br><span class="line">    Q = (Q * invR2 % S2) % p</span><br><span class="line"></span><br><span class="line">    f0q = f[<span class="number">0</span>] * Q % p</span><br><span class="line">    f1q = f[<span class="number">1</span>] * Q % p</span><br><span class="line">    h0p = h[<span class="number">0</span>] * P % p</span><br><span class="line">    h1p = h[<span class="number">1</span>] * P % p</span><br><span class="line"></span><br><span class="line">    a = f1q + p - h1p % p</span><br><span class="line">    b = f0q + p - h0p % p</span><br><span class="line"></span><br><span class="line">    pt = -b * inverse(a, p) % p</span><br><span class="line">    pt = long_to_bytes(pt)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pt</span><br><span class="line"></span><br><span class="line">signal.alarm(<span class="number">30</span>)</span><br><span class="line">p = getPrime(<span class="number">256</span>)</span><br><span class="line">sk, pk = gen_key(p)</span><br><span class="line">ticket = long_to_bytes(randint(<span class="number">1</span>, p))</span><br><span class="line">enc_ticket = encrypt(pk, ticket)</span><br><span class="line"><span class="built_in">print</span>(pk)</span><br><span class="line"><span class="built_in">print</span>(enc_ticket)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    op = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;op&gt;&quot;</span>).strip())</span><br><span class="line">    <span class="keyword">if</span> op == <span class="number">1</span>:</span><br><span class="line">        msg = <span class="built_in">input</span>(<span class="string">&quot;pt:&quot;</span>).strip().encode()</span><br><span class="line">        ct = encrypt(pk, msg)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ct: <span class="subst">&#123;ct&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> op == <span class="number">2</span>:</span><br><span class="line">        user_input = <span class="built_in">input</span>(<span class="string">&quot;ct:&quot;</span>).strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(user_input) == <span class="number">2</span>:</span><br><span class="line">            ct = [<span class="built_in">int</span>(user_input[<span class="number">0</span>]), <span class="built_in">int</span>(user_input[<span class="number">1</span>])]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;invalid ct.&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        user_input = <span class="built_in">input</span>(<span class="string">&quot;your f:&quot;</span>).strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(user_input) == <span class="number">2</span>:</span><br><span class="line">            user_f = [<span class="built_in">int</span>(user_input[<span class="number">0</span>]), <span class="built_in">int</span>(user_input[<span class="number">1</span>])]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;invalid f.&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        user_input = <span class="built_in">input</span>(<span class="string">&quot;your h:&quot;</span>).strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(user_input) == <span class="number">2</span>:</span><br><span class="line">            user_h = [<span class="built_in">int</span>(user_input[<span class="number">0</span>]), <span class="built_in">int</span>(user_input[<span class="number">1</span>])]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;invalid h.&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        user_input = <span class="built_in">input</span>(<span class="string">&quot;your R1 S1:&quot;</span>).strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(user_input) == <span class="number">2</span>:</span><br><span class="line">            user_r1s1 = [<span class="built_in">int</span>(user_input[<span class="number">0</span>]), <span class="built_in">int</span>(user_input[<span class="number">1</span>])]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;invalid R1 S1.&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        user_input = <span class="built_in">input</span>(<span class="string">&quot;your R2 S2:&quot;</span>).strip().split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(user_input) == <span class="number">2</span>:</span><br><span class="line">            user_r2s2 = [<span class="built_in">int</span>(user_input[<span class="number">0</span>]), <span class="built_in">int</span>(user_input[<span class="number">1</span>])]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;invalid R2 S2.&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        pt = decrypt((user_r1s1, user_r2s2, user_f, user_h, p), ct)</span><br><span class="line">        <span class="keyword">if</span> pt == ticket:</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(pt.<span class="built_in">hex</span>())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;invalid op.&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;bye!&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注意加密代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">pk, pt</span>):</span><br><span class="line">    P, Q, p = pk</span><br><span class="line">    pt = bytes_to_long(pt)</span><br><span class="line"></span><br><span class="line">    PP = <span class="number">0</span></span><br><span class="line">    QQ = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(P)):</span><br><span class="line">        u = randint(<span class="number">1</span>, p)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(P[<span class="number">0</span>])):</span><br><span class="line">            PP = PP + P[i][j] * (u * pt**j % p)</span><br><span class="line">            QQ = QQ + Q[i][j] * (u * pt**j % p)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PP, QQ</span><br></pre></td></tr></table></figure>
<p>如果把 <code>u * pt**j % p</code> 看作一个整体，那就是一个小值，可以考虑用格(我这里用的cuso)打出来，然后就可以拿到 <code>ticket</code> 了，之后自己走一遍流程加密一下 <code>ticket</code> 然后传回去就好了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> cuso <span class="keyword">import</span> find_small_roots</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> process, remote</span><br><span class="line"><span class="keyword">from</span> chal <span class="keyword">import</span> gen_key, encrypt, decrypt</span><br><span class="line"></span><br><span class="line"><span class="comment"># r = process([&#x27;python&#x27;, &#x27;chal.py&#x27;])</span></span><br><span class="line">r = remote(<span class="string">&#x27;47.104.146.31&#x27;</span>, <span class="number">7777</span>)</span><br><span class="line">r.sendlineafter(<span class="string">b&#x27;team token:&#x27;</span>, <span class="string">b&#x27;icq61cd73d6c5db567dc74bb9cac87e6&#x27;</span>)</span><br><span class="line"><span class="comment"># r.interactive()</span></span><br><span class="line">pk = <span class="built_in">eval</span>(r.recvline())</span><br><span class="line">enc_ticket = <span class="built_in">eval</span>(r.recvline())</span><br><span class="line">Pc, Qc = enc_ticket</span><br><span class="line">P, Q, p = pk</span><br><span class="line"></span><br><span class="line">pt_2_u1, pt_2_u2, pt_u1, pt_u2, u1, u2 = var(<span class="string">&#x27;pt_2_u1, pt_2_u2, pt_u1, pt_u2, u1, u2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">W = [pt_2_u1, pt_2_u2, pt_u1, pt_u2, u1, u2]</span><br><span class="line"></span><br><span class="line">PP = <span class="number">0</span></span><br><span class="line">QQ = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">PP = P[<span class="number">0</span>][<span class="number">0</span>] * u1 + P[<span class="number">0</span>][<span class="number">1</span>] * pt_u1 + P[<span class="number">0</span>][<span class="number">2</span>] * pt_2_u1 + P[<span class="number">1</span>][<span class="number">0</span>] * u2 + P[<span class="number">1</span>][<span class="number">1</span>] * pt_u2 + P[<span class="number">1</span>][<span class="number">2</span>] * pt_2_u2 - Pc</span><br><span class="line">QQ = Q[<span class="number">0</span>][<span class="number">0</span>] * u1 + Q[<span class="number">0</span>][<span class="number">1</span>] * pt_u1 + Q[<span class="number">0</span>][<span class="number">2</span>] * pt_2_u1 + Q[<span class="number">1</span>][<span class="number">0</span>] * u2 + Q[<span class="number">1</span>][<span class="number">1</span>] * pt_u2 + Q[<span class="number">1</span>][<span class="number">2</span>] * pt_2_u2 - Qc</span><br><span class="line"></span><br><span class="line">bounds = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> w <span class="keyword">in</span> W:</span><br><span class="line">    bounds[w] = (<span class="number">0</span>, p)</span><br><span class="line"></span><br><span class="line">roots = find_small_roots([PP, QQ], bounds)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> root <span class="keyword">in</span> roots:</span><br><span class="line">    u1_, u2_, pt_u1_, pt_u2_ = root[u1], root[u2], root[pt_u1], root[pt_u2]</span><br><span class="line">    pt1 = pt_u1_ * inverse(u1_, p) % p</span><br><span class="line">    pt2 = pt_u2_ * inverse(u2_, p) % p</span><br><span class="line">    <span class="keyword">if</span> pt1 == pt2:</span><br><span class="line">        pt = pt1</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(pt)</span><br><span class="line"></span><br><span class="line">ticket = long_to_bytes(pt)</span><br><span class="line">sk, pk = gen_key(p)</span><br><span class="line">(R1, S1), (R2, S2), f, h, p = sk</span><br><span class="line">new_ticket = encrypt(pk, ticket)</span><br><span class="line"><span class="keyword">assert</span> decrypt(sk, new_ticket) == ticket</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">b&#x27;op&gt;&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">r.sendlineafter(<span class="string">b&#x27;ct:&#x27;</span>, <span class="built_in">str</span>(new_ticket[<span class="number">0</span>]) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(new_ticket[<span class="number">1</span>]))</span><br><span class="line">r.sendlineafter(<span class="string">b&#x27;your f:&#x27;</span>, <span class="built_in">str</span>(f[<span class="number">0</span>]) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(f[<span class="number">1</span>]))</span><br><span class="line">r.sendlineafter(<span class="string">b&#x27;your h:&#x27;</span>, <span class="built_in">str</span>(h[<span class="number">0</span>]) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(h[<span class="number">1</span>]))</span><br><span class="line">r.sendlineafter(<span class="string">b&#x27;your R1 S1:&#x27;</span>, <span class="built_in">str</span>(R1) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(S1))</span><br><span class="line">r.sendlineafter(<span class="string">b&#x27;your R2 S2:&#x27;</span>, <span class="built_in">str</span>(R2) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(S2))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="blurred"><a class="markdownIt-Anchor" href="#blurred"></a> Blurred</h2>
<p>题目</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">from sage.all import *</span><br><span class="line">from sage.misc import prandom</span><br><span class="line">import random</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line">from Crypto.Hash import SHA256</span><br><span class="line">from Crypto.Util.Padding import pad</span><br><span class="line"></span><br><span class="line">q = 1342261</span><br><span class="line">n = 1031</span><br><span class="line">PR = PolynomialRing(Zmod(q), &quot;x&quot;)</span><br><span class="line">x = PR.gens()[0]</span><br><span class="line">Q = PR.quotient(x**n + 1)</span><br><span class="line">flag = b&quot;flag&#123;*****************************&#125;&quot;</span><br><span class="line"></span><br><span class="line">def sample(rand):</span><br><span class="line">    return (rand.getrandbits(1) - rand.getrandbits(1)) * (rand.getrandbits(1) * rand.getrandbits(1))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def GenNTRU():</span><br><span class="line">    f = [sample(prandom) for _ in range(n)]</span><br><span class="line">    g1 = [sample(prandom)for _ in range(n)]</span><br><span class="line">    g2 = [sample(prandom) for _ in range(n)]</span><br><span class="line">    g1x = Q(g1)</span><br><span class="line">    g2x = Q(g2)</span><br><span class="line"></span><br><span class="line">    while True:</span><br><span class="line">        fx = Q(f)</span><br><span class="line">        try:</span><br><span class="line">            h1 = g1x / fx</span><br><span class="line">            h2 = g2x / fx</span><br><span class="line">            return (h1.lift(), h2.lift(), fx)</span><br><span class="line">        except:</span><br><span class="line">            prandom.shuffle(f)</span><br><span class="line">            continue</span><br><span class="line"></span><br><span class="line">for _ in range(20259):</span><br><span class="line">    c = int(input(&quot;c :&quot;))</span><br><span class="line">    if c == 1:</span><br><span class="line">        coin = random.getrandbits(1)</span><br><span class="line">        if coin == 0:</span><br><span class="line">            pk1, pk2, fx = GenNTRU()</span><br><span class="line">        else:</span><br><span class="line">            pk1, pk2, fx = Q.random_element().lift(), Q.random_element().lift(), Q([sample(prandom) for _ in range(n)])</span><br><span class="line"></span><br><span class="line">        print(&quot;Hints:&quot;, pk1.list(), pk2.list())</span><br><span class="line">        </span><br><span class="line">    elif c == 2:</span><br><span class="line">        SHA = SHA256.new()</span><br><span class="line">        SHA.update(str(random.getrandbits(256)).encode())</span><br><span class="line">        KEY = SHA.digest()</span><br><span class="line">        cipher = AES.new(KEY, AES.MODE_ECB)</span><br><span class="line">        flag = pad(flag, AES.block_size)</span><br><span class="line">        print(&quot;Flag:&quot;, cipher.encrypt(flag))</span><br><span class="line">    else:</span><br><span class="line">        break</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果当 <code>x = -1</code> 时，商换可以约去，变成</p>
<p class='katex-block'><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>p</mi><msub><mi>k</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>≡</mo><msub><mi>g</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>⋅</mo><mi>f</mi><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><msup><mo stretchy="false">)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup><mspace></mspace><mspace width="1em"/><mrow><mi mathvariant="normal">m</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">d</mi></mrow><mtext> </mtext><mtext> </mtext><mi>q</mi></mrow><annotation encoding="application/x-tex">pk_i(-1)\equiv g_i(-1)\cdot f(-1)^{-1}\mod q
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≡</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1141079999999999em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace allowbreak"></span><span class="mspace" style="margin-right:1em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord"><span class="mord mathrm">m</span><span class="mord mathrm">o</span><span class="mord mathrm">d</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span></span></p>
<p>由于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">g_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> 是稀疏多项式，所以  <code>x = -1</code> 时也是小值，因此 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><msub><mi>k</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">pk_i(-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">p</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> 可能在区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mfrac><mi>q</mi><mn>2</mn></mfrac><mo separator="true">,</mo><mfrac><mi>q</mi><mn>2</mn></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-\frac q2,\frac q2]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.095em;vertical-align:-0.345em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">]</span></span></span></span> 附近</p>
<p>而 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>i</mi><mi>n</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">coin=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 的时候似乎没有这个性质</p>
<p>然后由于之前老附件的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span> 太小了，区分度不大因此写了个代码训练了个模型，成功率只有 89%</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random, time</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> PolynomialRing, Zmod, randint, inverse_mod</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestClassifier</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split, StratifiedKFold</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> accuracy_score, confusion_matrix, roc_auc_score</span><br><span class="line"><span class="keyword">import</span> joblib</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============== 全局参数（按需调） ==============</span></span><br><span class="line">q = <span class="number">1342261</span></span><br><span class="line">n = <span class="number">1031</span></span><br><span class="line">PR = PolynomialRing(Zmod(q), <span class="string">&quot;x&quot;</span>)</span><br><span class="line">x = PR.gens()[<span class="number">0</span>]</span><br><span class="line">Q = PR.quotient(x**n + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">SEED = <span class="number">42</span></span><br><span class="line">random.seed(SEED); np.random.seed(SEED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只用合法同态点（非常关键）</span></span><br><span class="line">TEST_XS = [-<span class="number">1</span>]         <span class="comment"># 只保留 -1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 小 F 搜索残差阈值（越大越稳但稍慢；建议 140~200）</span></span><br><span class="line">R_smallF = <span class="number">160</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 比值一致性 |a*V1 - b*V2| 搜索界（建议 60~80）</span></span><br><span class="line">B_ratio = <span class="number">70</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 训练集规模（大样本稳阈值）</span></span><br><span class="line">N_POS = <span class="number">20000</span></span><br><span class="line">N_NEG = <span class="number">20000</span></span><br><span class="line">TEST_SIZE = <span class="number">0.2</span></span><br><span class="line">N_FOLDS = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动挑阈值时的网格与约束</span></span><br><span class="line">ALPHA_GRID = (<span class="number">1.0</span>, <span class="number">1.5</span>, <span class="number">2.0</span>, <span class="number">3.0</span>, <span class="number">4.0</span>, <span class="number">6.0</span>, <span class="number">8.0</span>)</span><br><span class="line">TARGET_TOTAL_ERR = <span class="number">0.35</span>   <span class="comment"># 总错误率目标 ≤ 1.44%</span></span><br><span class="line">FP_BUDGET = <span class="number">0.007</span>           <span class="comment"># FP 预算（≤ 0.7%）</span></span><br><span class="line">CLASS_PRIOR = (<span class="number">0.5</span>, <span class="number">0.5</span>)    <span class="comment"># 如已知先验，可改成 (p_coin0, p_coin1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># XGBoost / LightGBM 可选</span></span><br><span class="line">XGB_OK = <span class="literal">False</span>; LGB_OK = <span class="literal">False</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> xgboost <span class="keyword">as</span> xgb</span><br><span class="line">    XGB_OK = <span class="literal">True</span></span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> XGB_OK:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> lightgbm <span class="keyword">as</span> lgb</span><br><span class="line">        LGB_OK = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ============== 基础工具 ==============</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_centered_int</span>(<span class="params">a, q</span>):</span><br><span class="line">    a = <span class="built_in">int</span>(a) % q</span><br><span class="line">    <span class="keyword">return</span> a <span class="keyword">if</span> a &lt;= q//<span class="number">2</span> <span class="keyword">else</span> a - q</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">eval_at_point</span>(<span class="params">pk_list, t</span>):</span><br><span class="line">    <span class="comment"># 评估 pk(t) in Z_q；这里我们只在 t=-1 用，同态成立</span></span><br><span class="line">    V, p = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> pk_list:</span><br><span class="line">        V += <span class="built_in">int</span>(c)*p</span><br><span class="line">        p = (p*t) % q</span><br><span class="line">    <span class="keyword">return</span> lift_centered_int(V, q)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============== 强化：小残差交集候选 F ==============</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">smallF_candidates_intersection</span>(<span class="params">V1, V2, R=R_smallF</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    枚举 δ in [-R,R] 上的同余类：</span></span><br><span class="line"><span class="string">      S1 = &#123; F ≡ δ1 * V1^&#123;-1&#125; (mod q) &#125;</span></span><br><span class="line"><span class="string">      S2 = &#123; F ≡ δ2 * V2^&#123;-1&#125; (mod q) &#125;</span></span><br><span class="line"><span class="string">    取 S1 ∩ S2，返回：</span></span><br><span class="line"><span class="string">      - match_cnt: 交集类数量</span></span><br><span class="line"><span class="string">      - min_abs_F: 交集中“最小 |F| 的代表”（F 取中心代表）</span></span><br><span class="line"><span class="string">      - min_max_delta: 令该 F 成立的最小 max(|δ1|,|δ2|)</span></span><br><span class="line"><span class="string">    随机公钥几乎无交集；结构公钥常有交集，且有小 |F|。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> V1 % q == <span class="number">0</span> <span class="keyword">or</span> V2 % q == <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 极端强信号：某边本身很小/为0时（随机几乎不出现）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    inv1 = <span class="built_in">int</span>(inverse_mod(V1 % q, q))</span><br><span class="line">    inv2 = <span class="built_in">int</span>(inverse_mod(V2 % q, q))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用字典记录类 -&gt; best |δ|</span></span><br><span class="line">    cls1 = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> d1 <span class="keyword">in</span> <span class="built_in">range</span>(-R, R+<span class="number">1</span>):</span><br><span class="line">        F1 = (d1 * inv1) % q</span><br><span class="line">        b1 = <span class="built_in">abs</span>(d1)</span><br><span class="line">        <span class="keyword">if</span> F1 <span class="keyword">not</span> <span class="keyword">in</span> cls1 <span class="keyword">or</span> b1 &lt; cls1[F1]:</span><br><span class="line">            cls1[F1] = b1</span><br><span class="line"></span><br><span class="line">    match_cnt, min_abs_F, min_max_delta = <span class="number">0</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> d2 <span class="keyword">in</span> <span class="built_in">range</span>(-R, R+<span class="number">1</span>):</span><br><span class="line">        F2 = (d2 * inv2) % q</span><br><span class="line">        <span class="keyword">if</span> F2 <span class="keyword">in</span> cls1:</span><br><span class="line">            match_cnt += <span class="number">1</span></span><br><span class="line">            <span class="comment"># 该同余类的最小 |F| 中心代表</span></span><br><span class="line">            F_cent = lift_centered_int(F2, q)</span><br><span class="line">            <span class="comment"># 该匹配的代价：max(|δ1|,|δ2|)</span></span><br><span class="line">            cost = <span class="built_in">max</span>(cls1[F2], <span class="built_in">abs</span>(d2))</span><br><span class="line">            <span class="keyword">if</span> (min_abs_F <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> (<span class="built_in">abs</span>(F_cent) &lt; <span class="built_in">abs</span>(min_abs_F)):</span><br><span class="line">                min_abs_F = F_cent</span><br><span class="line">            <span class="keyword">if</span> (min_max_delta <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> (cost &lt; min_max_delta):</span><br><span class="line">                min_max_delta = cost</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> min_abs_F <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 无交集</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, q, R+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> match_cnt, <span class="built_in">abs</span>(min_abs_F), min_max_delta</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============== 其他弱特征（保留但只在 t=-1） ==============</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">smallF_score</span>(<span class="params">V1, V2, R=R_smallF</span>):</span><br><span class="line">    <span class="comment"># 仍保留“扫 F”得到 best_s（辅助弱特征）</span></span><br><span class="line">    best = (<span class="number">10</span>**<span class="number">9</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">for</span> F <span class="keyword">in</span> <span class="built_in">range</span>(-R, R+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> F == <span class="number">0</span>: <span class="keyword">continue</span></span><br><span class="line">        Y1 = lift_centered_int(F*V1, q)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(Y1) &gt;= best[<span class="number">0</span>]: <span class="keyword">continue</span></span><br><span class="line">        Y2 = lift_centered_int(F*V2, q)</span><br><span class="line">        s = <span class="built_in">max</span>(<span class="built_in">abs</span>(Y1), <span class="built_in">abs</span>(Y2))</span><br><span class="line">        <span class="keyword">if</span> s &lt; best[<span class="number">0</span>]:</span><br><span class="line">            best = (s, <span class="built_in">abs</span>(F))</span><br><span class="line">            <span class="keyword">if</span> s == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> best</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ratio_consistency</span>(<span class="params">V1, V2, B=B_ratio</span>):</span><br><span class="line">    <span class="comment"># min |a*V1 - b*V2|_c, |a|,|b|&lt;=B</span></span><br><span class="line">    best = <span class="number">10</span>**<span class="number">9</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(-B, B+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(-B, B+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> a==<span class="number">0</span> <span class="keyword">and</span> b==<span class="number">0</span>: <span class="keyword">continue</span></span><br><span class="line">            r = lift_centered_int(a*V1 - b*V2, q)</span><br><span class="line">            ar = <span class="built_in">abs</span>(r)</span><br><span class="line">            <span class="keyword">if</span> ar &lt; best:</span><br><span class="line">                best = ar</span><br><span class="line">                <span class="keyword">if</span> ar == <span class="number">0</span>: <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> best</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">coeff_stats</span>(<span class="params">pk_list</span>):</span><br><span class="line">    cs = [lift_centered_int(c, q) <span class="keyword">for</span> c <span class="keyword">in</span> pk_list]</span><br><span class="line">    m = <span class="built_in">sum</span>(cs)/n</span><br><span class="line">    msq = <span class="built_in">sum</span>(c*c <span class="keyword">for</span> c <span class="keyword">in</span> cs)/n</span><br><span class="line">    <span class="comment"># 更细 bins 强化“靠近0”的比例特征</span></span><br><span class="line">    bins = [q//<span class="number">64</span>, q//<span class="number">32</span>, q//<span class="number">16</span>, q//<span class="number">8</span>]</span><br><span class="line">    fracs = [<span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> c <span class="keyword">in</span> cs <span class="keyword">if</span> <span class="built_in">abs</span>(c)&lt;=b)/n <span class="keyword">for</span> b <span class="keyword">in</span> bins]</span><br><span class="line">    linf = <span class="built_in">max</span>(<span class="built_in">abs</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> cs)</span><br><span class="line">    <span class="keyword">return</span> [m, msq] + fracs + [linf]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decision_feature_absF</span>(<span class="params">pk1_list, pk2_list, R=R_smallF</span>):</span><br><span class="line">    <span class="comment"># 兼容你原 decision：命中不同 |F| 的个数 &amp; 最小 |F|</span></span><br><span class="line">    V1 = eval_at_point(pk1_list, -<span class="number">1</span>)</span><br><span class="line">    V2 = eval_at_point(pk2_list, -<span class="number">1</span>)</span><br><span class="line">    hits = []</span><br><span class="line">    <span class="keyword">for</span> F <span class="keyword">in</span> <span class="built_in">range</span>(-R, R+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> F==<span class="number">0</span>: <span class="keyword">continue</span></span><br><span class="line">        Y1 = lift_centered_int(F*V1, q)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(Y1) &gt; R: <span class="keyword">continue</span></span><br><span class="line">        Y2 = lift_centered_int(F*V2, q)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(Y2) &gt; R: <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> (V1*Y2 - V2*Y1) % q == <span class="number">0</span>:</span><br><span class="line">            hits.append(<span class="built_in">abs</span>(F))</span><br><span class="line">    <span class="keyword">if</span> hits:</span><br><span class="line">        uniq = <span class="built_in">sorted</span>(<span class="built_in">set</span>(hits))</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">len</span>(uniq), <span class="built_in">min</span>(uniq)]</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============== 特征提取：只在 t=-1 汇总（强 + 若干弱） ==============</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_features</span>(<span class="params">pk1_list, pk2_list</span>):</span><br><span class="line">    feats = []</span><br><span class="line">    <span class="comment"># 核心同态点</span></span><br><span class="line">    V1 = eval_at_point(pk1_list, -<span class="number">1</span>)</span><br><span class="line">    V2 = eval_at_point(pk2_list, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 强特征：交集候选 F</span></span><br><span class="line">    match_cnt, min_absF_inter, min_max_delta = smallF_candidates_intersection(V1, V2, R_smallF)</span><br><span class="line">    feats += [match_cnt, min_absF_inter, min_max_delta]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 辅助弱特征</span></span><br><span class="line">    s, bestF = smallF_score(V1, V2, R_smallF)</span><br><span class="line">    feats += [s, (bestF <span class="keyword">if</span> bestF <span class="keyword">else</span> <span class="number">0</span>)]</span><br><span class="line">    feats += [ratio_consistency(V1, V2, B_ratio)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 原始点值（缩放）</span></span><br><span class="line">    feats += [V1/(q/<span class="number">2</span>), V2/(q/<span class="number">2</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 系数统计（更细 bins）</span></span><br><span class="line">    feats += coeff_stats(pk1_list)</span><br><span class="line">    feats += coeff_stats(pk2_list)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 你的 decision 两个特征</span></span><br><span class="line">    feats += decision_feature_absF(pk1_list, pk2_list, R_smallF)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> feats</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_features_plus</span>(<span class="params">pk1_list, pk2_list</span>):</span><br><span class="line">    <span class="keyword">return</span> extract_features(pk1_list, pk2_list)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============== 数据生成（coin=0 / coin=1） ==============</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GenNTRU_once</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        f  = [randint(-<span class="number">1</span>, <span class="number">1</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">        g1 = [randint(-<span class="number">1</span>, <span class="number">1</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">        g2 = [randint(-<span class="number">1</span>, <span class="number">1</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">        fx  = Q(f); g1x = Q(g1); g2x = Q(g2)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            h1 = (g1x / fx).lift()</span><br><span class="line">            h2 = (g2x / fx).lift()</span><br><span class="line">            <span class="keyword">return</span> [<span class="built_in">int</span>(c) % q <span class="keyword">for</span> c <span class="keyword">in</span> h1.<span class="built_in">list</span>()], [<span class="built_in">int</span>(c) % q <span class="keyword">for</span> c <span class="keyword">in</span> h2.<span class="built_in">list</span>()]</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RandPK_once</span>():</span><br><span class="line">    pk1 = Q.random_element().lift()</span><br><span class="line">    pk2 = Q.random_element().lift()</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>(c) % q <span class="keyword">for</span> c <span class="keyword">in</span> pk1.<span class="built_in">list</span>()], [<span class="built_in">int</span>(c) % q <span class="keyword">for</span> c <span class="keyword">in</span> pk2.<span class="built_in">list</span>()]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_dataset</span>(<span class="params">N0, N1, use_plus=<span class="literal">True</span>, verbose=<span class="literal">True</span></span>):</span><br><span class="line">    X, y = [], []</span><br><span class="line">    <span class="keyword">if</span> verbose: <span class="built_in">print</span>(<span class="string">f&quot;[+] Generating coin=0 (NTRU) : <span class="subst">&#123;N0&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(N0):</span><br><span class="line">        pk1, pk2 = GenNTRU_once()</span><br><span class="line">        X.append(extract_features_plus(pk1, pk2) <span class="keyword">if</span> use_plus <span class="keyword">else</span> extract_features(pk1, pk2))</span><br><span class="line">        y.append(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> verbose <span class="keyword">and</span> (i+<span class="number">1</span>) % <span class="number">500</span> == <span class="number">0</span>: <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>/<span class="subst">&#123;N0&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> verbose: <span class="built_in">print</span>(<span class="string">f&quot;[+] Generating coin=1 (random): <span class="subst">&#123;N1&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(N1):</span><br><span class="line">        pk1, pk2 = RandPK_once()</span><br><span class="line">        X.append(extract_features_plus(pk1, pk2) <span class="keyword">if</span> use_plus <span class="keyword">else</span> extract_features(pk1, pk2))</span><br><span class="line">        y.append(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> verbose <span class="keyword">and</span> (i+<span class="number">1</span>) % <span class="number">500</span> == <span class="number">0</span>: <span class="built_in">print</span>(<span class="string">f&quot;  - <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>/<span class="subst">&#123;N1&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> np.array(X, <span class="built_in">float</span>), np.array(y, <span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============== 模型（XGB→LGB→RF） ==============</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_xgb</span>(<span class="params">X_tr, y_tr, X_va, y_va</span>):</span><br><span class="line">    clf = xgb.XGBClassifier(</span><br><span class="line">        n_estimators=<span class="number">600</span>, max_depth=<span class="number">6</span>, learning_rate=<span class="number">0.06</span>,</span><br><span class="line">        subsample=<span class="number">0.9</span>, colsample_bytree=<span class="number">0.9</span>,</span><br><span class="line">        reg_lambda=<span class="number">1.0</span>, reg_alpha=<span class="number">0.0</span>,</span><br><span class="line">        objective=<span class="string">&#x27;binary:logistic&#x27;</span>, eval_metric=<span class="string">&#x27;auc&#x27;</span>,</span><br><span class="line">        random_state=SEED, n_jobs=<span class="number">4</span></span><br><span class="line">    )</span><br><span class="line">    clf.fit(X_tr, y_tr, eval_set=[(X_va, y_va)], verbose=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> clf</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_lgb</span>(<span class="params">X_tr, y_tr, X_va, y_va</span>):</span><br><span class="line">    clf = lgb.LGBMClassifier(</span><br><span class="line">        n_estimators=<span class="number">800</span>, num_leaves=<span class="number">63</span>, learning_rate=<span class="number">0.05</span>,</span><br><span class="line">        subsample=<span class="number">0.9</span>, colsample_bytree=<span class="number">0.9</span>,</span><br><span class="line">        reg_lambda=<span class="number">1.0</span>, random_state=SEED, n_jobs=<span class="number">4</span></span><br><span class="line">    )</span><br><span class="line">    clf.fit(X_tr, y_tr, eval_set=[(X_va, y_va)], eval_metric=<span class="string">&#x27;auc&#x27;</span>, verbose=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> clf</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_rf</span>(<span class="params">X_tr, y_tr</span>):</span><br><span class="line">    clf = RandomForestClassifier(</span><br><span class="line">        n_estimators=<span class="number">800</span>, max_depth=<span class="literal">None</span>,</span><br><span class="line">        min_samples_split=<span class="number">2</span>, min_samples_leaf=<span class="number">1</span>,</span><br><span class="line">        n_jobs=<span class="number">4</span>, random_state=SEED</span><br><span class="line">    )</span><br><span class="line">    clf.fit(X_tr, y_tr)</span><br><span class="line">    <span class="keyword">return</span> clf</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">kfold_train</span>(<span class="params">X, y, n_folds=<span class="number">5</span></span>):</span><br><span class="line">    skf = StratifiedKFold(n_splits=n_folds, shuffle=<span class="literal">True</span>, random_state=SEED)</span><br><span class="line">    models, oof = [], np.zeros(<span class="built_in">len</span>(y))</span><br><span class="line">    <span class="keyword">for</span> i,(tr,va) <span class="keyword">in</span> <span class="built_in">enumerate</span>(skf.split(X,y),<span class="number">1</span>):</span><br><span class="line">        X_tr, X_va, y_tr, y_va = X[tr], X[va], y[tr], y[va]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Fold <span class="subst">&#123;i&#125;</span>/<span class="subst">&#123;n_folds&#125;</span> (XGB priority)&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> XGB_OK: clf = train_xgb(X_tr, y_tr, X_va, y_va)</span><br><span class="line">        <span class="keyword">elif</span> LGB_OK: clf = train_lgb(X_tr, y_tr, X_va, y_va)</span><br><span class="line">        <span class="keyword">else</span>: clf = train_rf(X_tr, y_tr)</span><br><span class="line">        models.append(clf)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(clf,<span class="string">&quot;predict_proba&quot;</span>):</span><br><span class="line">            p = clf.predict_proba(X_va)[:,<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 保障分数</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(clf,<span class="string">&quot;decision_function&quot;</span>):</span><br><span class="line">                df = clf.decision_function(X_va)</span><br><span class="line">                p = (df-df.<span class="built_in">min</span>())/(df.<span class="built_in">max</span>()-df.<span class="built_in">min</span>()+<span class="number">1e-9</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                p = clf.predict(X_va).astype(<span class="built_in">float</span>)</span><br><span class="line">        oof[va] = p</span><br><span class="line">        auc = roc_auc_score(y_va, p)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    fold AUC = <span class="subst">&#123;auc:<span class="number">.4</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> models, oof</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============== 阈值自动调优（带 FP 约束） ==============</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tune_threshold_by_cost</span>(<span class="params">y_true, probs, alpha_fp=<span class="number">2.0</span>, target_fp_rate=<span class="literal">None</span></span>):</span><br><span class="line">    best_t, best_acc, best_cost, best_cm = <span class="number">0.5</span>, -<span class="number">1.0</span>, <span class="number">1e18</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> np.linspace(<span class="number">0.01</span>,<span class="number">0.99</span>,<span class="number">99</span>):</span><br><span class="line">        y_pred = (probs&gt;=t).astype(<span class="built_in">int</span>)</span><br><span class="line">        cm = confusion_matrix(y_true, y_pred, labels=[<span class="number">1</span>,<span class="number">0</span>])</span><br><span class="line">        TP,FN = cm[<span class="number">0</span>,<span class="number">0</span>], cm[<span class="number">0</span>,<span class="number">1</span>]</span><br><span class="line">        FP,TN = cm[<span class="number">1</span>,<span class="number">0</span>], cm[<span class="number">1</span>,<span class="number">1</span>]</span><br><span class="line">        fp_rate = FP / <span class="built_in">max</span>(FP+TN, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> (target_fp_rate <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>) <span class="keyword">and</span> (fp_rate&gt;target_fp_rate):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        acc  = accuracy_score(y_true, y_pred)</span><br><span class="line">        cost = alpha_fp*FP + FN</span><br><span class="line">        <span class="keyword">if</span> target_fp_rate <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> acc&gt;best_acc:</span><br><span class="line">                best_acc, best_t, best_cm = acc, t, cm</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> cost&lt;best_cost:</span><br><span class="line">                best_cost, best_t, best_cm = cost, t, cm</span><br><span class="line">    <span class="keyword">if</span> best_cm <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 回退：无阈值满足 FP 约束，按成本挑</span></span><br><span class="line">        <span class="keyword">for</span> t <span class="keyword">in</span> np.linspace(<span class="number">0.01</span>,<span class="number">0.99</span>,<span class="number">99</span>):</span><br><span class="line">            y_pred = (probs&gt;=t).astype(<span class="built_in">int</span>)</span><br><span class="line">            cm = confusion_matrix(y_true, y_pred, labels=[<span class="number">1</span>,<span class="number">0</span>])</span><br><span class="line">            TP,FN = cm[<span class="number">0</span>,<span class="number">0</span>], cm[<span class="number">0</span>,<span class="number">1</span>]</span><br><span class="line">            FP,TN = cm[<span class="number">1</span>,<span class="number">0</span>], cm[<span class="number">1</span>,<span class="number">1</span>]</span><br><span class="line">            acc  = accuracy_score(y_true, y_pred)</span><br><span class="line">            cost = alpha_fp*FP + FN</span><br><span class="line">            <span class="keyword">if</span> cost&lt;best_cost:</span><br><span class="line">                best_cost, best_t, best_cm = cost, t, cm</span><br><span class="line">                best_acc = acc</span><br><span class="line">    <span class="keyword">return</span> best_t, (best_acc, best_cm)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">auto_pick_alpha_threshold</span>(<span class="params">y_true, oof_probs,</span></span><br><span class="line"><span class="params">                              alpha_grid=ALPHA_GRID,</span></span><br><span class="line"><span class="params">                              target_total_err_rate=TARGET_TOTAL_ERR,</span></span><br><span class="line"><span class="params">                              fp_budget_ratio=FP_BUDGET</span>):</span><br><span class="line">    best = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> alpha_grid:</span><br><span class="line">        t, (acc, cm) = tune_threshold_by_cost(y_true, oof_probs, alpha_fp=a, target_fp_rate=fp_budget_ratio)</span><br><span class="line">        TP,FN = cm[<span class="number">0</span>,<span class="number">0</span>], cm[<span class="number">0</span>,<span class="number">1</span>]</span><br><span class="line">        FP,TN = cm[<span class="number">1</span>,<span class="number">0</span>], cm[<span class="number">1</span>,<span class="number">1</span>]</span><br><span class="line">        err_rate = (FP+FN) / <span class="built_in">max</span>(TP+FN+FP+TN,<span class="number">1</span>)</span><br><span class="line">        info = <span class="built_in">dict</span>(alpha=a, threshold=t, acc=acc, cm=cm, err_rate=err_rate)</span><br><span class="line">        <span class="keyword">if</span> (best <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> (err_rate&lt;best[<span class="string">&quot;err_rate&quot;</span>]):</span><br><span class="line">            best = info</span><br><span class="line">    <span class="keyword">return</span> best[<span class="string">&quot;alpha&quot;</span>], best[<span class="string">&quot;threshold&quot;</span>], best</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============== 保存/加载/推断 ==============</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_bundle</span>(<span class="params">models, threshold, path=<span class="string">&quot;ntru_coin_xgb_bundle.pkl&quot;</span></span>):</span><br><span class="line">    joblib.dump(&#123;<span class="string">&quot;models&quot;</span>:models, <span class="string">&quot;threshold&quot;</span>:threshold&#125;, path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Model bundle saved to <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_bundle</span>(<span class="params">path=<span class="string">&quot;ntru_coin_xgb_bundle.pkl&quot;</span></span>):</span><br><span class="line">    b = joblib.load(path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Model bundle loaded from <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> b[<span class="string">&quot;models&quot;</span>], b[<span class="string">&quot;threshold&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ensemble_predict_proba</span>(<span class="params">models, X</span>):</span><br><span class="line">    probs=[]</span><br><span class="line">    <span class="keyword">for</span> clf <span class="keyword">in</span> models:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(clf,<span class="string">&quot;predict_proba&quot;</span>):</span><br><span class="line">            p = clf.predict_proba(X)[:,<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(clf,<span class="string">&quot;decision_function&quot;</span>):</span><br><span class="line">                df = clf.decision_function(X)</span><br><span class="line">                p = (df-df.<span class="built_in">min</span>())/(df.<span class="built_in">max</span>()-df.<span class="built_in">min</span>()+<span class="number">1e-9</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                p = clf.predict(X).astype(<span class="built_in">float</span>)</span><br><span class="line">        probs.append(p)</span><br><span class="line">    <span class="keyword">return</span> np.mean(probs, axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">predict_coin</span>(<span class="params">models, threshold, pk1_list, pk2_list</span>):</span><br><span class="line">    feat = np.array(extract_features_plus(pk1_list, pk2_list), dtype=<span class="built_in">float</span>).reshape(<span class="number">1</span>,-<span class="number">1</span>)</span><br><span class="line">    p = ensemble_predict_proba(models, feat)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bool</span>(p&gt;=threshold), <span class="built_in">float</span>(p)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============== 主流程 ==============</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== NTRU coin 判别（强化版）===&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;lib: XGB=<span class="subst">&#123;XGB_OK&#125;</span>, LGB=<span class="subst">&#123;LGB_OK&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;n=<span class="subst">&#123;n&#125;</span>, q=<span class="subst">&#123;q&#125;</span>, TEST_XS=<span class="subst">&#123;TEST_XS&#125;</span>, R_smallF=<span class="subst">&#123;R_smallF&#125;</span>, B_ratio=<span class="subst">&#123;B_ratio&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;dataset: pos=<span class="subst">&#123;N_POS&#125;</span>, neg=<span class="subst">&#123;N_NEG&#125;</span>, test_size=<span class="subst">&#123;TEST_SIZE&#125;</span>, kfold=<span class="subst">&#123;N_FOLDS&#125;</span>&quot;</span>)</span><br><span class="line">    t0 = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1) 数据</span></span><br><span class="line">    X, y = build_dataset(N_POS, N_NEG, use_plus=<span class="literal">True</span>, verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2) 划分</span></span><br><span class="line">    X_tr, X_te, y_tr, y_te = train_test_split(X, y, test_size=TEST_SIZE, stratify=y, random_state=SEED)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3) K折训练 + OOF 概率</span></span><br><span class="line">    models, oof_probs = kfold_train(X_tr, y_tr, n_folds=N_FOLDS)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4) 自动挑 ALPHA + 阈值（优先满足 FP 预算）</span></span><br><span class="line">    best_alpha, threshold, info = auto_pick_alpha_threshold(</span><br><span class="line">        y_true=y_tr, oof_probs=oof_probs,</span><br><span class="line">        alpha_grid=ALPHA_GRID,</span><br><span class="line">        target_total_err_rate=TARGET_TOTAL_ERR,</span><br><span class="line">        fp_budget_ratio=FP_BUDGET</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[AUTO] pick ALPHA_FP=<span class="subst">&#123;best_alpha&#125;</span>, threshold=<span class="subst">&#123;threshold:<span class="number">.3</span>f&#125;</span>, err_rate=<span class="subst">&#123;info[<span class="string">&#x27;err_rate&#x27;</span>]:<span class="number">.4</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[AUTO] OOF CM [[TP FN],[FP TN]]:\n<span class="subst">&#123;info[<span class="string">&#x27;cm&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5) 独立测试集评估</span></span><br><span class="line">    proba_te = ensemble_predict_proba(models, X_te)</span><br><span class="line">    y_pred_te = (proba_te&gt;=threshold).astype(<span class="built_in">int</span>)</span><br><span class="line">    acc_te = accuracy_score(y_te, y_pred_te)</span><br><span class="line">    cm_te  = confusion_matrix(y_te, y_pred_te, labels=[<span class="number">1</span>,<span class="number">0</span>])</span><br><span class="line">    auc_te = roc_auc_score(y_te, proba_te)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[TEST] acc=<span class="subst">&#123;acc_te:<span class="number">.4</span>f&#125;</span>, auc=<span class="subst">&#123;auc_te:<span class="number">.4</span>f&#125;</span>\n[TEST] CM [[TP FN],[FP TN]]:\n<span class="subst">&#123;cm_te&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 6) 保存包</span></span><br><span class="line">    save_bundle(models, threshold, <span class="string">&quot;ntru_coin_xgb_bundle.pkl&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 7) 快速 sanity check</span></span><br><span class="line">    pk1_pos, pk2_pos = GenNTRU_once()</span><br><span class="line">    pk1_neg, pk2_neg = RandPK_once()</span><br><span class="line">    pp, sp = predict_coin(models, threshold, pk1_pos, pk2_pos)</span><br><span class="line">    pn, sn = predict_coin(models, threshold, pk1_neg, pk2_neg)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[Sanity] coin=0 -&gt; <span class="subst">&#123;pp&#125;</span> (p=<span class="subst">&#123;sp:<span class="number">.4</span>f&#125;</span>)&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[Sanity] coin=1 -&gt; <span class="subst">&#123;pn&#125;</span> (p=<span class="subst">&#123;sn:<span class="number">.4</span>f&#125;</span>)&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Done. Time: <span class="subst">&#123;time.time()-t0:<span class="number">.1</span>f&#125;</span>s&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>不过现在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span> 大了完全可以不用模型也可以区分，但是写都写了总不能不用吧，直接拿模型跑就好了，不过模型不是完全拟合的(成功率约99.98%)，所以跑了 4 次才拿到完全 100% 正确的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">coin</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span></span></span></span>，然后后面就是打随机数预测了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sage.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> joblib</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- 参数（与训练时一致）----</span></span><br><span class="line">q = <span class="number">1342261</span></span><br><span class="line">n = <span class="number">1031</span></span><br><span class="line">PR = PolynomialRing(Zmod(q), <span class="string">&quot;x&quot;</span>)</span><br><span class="line">x = PR.gens()[<span class="number">0</span>]</span><br><span class="line">Q = PR.quotient(x**n + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">R_smallF = <span class="number">160</span>     <span class="comment"># 与训练保持一致</span></span><br><span class="line">B_ratio   = <span class="number">60</span>     <span class="comment"># 与训练保持一致</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- 基础工具 ----</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lift_centered_int</span>(<span class="params">a, q</span>):</span><br><span class="line">    a = <span class="built_in">int</span>(a) % q</span><br><span class="line">    <span class="keyword">return</span> a <span class="keyword">if</span> a &lt;= q//<span class="number">2</span> <span class="keyword">else</span> a - q</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">eval_at_point</span>(<span class="params">pk_list, t</span>):</span><br><span class="line">    V, p = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> pk_list:</span><br><span class="line">        V += <span class="built_in">int</span>(c)*p</span><br><span class="line">        p = (p * t) % q</span><br><span class="line">    <span class="keyword">return</span> lift_centered_int(V, q)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- 强特征：小残差交集候选 F ----</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">smallF_candidates_intersection</span>(<span class="params">V1, V2, R=R_smallF</span>):</span><br><span class="line">    <span class="keyword">if</span> V1 % q == <span class="number">0</span> <span class="keyword">or</span> V2 % q == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    inv1 = <span class="built_in">int</span>(inverse_mod(V1 % q, q))</span><br><span class="line">    inv2 = <span class="built_in">int</span>(inverse_mod(V2 % q, q))</span><br><span class="line">    cls1 = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> d1 <span class="keyword">in</span> <span class="built_in">range</span>(-R, R+<span class="number">1</span>):</span><br><span class="line">        F1 = (d1 * inv1) % q</span><br><span class="line">        b1 = <span class="built_in">abs</span>(d1)</span><br><span class="line">        <span class="keyword">if</span> F1 <span class="keyword">not</span> <span class="keyword">in</span> cls1 <span class="keyword">or</span> b1 &lt; cls1[F1]:</span><br><span class="line">            cls1[F1] = b1</span><br><span class="line">    match_cnt, min_abs_F, min_max_delta = <span class="number">0</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> d2 <span class="keyword">in</span> <span class="built_in">range</span>(-R, R+<span class="number">1</span>):</span><br><span class="line">        F2 = (d2 * inv2) % q</span><br><span class="line">        <span class="keyword">if</span> F2 <span class="keyword">in</span> cls1:</span><br><span class="line">            match_cnt += <span class="number">1</span></span><br><span class="line">            F_cent = lift_centered_int(F2, q)</span><br><span class="line">            cost = <span class="built_in">max</span>(cls1[F2], <span class="built_in">abs</span>(d2))</span><br><span class="line">            <span class="keyword">if</span> (min_abs_F <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> (<span class="built_in">abs</span>(F_cent) &lt; <span class="built_in">abs</span>(min_abs_F)):</span><br><span class="line">                min_abs_F = F_cent</span><br><span class="line">            <span class="keyword">if</span> (min_max_delta <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">or</span> (cost &lt; min_max_delta):</span><br><span class="line">                min_max_delta = cost</span><br><span class="line">    <span class="keyword">if</span> min_abs_F <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, q, R+<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> match_cnt, <span class="built_in">abs</span>(min_abs_F), min_max_delta</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- 其他辅助弱特征（只在 x=-1）----</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">smallF_score</span>(<span class="params">V1, V2, R=R_smallF</span>):</span><br><span class="line">    best = (<span class="number">10</span>**<span class="number">9</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">for</span> F <span class="keyword">in</span> <span class="built_in">range</span>(-R, R+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> F == <span class="number">0</span>: <span class="keyword">continue</span></span><br><span class="line">        Y1 = lift_centered_int(F*V1, q)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(Y1) &gt;= best[<span class="number">0</span>]: <span class="keyword">continue</span></span><br><span class="line">        Y2 = lift_centered_int(F*V2, q)</span><br><span class="line">        s = <span class="built_in">max</span>(<span class="built_in">abs</span>(Y1), <span class="built_in">abs</span>(Y2))</span><br><span class="line">        <span class="keyword">if</span> s &lt; best[<span class="number">0</span>]:</span><br><span class="line">            best = (s, <span class="built_in">abs</span>(F))</span><br><span class="line">            <span class="keyword">if</span> s == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> best</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ratio_consistency</span>(<span class="params">V1, V2, B=B_ratio</span>):</span><br><span class="line">    best = <span class="number">10</span>**<span class="number">9</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> <span class="built_in">range</span>(-B, B+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(-B, B+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> a == <span class="number">0</span> <span class="keyword">and</span> b == <span class="number">0</span>: <span class="keyword">continue</span></span><br><span class="line">            r = lift_centered_int(a*V1 - b*V2, q)</span><br><span class="line">            ar = <span class="built_in">abs</span>(r)</span><br><span class="line">            <span class="keyword">if</span> ar &lt; best:</span><br><span class="line">                best = ar</span><br><span class="line">                <span class="keyword">if</span> ar == <span class="number">0</span>: <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> best</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">coeff_stats</span>(<span class="params">pk_list</span>):</span><br><span class="line">    cs = [lift_centered_int(c, q) <span class="keyword">for</span> c <span class="keyword">in</span> pk_list]</span><br><span class="line">    m = <span class="built_in">sum</span>(cs)/n</span><br><span class="line">    msq = <span class="built_in">sum</span>(c*c <span class="keyword">for</span> c <span class="keyword">in</span> cs)/n</span><br><span class="line">    bins = [q//<span class="number">64</span>, q//<span class="number">32</span>, q//<span class="number">16</span>, q//<span class="number">8</span>]</span><br><span class="line">    fracs = [<span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> c <span class="keyword">in</span> cs <span class="keyword">if</span> <span class="built_in">abs</span>(c) &lt;= b)/n <span class="keyword">for</span> b <span class="keyword">in</span> bins]</span><br><span class="line">    linf = <span class="built_in">max</span>(<span class="built_in">abs</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> cs)</span><br><span class="line">    <span class="keyword">return</span> [m, msq] + fracs + [linf]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decision_feature_absF</span>(<span class="params">pk1_list, pk2_list, R=R_smallF</span>):</span><br><span class="line">    V1 = eval_at_point(pk1_list, -<span class="number">1</span>)</span><br><span class="line">    V2 = eval_at_point(pk2_list, -<span class="number">1</span>)</span><br><span class="line">    hits = []</span><br><span class="line">    <span class="keyword">for</span> F <span class="keyword">in</span> <span class="built_in">range</span>(-R, R+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> F == <span class="number">0</span>: <span class="keyword">continue</span></span><br><span class="line">        Y1 = lift_centered_int(F*V1, q)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(Y1) &gt; R: <span class="keyword">continue</span></span><br><span class="line">        Y2 = lift_centered_int(F*V2, q)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(Y2) &gt; R: <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> (V1*Y2 - V2*Y1) % q == <span class="number">0</span>:</span><br><span class="line">            hits.append(<span class="built_in">abs</span>(F))</span><br><span class="line">    <span class="keyword">if</span> hits:</span><br><span class="line">        uniq = <span class="built_in">sorted</span>(<span class="built_in">set</span>(hits))</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">len</span>(uniq), <span class="built_in">min</span>(uniq)]</span><br><span class="line">    <span class="keyword">return</span> [<span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- 与训练一致的特征拼装（只用 x=-1）----</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_features_plus</span>(<span class="params">pk1_list, pk2_list</span>):</span><br><span class="line">    feats = []</span><br><span class="line">    V1 = eval_at_point(pk1_list, -<span class="number">1</span>)</span><br><span class="line">    V2 = eval_at_point(pk2_list, -<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 强特征：交集候选 F</span></span><br><span class="line">    match_cnt, min_absF_inter, min_max_delta = smallF_candidates_intersection(V1, V2, R_smallF)</span><br><span class="line">    feats += [match_cnt, min_absF_inter, min_max_delta]</span><br><span class="line">    <span class="comment"># 辅助弱特征</span></span><br><span class="line">    s, bestF = smallF_score(V1, V2, R_smallF)</span><br><span class="line">    feats += [s, (bestF <span class="keyword">if</span> bestF <span class="keyword">else</span> <span class="number">0</span>)]</span><br><span class="line">    feats += [ratio_consistency(V1, V2, B_ratio)]</span><br><span class="line">    <span class="comment"># 原始缩放</span></span><br><span class="line">    feats += [V1/(q/<span class="number">2</span>), V2/(q/<span class="number">2</span>)]</span><br><span class="line">    <span class="comment"># 系数统计</span></span><br><span class="line">    feats += coeff_stats(pk1_list)</span><br><span class="line">    feats += coeff_stats(pk2_list)</span><br><span class="line">    <span class="comment"># 你的 decision 两特征</span></span><br><span class="line">    feats += decision_feature_absF(pk1_list, pk2_list, R_smallF)</span><br><span class="line">    <span class="keyword">return</span> np.array(feats, dtype=<span class="built_in">float</span>).reshape(<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 兼容不同“特征版本”的提取器 =====</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">coeff_stats_bins2</span>(<span class="params">pk_list</span>):</span><br><span class="line">    <span class="comment"># 2 桶版本（与早期训练脚本一致）：返回 5 维/把</span></span><br><span class="line">    cs = [lift_centered_int(c, q) <span class="keyword">for</span> c <span class="keyword">in</span> pk_list]</span><br><span class="line">    m = <span class="built_in">sum</span>(cs)/n</span><br><span class="line">    msq = <span class="built_in">sum</span>(c*c <span class="keyword">for</span> c <span class="keyword">in</span> cs)/n</span><br><span class="line">    frac1 = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> c <span class="keyword">in</span> cs <span class="keyword">if</span> <span class="built_in">abs</span>(c) &lt;= q//<span class="number">8</span>)/n</span><br><span class="line">    frac2 = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> c <span class="keyword">in</span> cs <span class="keyword">if</span> <span class="built_in">abs</span>(c) &lt;= q//<span class="number">16</span>)/n</span><br><span class="line">    linf = <span class="built_in">max</span>(<span class="built_in">abs</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> cs)</span><br><span class="line">    <span class="keyword">return</span> [m, msq, frac1, frac2, linf]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_features_v24</span>(<span class="params">pk1_list, pk2_list</span>):</span><br><span class="line">    <span class="comment"># 24维（你“强化版”训练脚本用的）：4 桶 coeff_stats + 仅 x=-1</span></span><br><span class="line">    feats = []</span><br><span class="line">    V1 = eval_at_point(pk1_list, -<span class="number">1</span>)</span><br><span class="line">    V2 = eval_at_point(pk2_list, -<span class="number">1</span>)</span><br><span class="line">    mc, minF, minDelta = smallF_candidates_intersection(V1, V2, R_smallF)   <span class="comment"># 3</span></span><br><span class="line">    s, bestF = smallF_score(V1, V2, R_smallF)                               <span class="comment"># +2 -&gt; 5</span></span><br><span class="line">    feats += [mc, minF, minDelta, s, (bestF <span class="keyword">if</span> bestF <span class="keyword">else</span> <span class="number">0</span>)]</span><br><span class="line">    feats += [ratio_consistency(V1, V2, B_ratio)]                            <span class="comment"># +1 -&gt; 6</span></span><br><span class="line">    feats += [V1/(q/<span class="number">2</span>), V2/(q/<span class="number">2</span>)]                                           <span class="comment"># +2 -&gt; 8</span></span><br><span class="line">    feats += coeff_stats(pk1_list) + coeff_stats(pk2_list)                   <span class="comment"># +14 -&gt; 22 (因你当前 coeff_stats 是4桶：7/把)</span></span><br><span class="line">    feats += decision_feature_absF(pk1_list, pk2_list, R_smallF)             <span class="comment"># +2 -&gt; 24</span></span><br><span class="line">    <span class="keyword">return</span> np.array(feats, <span class="built_in">float</span>).reshape(<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_features_v22</span>(<span class="params">pk1_list, pk2_list</span>):</span><br><span class="line">    <span class="comment"># 22维（你现在的 .pkl 很可能是这个版本训练的）：</span></span><br><span class="line">    <span class="comment">#   2 桶 coeff_stats（5/把*2=10），仅 x=-1 的强/弱特征（共 3+2+1+2=8），</span></span><br><span class="line">    <span class="comment">#   再加上 x=+1 的原始两维（2）和 decision 两维（2） =&gt; 总 22</span></span><br><span class="line">    feats = []</span><br><span class="line">    V1m1 = eval_at_point(pk1_list, -<span class="number">1</span>)</span><br><span class="line">    V2m1 = eval_at_point(pk2_list, -<span class="number">1</span>)</span><br><span class="line">    mc, minF, minDelta = smallF_candidates_intersection(V1m1, V2m1, R_smallF)   <span class="comment"># 3</span></span><br><span class="line">    s, bestF = smallF_score(V1m1, V2m1, R_smallF)                               <span class="comment"># +2 -&gt; 5</span></span><br><span class="line">    feats += [mc, minF, minDelta, s, (bestF <span class="keyword">if</span> bestF <span class="keyword">else</span> <span class="number">0</span>)]</span><br><span class="line">    feats += [ratio_consistency(V1m1, V2m1, B_ratio)]                            <span class="comment"># +1 -&gt; 6</span></span><br><span class="line">    feats += [V1m1/(q/<span class="number">2</span>), V2m1/(q/<span class="number">2</span>)]                                           <span class="comment"># +2 -&gt; 8</span></span><br><span class="line">    feats += coeff_stats_bins2(pk1_list) + coeff_stats_bins2(pk2_list)           <span class="comment"># +10 -&gt; 18</span></span><br><span class="line">    feats += decision_feature_absF(pk1_list, pk2_list, R_smallF)                 <span class="comment"># +2 -&gt; 20</span></span><br><span class="line">    V1p1 = eval_at_point(pk1_list, <span class="number">1</span>)                                           <span class="comment"># +2 -&gt; 22</span></span><br><span class="line">    V2p1 = eval_at_point(pk2_list, <span class="number">1</span>)</span><br><span class="line">    feats += [V1p1/(q/<span class="number">2</span>), V2p1/(q/<span class="number">2</span>)]</span><br><span class="line">    <span class="keyword">return</span> np.array(feats, <span class="built_in">float</span>).reshape(<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_features_v20</span>(<span class="params">pk1_list, pk2_list</span>):</span><br><span class="line">    <span class="comment"># 20维（v22 去掉 x=+1 的两维）</span></span><br><span class="line">    feats = []</span><br><span class="line">    V1m1 = eval_at_point(pk1_list, -<span class="number">1</span>)</span><br><span class="line">    V2m1 = eval_at_point(pk2_list, -<span class="number">1</span>)</span><br><span class="line">    mc, minF, minDelta = smallF_candidates_intersection(V1m1, V2m1, R_smallF)</span><br><span class="line">    s, bestF = smallF_score(V1m1, V2m1, R_smallF)</span><br><span class="line">    feats += [mc, minF, minDelta, s, (bestF <span class="keyword">if</span> bestF <span class="keyword">else</span> <span class="number">0</span>)]</span><br><span class="line">    feats += [ratio_consistency(V1m1, V2m1, B_ratio)]</span><br><span class="line">    feats += [V1m1/(q/<span class="number">2</span>), V2m1/(q/<span class="number">2</span>)]</span><br><span class="line">    feats += coeff_stats_bins2(pk1_list) + coeff_stats_bins2(pk2_list)</span><br><span class="line">    feats += decision_feature_absF(pk1_list, pk2_list, R_smallF)</span><br><span class="line">    <span class="keyword">return</span> np.array(feats, <span class="built_in">float</span>).reshape(<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expected_dim_from_models</span>(<span class="params">models</span>):</span><br><span class="line">    <span class="comment"># 对 xgboost/sklearn 模型一般有 n_features_in_</span></span><br><span class="line">    <span class="keyword">for</span> clf <span class="keyword">in</span> models:</span><br><span class="line">        dim = <span class="built_in">getattr</span>(clf, <span class="string">&quot;n_features_in_&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> dim <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">int</span>(dim)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span>  <span class="comment"># 某些场景可能拿不到，下面会用试跑兜底</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 用“自适配提取器”重写 predict_coin（或直接覆盖你原来的）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- 集成概率 &amp; 预测 ----</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ensemble_predict_proba</span>(<span class="params">models, X</span>):</span><br><span class="line">    probs=[]</span><br><span class="line">    <span class="keyword">for</span> clf <span class="keyword">in</span> models:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(clf,<span class="string">&quot;predict_proba&quot;</span>):</span><br><span class="line">            p = clf.predict_proba(X)[:,<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(clf,<span class="string">&quot;decision_function&quot;</span>):</span><br><span class="line">                df = clf.decision_function(X)</span><br><span class="line">                p = (df-df.<span class="built_in">min</span>())/(df.<span class="built_in">max</span>()-df.<span class="built_in">min</span>()+<span class="number">1e-9</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                p = clf.predict(X).astype(<span class="built_in">float</span>)</span><br><span class="line">        probs.append(p)</span><br><span class="line">    <span class="keyword">return</span> np.mean(probs, axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">predict_coin</span>(<span class="params">models, threshold, pk1_list, pk2_list</span>):</span><br><span class="line">    exp = expected_dim_from_models(models)</span><br><span class="line">    <span class="comment"># 首选：按模型给的期望维度走</span></span><br><span class="line">    <span class="keyword">if</span> exp == <span class="number">24</span>:</span><br><span class="line">        X = extract_features_v24(pk1_list, pk2_list)</span><br><span class="line">        p = ensemble_predict_proba(models, X)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(p &gt;= threshold), <span class="built_in">float</span>(p)</span><br><span class="line">    <span class="keyword">if</span> exp == <span class="number">22</span>:</span><br><span class="line">        X = extract_features_v22(pk1_list, pk2_list)</span><br><span class="line">        p = ensemble_predict_proba(models, X)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(p &gt;= threshold), <span class="built_in">float</span>(p)</span><br><span class="line">    <span class="keyword">if</span> exp == <span class="number">20</span>:</span><br><span class="line">        X = extract_features_v20(pk1_list, pk2_list)</span><br><span class="line">        p = ensemble_predict_proba(models, X)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(p &gt;= threshold), <span class="built_in">float</span>(p)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 兜底：模型没暴露 exp 特征数，就按 v24→v22→v20 依次试谁能跑</span></span><br><span class="line">    <span class="keyword">for</span> builder <span class="keyword">in</span> (extract_features_v24, extract_features_v22, extract_features_v20):</span><br><span class="line">        X = builder(pk1_list, pk2_list)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            p = ensemble_predict_proba(models, X)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">bool</span>(p &gt;= threshold), <span class="built_in">float</span>(p)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">&quot;无法匹配特征维度：请确认训练与预测用的是同一版特征工程。&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- 加载模型包 ----</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_bundle</span>(<span class="params">path=<span class="string">&quot;ntru_coin_xgb_bundle.pkl&quot;</span></span>):</span><br><span class="line">    b = joblib.load(path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] 模型包已加载: <span class="subst">&#123;path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> b[<span class="string">&quot;models&quot;</span>], b[<span class="string">&quot;threshold&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ================== 示例用法 ==================</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">sample</span>(<span class="params">rand</span>):</span><br><span class="line">        <span class="keyword">return</span> (rand.getrandbits(<span class="number">1</span>) - rand.getrandbits(<span class="number">1</span>)) * (rand.getrandbits(<span class="number">1</span>) * rand.getrandbits(<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">from</span> sage.misc <span class="keyword">import</span> prandom</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    models, threshold = load_bundle(<span class="string">&quot;ntru_coin_xgb_bundle.pkl&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GenNTRU_once</span>():</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            f  = [sample(prandom) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">            g1 = [sample(prandom) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">            g2 = [sample(prandom) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">            fx  = Q(f); g1x = Q(g1); g2x = Q(g2)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                h1 = (g1x / fx).lift()</span><br><span class="line">                h2 = (g2x / fx).lift()</span><br><span class="line">                <span class="keyword">return</span> [<span class="built_in">int</span>(c) % q <span class="keyword">for</span> c <span class="keyword">in</span> h1.<span class="built_in">list</span>()], [<span class="built_in">int</span>(c) % q <span class="keyword">for</span> c <span class="keyword">in</span> h2.<span class="built_in">list</span>()]</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">RandPK_once</span>():</span><br><span class="line">        pk1 = Q.random_element().lift()</span><br><span class="line">        pk2 = Q.random_element().lift()</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">int</span>(c) % q <span class="keyword">for</span> c <span class="keyword">in</span> pk1.<span class="built_in">list</span>()], [<span class="built_in">int</span>(c) % q <span class="keyword">for</span> c <span class="keyword">in</span> pk2.<span class="built_in">list</span>()]</span><br><span class="line"></span><br><span class="line">    T = []</span><br><span class="line">    S = []</span><br><span class="line">    <span class="comment"># pk1_pos, pk2_pos = GenNTRU_once()</span></span><br><span class="line">    <span class="comment"># pred_pos, p_pos = predict_coin(models, threshold, pk1_pos, pk2_pos)</span></span><br><span class="line">    <span class="comment"># pk1_neg, pk2_neg = RandPK_once()</span></span><br><span class="line">    <span class="comment"># pred_neg, p_neg = predict_coin(models, threshold, pk1_neg, pk2_neg)</span></span><br><span class="line">    <span class="comment"># print(f&quot;[Sanity] coin=0 -&gt; &#123;pred_pos&#125;, p=&#123;p_pos:.4f&#125;&quot;)</span></span><br><span class="line">    <span class="comment"># print(f&quot;[Sanity] coin=1 -&gt; &#123;pred_neg&#125;, p=&#123;p_neg:.4f&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> trange(<span class="number">10000</span>):</span><br><span class="line">            coin = randint(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">            T += [coin]</span><br><span class="line">            <span class="keyword">if</span> coin:</span><br><span class="line">                pk1_pos, pk2_pos = GenNTRU_once()</span><br><span class="line">                pred_pos, pp = predict_coin(models, threshold, pk1_pos, pk2_pos)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                pk1_neg, pk2_neg = RandPK_once()</span><br><span class="line">                pred_neg, pp = predict_coin(models, threshold, pk1_neg, pk2_neg)</span><br><span class="line">                </span><br><span class="line">            <span class="comment"># print(f&quot;[Sanity] coin=0 -&gt; &#123;pred_pos&#125;, p=&#123;p_pos:.4f&#125;&quot;)</span></span><br><span class="line">            <span class="comment"># print(f&quot;[Sanity] coin=1 -&gt; &#123;pred_neg&#125;, p=&#123;p_neg:.4f&#125;&quot;)</span></span><br><span class="line">            <span class="keyword">if</span> pp &gt; <span class="number">.65</span>:</span><br><span class="line">                S += [<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">else</span>: S +=[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        cor = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i, j <span class="keyword">in</span> <span class="built_in">zip</span>(T, S):</span><br><span class="line">            <span class="keyword">if</span> i == j:</span><br><span class="line">                cor += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(cor)</span><br><span class="line">        <span class="built_in">print</span>(cor / <span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">from</span> pwn <span class="keyword">import</span> process, remote</span><br><span class="line"></span><br><span class="line">        <span class="comment"># r = process([&#x27;python&#x27;, &#x27;chal.py&#x27;])</span></span><br><span class="line">        r = remote(<span class="string">&#x27;39.106.47.249&#x27;</span>, <span class="number">36893</span>)</span><br><span class="line"></span><br><span class="line">        coins = []</span><br><span class="line">        <span class="comment"># r.interactive()</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> trange(<span class="number">20258</span>):</span><br><span class="line">            r.sendlineafter(<span class="string">b&#x27;c :&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">            pk12 = r.recvline().split(<span class="string">b&#x27;: &#x27;</span>)[-<span class="number">1</span>].decode().strip()</span><br><span class="line">            pk = pk12.split(<span class="string">&#x27;] [&#x27;</span>)</span><br><span class="line">            pk1 = <span class="built_in">eval</span>(pk[<span class="number">0</span>] + <span class="string">&#x27;]&#x27;</span>)</span><br><span class="line">            pk2 = <span class="built_in">eval</span>(<span class="string">&#x27;[&#x27;</span> + pk[<span class="number">1</span>])</span><br><span class="line">            pred_pos, pp = predict_coin(models, threshold, pk1, pk2)</span><br><span class="line">            <span class="keyword">if</span> pp &gt; <span class="number">.65</span>:</span><br><span class="line">                coins += [<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>: coins +=[<span class="number">1</span>]</span><br><span class="line">        r.sendlineafter(<span class="string">b&#x27;c :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">        enc = <span class="built_in">eval</span>(r.recvline().split(<span class="string">b&#x27;: &#x27;</span>)[-<span class="number">1</span>].decode().strip())</span><br><span class="line">        <span class="built_in">print</span>(enc)</span><br><span class="line">        <span class="built_in">open</span>(<span class="string">&#x27;output.py&#x27;</span>, <span class="string">&#x27;w&#x27;</span>).write(<span class="string">f&#x27;coins = <span class="subst">&#123;coins&#125;</span>&#x27;</span> + <span class="string">&#x27;\n&#x27;</span> + <span class="string">f&#x27;enc = <span class="subst">&#123;enc&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">from</span> gf2bv <span class="keyword">import</span> LinearSystem</span><br><span class="line">        <span class="keyword">from</span> gf2bv.crypto.mt <span class="keyword">import</span> MT19937</span><br><span class="line">        <span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">        <span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA256</span><br><span class="line">        <span class="keyword">from</span> output <span class="keyword">import</span> coins, enc</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">mt19937</span>(<span class="params">bs, out</span>):</span><br><span class="line">            lin = LinearSystem([<span class="number">32</span>] * <span class="number">624</span>)</span><br><span class="line">            mt = lin.gens()</span><br><span class="line"></span><br><span class="line">            rng = MT19937(mt)</span><br><span class="line">            zeros = []</span><br><span class="line">            <span class="keyword">for</span> o <span class="keyword">in</span> out:</span><br><span class="line">                zeros.append(rng.getrandbits(bs) ^ <span class="built_in">int</span>(o))</span><br><span class="line">            zeros.append(mt[<span class="number">0</span>] ^ <span class="built_in">int</span>(<span class="number">0x80000000</span>))</span><br><span class="line">            sols = lin.solve_all(zeros)</span><br><span class="line">            <span class="keyword">for</span> sol <span class="keyword">in</span> sols:</span><br><span class="line">                rng = MT19937(sol)</span><br><span class="line">                pyrand = rng.to_python_random()</span><br><span class="line">                <span class="keyword">yield</span> pyrand</span><br><span class="line"></span><br><span class="line">        coins = coins[:<span class="number">20000</span>] <span class="comment"># It seems unnecessary</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;go&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> rng <span class="keyword">in</span> mt19937(<span class="number">1</span>, coins):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;end&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20258</span>):</span><br><span class="line">                rng.getrandbits(<span class="number">1</span>)</span><br><span class="line">            key = <span class="built_in">str</span>(rng.getrandbits(<span class="number">256</span>)).encode()</span><br><span class="line">            SHA = SHA256.new()</span><br><span class="line">            SHA.update(key)</span><br><span class="line">            KEY = SHA.digest()</span><br><span class="line">            cipher = AES.new(KEY, AES.MODE_ECB)</span><br><span class="line">            <span class="built_in">print</span>(cipher.decrypt(enc))</span><br></pre></td></tr></table></figure>
<h2 id="theorezhnp"><a class="markdownIt-Anchor" href="#theorezhnp"></a> *theorezhnp</h2>
<p>题目</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> ecdsa <span class="keyword">import</span> NIST521p</span><br><span class="line"><span class="keyword">from</span> ecdsa.ecdsa <span class="keyword">import</span> Public_key</span><br><span class="line"><span class="keyword">from</span> ecdsa.ellipticcurve <span class="keyword">import</span> Point </span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randrange</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> stdin</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> seed_token, flag</span><br><span class="line"><span class="keyword">import</span> time, signal</span><br><span class="line"></span><br><span class="line">signal.alarm(<span class="number">600</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">l</span>):</span><br><span class="line">    <span class="keyword">return</span> stdin.read(l + <span class="number">1</span>).strip()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pr</span>(<span class="params">msg, key=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> key:</span><br><span class="line">        <span class="built_in">print</span>(msg)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        key = sha256(<span class="built_in">str</span>(key).encode()).digest()</span><br><span class="line">        <span class="built_in">print</span>(AES.new(key, AES.MODE_ECB).encrypt(msg.encode()).<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inp</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> Point(E, <span class="built_in">int</span>(read(<span class="number">131</span>), <span class="number">16</span>), <span class="built_in">int</span>(read(<span class="number">131</span>), <span class="number">16</span>))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DH</span>(<span class="params">priv, pub</span>):</span><br><span class="line">    shared = priv * pub</span><br><span class="line">    <span class="keyword">return</span> shared.x()</span><br><span class="line"></span><br><span class="line">token = <span class="built_in">input</span>(<span class="string">&quot;Please input your team token: &quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_token</span>(<span class="params">seed, token</span>):  </span><br><span class="line">    <span class="keyword">return</span> sha256((seed + <span class="string">&#x27;&amp;&#x27;</span> + sha1(token[::-<span class="number">1</span>].encode()).hexdigest()[:<span class="number">10</span>]).encode()).hexdigest()</span><br><span class="line"></span><br><span class="line">to_encrypted_token = generate_token(seed_token, token)</span><br><span class="line"></span><br><span class="line">E = NIST521p.curve</span><br><span class="line">G = NIST521p.generator  </span><br><span class="line">m = <span class="number">235</span></span><br><span class="line">n = G.order() </span><br><span class="line">Alice_sk = randrange(n)</span><br><span class="line">Alice_pk = Public_key(G, Alice_sk * G).point</span><br><span class="line">pr(<span class="string">f&#x27;Hi, Bob! Here is my public key: <span class="subst">&#123;Alice_pk.x() :x&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">Bob_sk = randrange(n)</span><br><span class="line">Bob_pk = Public_key(G, Bob_sk * G).point</span><br><span class="line">pr(<span class="string">f&#x27;Hi, Alice! Here is my public key: <span class="subst">&#123;Bob_pk.x() :x&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shared_AB = DH(Alice_sk, Bob_pk)</span><br><span class="line">shared_BA = DH(Bob_sk, Alice_pk)</span><br><span class="line"><span class="keyword">assert</span> shared_AB == shared_BA</span><br><span class="line"></span><br><span class="line">pr(<span class="string">&#x27;Now, it is your turn:&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">19</span>):</span><br><span class="line">    Mallory_pk = inp()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> Mallory_pk:</span><br><span class="line">        pr(<span class="string">&#x27;Invalid pk!&#x27;</span>)</span><br><span class="line">        exit()</span><br><span class="line">    shared_AC = DH(Alice_sk, Mallory_pk)</span><br><span class="line">    pr(<span class="string">f&#x27;Leak: <span class="subst">&#123;shared_AC &gt;&gt; m :x&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pr(to_encrypted_token, shared_AB) </span><br><span class="line"></span><br><span class="line">pr(<span class="string">&quot;Give me your token:&quot;</span>)</span><br><span class="line">Guess_Token = <span class="built_in">input</span>() </span><br><span class="line"><span class="keyword">if</span> Guess_Token == to_encrypted_token:</span><br><span class="line">    pr(<span class="string">&quot;Win for flag: &quot;</span> + flag)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    pr(<span class="string">&quot;You Lose&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>不会</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ctf/" rel="tag"><i class="fa fa-tag"></i> ctf</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/10/10/2025-10-%E5%88%87%E9%A2%98/" rel="prev" title="2025.10-切题">
                  <i class="fa fa-angle-left"></i> 2025.10-切题
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/12/22/2025-12-%E5%88%87%E9%A2%98/" rel="next" title="2025-12-切题">
                  2025-12-切题 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">languag3</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous">
  <script class="next-config" data-name="katex" type="application/json">{"copy_tex_js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js","integrity":"sha256-Us54+rSGDSTvIhKKUs4kygE2ipA0RXpWWh0/zLqw3bs="}}</script>
  <script src="/js/third-party/math/katex.js"></script>



</body>
</html>
